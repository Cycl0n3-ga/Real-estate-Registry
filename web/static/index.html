<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>è‰¯å¯Œå±…åœ°ç”¢</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.1/dist/MarkerCluster.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.1/dist/MarkerCluster.Default.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.1/dist/leaflet.markercluster.js"></script>
<style>
/* ========== å…¨åŸŸ ========== */
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --primary:#1a73e8;--primary-dark:#1558b0;--bg:#f5f7fa;
  --card:#fff;--text:#222;--text2:#555;--border:#ddd;
  --green:#34a853;--red:#ea4335;--orange:#f9ab00;
  --sidebar-w:440px;--header-h:54px;
}
html,body{height:100%;font-family:'Segoe UI','Microsoft JhengHei',sans-serif;background:var(--bg);color:var(--text)}

/* ========== HEADER ========== */
.header{
  position:fixed;top:0;left:0;right:0;height:var(--header-h);
  background:var(--primary);color:#fff;display:flex;align-items:center;
  padding:0 16px;z-index:1100;gap:12px;
}
.header .logo{font-size:20px;font-weight:700;white-space:nowrap}
.header .unit-toggle{
  margin-left:auto;display:flex;gap:4px;background:rgba(255,255,255,.15);
  border-radius:20px;padding:2px;
}
.header .unit-toggle button{
  border:none;background:transparent;color:rgba(255,255,255,.7);
  padding:5px 14px;border-radius:18px;cursor:pointer;font-size:13px;
  transition:.2s;
}
.header .unit-toggle button.active{background:#fff;color:var(--primary);font-weight:600}
.hamburger{display:none;background:none;border:none;color:#fff;font-size:24px;cursor:pointer}

/* ========== SIDEBAR ========== */
.sidebar{
  position:fixed;top:var(--header-h);left:0;bottom:0;
  width:var(--sidebar-w);background:var(--card);
  border-right:1px solid var(--border);z-index:1050;
  display:flex;flex-direction:column;overflow:hidden;
  transition:transform .3s;
}
.sidebar.collapsed{transform:translateX(-100%)}

/* Search bar */
.search-box{padding:12px;border-bottom:1px solid var(--border);background:#fafbfc}
.search-row{display:flex;gap:6px}
.search-row input{
  flex:1;padding:9px 12px;border:1px solid var(--border);border-radius:8px;
  font-size:14px;outline:none;
}
.search-row input:focus{border-color:var(--primary)}
.search-row button{
  padding:9px 18px;background:var(--primary);color:#fff;border:none;
  border-radius:8px;cursor:pointer;font-size:14px;font-weight:600;
  white-space:nowrap;transition:.2s;
}
.search-row button:hover{background:var(--primary-dark)}

/* Filters */
.filter-toggle{
  display:flex;align-items:center;gap:6px;margin-top:8px;
  font-size:12px;color:var(--primary);cursor:pointer;user-select:none;
}
.filter-toggle:hover{text-decoration:underline}
.filter-panel{
  display:none;margin-top:8px;gap:6px;
  grid-template-columns:1fr 1fr;
}
.filter-panel.show{display:grid}
.filter-panel label{font-size:11px;color:var(--text2);margin-bottom:2px;display:block}
.filter-panel input,.filter-panel select{
  width:100%;padding:5px 8px;border:1px solid var(--border);border-radius:6px;
  font-size:12px;
}
.filter-panel .full-row{grid-column:1/-1}
.filter-btns{
  grid-column:1/-1;display:flex;gap:6px;margin-top:4px;
}
.filter-btns button{
  flex:1;padding:6px;border-radius:6px;border:1px solid var(--border);
  font-size:12px;cursor:pointer;transition:.2s;
}
.filter-btns .btn-apply{background:var(--primary);color:#fff;border-color:var(--primary)}
.filter-btns .btn-clear{background:#fff;color:var(--text2)}

/* Sort bar */
.sort-bar{
  display:flex;gap:2px;padding:8px 12px;border-bottom:1px solid var(--border);
  background:#fafbfc;flex-wrap:wrap;align-items:center;
}
.sort-bar button{
  padding:4px 10px;font-size:11px;border:1px solid var(--border);
  border-radius:14px;background:#fff;cursor:pointer;transition:.2s;
  color:var(--text2);
}
.sort-bar button.active{background:var(--primary);color:#fff;border-color:var(--primary)}
.sort-bar .limit-select{
  margin-left:auto;padding:4px 8px;font-size:11px;
  border:1px solid var(--border);border-radius:14px;
  background:#fff;color:var(--text2);cursor:pointer;
  outline:none;
}

/* Summary */
.summary-bar{
  padding:10px 12px;border-bottom:1px solid var(--border);background:#f0f6ff;
  font-size:12px;color:var(--text2);display:none;line-height:1.8;
}
.summary-bar .val{font-weight:700;color:var(--text)}

/* Results list */
.results{flex:1;overflow-y:auto;padding:0}
.results .empty{padding:40px 20px;text-align:center;color:var(--text2);font-size:14px}
.results .loading{padding:40px 20px;text-align:center;color:var(--text2)}

/* â”€â”€ å»ºæ¡ˆç¾¤çµ„ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.community-group{
  border-bottom:2px solid #e0e0e0;
}
.community-header{
  display:flex;align-items:center;gap:8px;padding:10px 12px;
  background:linear-gradient(135deg,#e8f5e9,#f1f8e9);
  cursor:pointer;user-select:none;
  border-bottom:1px solid #c8e6c9;
  transition:background .15s;
  position:sticky;top:0;z-index:10;
}
.community-header:hover{background:linear-gradient(135deg,#c8e6c9,#e8f5e9)}
.community-header .ch-arrow{
  font-size:12px;color:var(--text2);transition:transform .2s;min-width:16px;text-align:center;
}
.community-header .ch-arrow.open{transform:rotate(90deg)}
.community-header .ch-name{
  font-weight:700;font-size:14px;color:#2e7d32;flex:1;
}
.community-header .ch-count{
  background:#2e7d32;color:#fff;padding:2px 8px;border-radius:10px;
  font-size:11px;font-weight:600;
}
.community-stats{
  display:grid;grid-template-columns:repeat(5,1fr);
  gap:4px 8px;padding:8px 12px;background:#f6fbf6;
  border-bottom:1px solid #e0e0e0;font-size:11px;
}
.community-stats .cs-item{
  display:flex;flex-direction:column;align-items:center;
}
.community-stats .cs-label{color:var(--text2);font-size:10px}
.community-stats .cs-value{font-weight:700;color:var(--text);font-size:12px}
.community-items{overflow:hidden;transition:max-height .3s ease;}
.community-items.collapsed{max-height:0!important;overflow:hidden}

/* â”€â”€ äº¤æ˜“å¡ç‰‡ï¼ˆæ”¹å–„ç‰ˆ v2ï¼‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.tx-card{
  padding:10px 12px 10px 15px;border-bottom:1px solid #ebebeb;cursor:pointer;
  transition:background .15s;display:grid;
  grid-template-columns:1fr auto;grid-template-rows:auto auto auto;
  gap:2px 12px;align-items:start;
  border-left:3px solid transparent;
  position:relative;
}
.tx-card:hover{background:#f4f8ff;border-left-color:#90b8f8;}
.tx-card.active{background:#e3f0ff;border-left:3px solid var(--primary);}
.tx-card.price-high{border-left-color:#ea4335;}
.tx-card.price-mid{border-left-color:#f9ab00;}
.tx-card.price-low{border-left-color:#34a853;}

.tx-addr{
  grid-column:1;font-size:13px;font-weight:700;color:var(--text);
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
  margin-bottom:1px;
}
.tx-community-tag{
  display:inline-flex;align-items:center;padding:1px 7px;background:#e8f5e9;color:#2e7d32;
  border-radius:10px;font-size:10px;font-weight:600;white-space:nowrap;
  max-width:140px;overflow:hidden;text-overflow:ellipsis;flex-shrink:0;
  border:1px solid #c8e6c9;
}
.tx-community-row{
  grid-column:1/-1;margin-bottom:2px;
}
.tx-detail-row{
  grid-column:1;display:flex;flex-wrap:wrap;gap:3px 8px;
  font-size:11.5px;color:var(--text2);align-items:center;
  line-height:1.5;
}
.tx-detail-row .tag{
  display:inline-block;padding:1px 6px;background:#eef3ff;border-radius:10px;
  font-size:10px;color:var(--primary);border:1px solid #d0e2ff;
}
.tx-price-col{
  grid-column:2;grid-row:2/4;display:flex;flex-direction:column;
  align-items:flex-end;justify-content:center;gap:1px;
}
.tx-price{font-size:16px;font-weight:700;color:var(--red);white-space:nowrap;}
.tx-unit{font-size:11.5px;color:#666;font-weight:600;white-space:nowrap;}
.tx-total-price{font-size:11px;color:var(--text2);white-space:nowrap;}
/* å¢é›†åˆ—è¡¨æ¨™é¡Œ */
.cluster-list-header{
  padding:8px 12px;background:#fff3e0;border-bottom:2px solid #ffe0b2;
  display:flex;justify-content:space-between;align-items:center;
  position:sticky;top:0;z-index:15;
}
.cluster-list-header span{font-size:13px;font-weight:700;color:#e65100}
.cluster-list-header button{
  border:none;background:none;color:var(--primary);cursor:pointer;
  font-size:12px;padding:4px 8px;border-radius:6px;
}
.cluster-list-header button:hover{background:#e3f0ff}

/* ========== MAP ========== */
.map-wrap{
  position:fixed;top:var(--header-h);bottom:0;
  left:var(--sidebar-w);right:0;
}
#map{width:100%;height:100%}

/* Map controls */
.map-controls{
  position:absolute;bottom:30px;right:14px;z-index:900;
  display:flex;flex-direction:column;gap:6px;
}
.map-controls button{
  width:40px;height:40px;border-radius:50%;border:none;
  background:#fff;box-shadow:0 2px 8px rgba(0,0,0,.15);
  cursor:pointer;font-size:20px;display:flex;align-items:center;
  justify-content:center;transition:.2s;color:var(--text);
}
.map-controls button:hover{background:var(--primary);color:#fff}
.map-controls .area-search-btn{
  width:auto!important;border-radius:20px!important;padding:0 16px!important;font-size:13px!important;
  font-weight:600;gap:6px;height:38px;
}
.map-controls .area-search-btn:hover{background:var(--green);color:#fff;border-color:var(--green)}

/* å®šä½è„ˆè¡å‹•ç•« */
@keyframes pulse{
  0%{box-shadow:0 0 0 0 rgba(26,115,232,.4)}
  70%{box-shadow:0 0 0 20px rgba(26,115,232,0)}
  100%{box-shadow:0 0 0 0 rgba(26,115,232,0)}
}
.locate-pulse{
  width:16px;height:16px;background:var(--primary);border:3px solid #fff;
  border-radius:50%;animation:pulse 2s infinite;
}

/* price marker no-bg override */
.price-marker{background:none!important;border:none!important}

/* â”€â”€ å»ºæ¡ˆç¾¤çµ„æ”¹å–„ â”€â”€â”€ */
.community-header .ch-stats-inline{
  display:flex;gap:8px;align-items:center;flex-wrap:wrap;
  font-size:10px;color:#555;margin-top:2px;
}
.community-header .ch-stats-inline span{
  background:rgba(255,255,255,.7);border-radius:8px;padding:1px 6px;
  font-size:10px;color:#333;font-weight:600;
}
/* ========== æ‰‹æ©Ÿ ========== */
@media(max-width:768px){
  .hamburger{display:block}
  .sidebar{width:100%;transform:translateX(-100%)}
  .sidebar.open{transform:translateX(0)}
  .map-wrap{left:0}
}
</style>
</head>
<body>

<!-- HEADER -->
<div class="header">
  <button class="hamburger" onclick="toggleSidebar()">â˜°</button>
  <div class="logo">ğŸ¢ è‰¯å¯Œå±…åœ°ç”¢</div>
  <div class="unit-toggle">
    <button id="btnPing" class="active" onclick="setUnit('ping')">åª</button>
    <button id="btnSqm" onclick="setUnit('sqm')">mÂ²</button>
  </div>
</div>

<!-- SIDEBAR -->
<div class="sidebar" id="sidebar">
  <!-- Search -->
  <div class="search-box">
    <div class="search-row">
      <input id="searchInput" type="text" placeholder="æœå°‹åœ°å€ / å»ºæ¡ˆåç¨±â€¦" 
             onkeydown="if(event.key==='Enter')doSearch()">
      <button onclick="doSearch()">æœå°‹</button>
    </div>
    <div class="filter-toggle" onclick="toggleFilters()">
      <span id="filterArrow">â–¶</span> é€²éšç¯©é¸
    </div>
    <div class="filter-panel" id="filterPanel">
      <div>
        <label>å»ºç‰©å‹æ…‹</label>
        <select id="fBuildType">
          <option value="">å…¨éƒ¨</option>
          <option value="ä½å®…å¤§æ¨“">ä½å®…å¤§æ¨“(11æ¨“å«ä»¥ä¸Šæœ‰é›»æ¢¯)</option>
          <option value="è¯å»ˆ">è¯å»ˆ(10æ¨“å«ä»¥ä¸‹æœ‰é›»æ¢¯)</option>
          <option value="å…¬å¯“">å…¬å¯“(5æ¨“å«ä»¥ä¸‹ç„¡é›»æ¢¯)</option>
          <option value="é€å¤©å">é€å¤©å</option>
          <option value="å¥—æˆ¿">å¥—æˆ¿(1æˆ¿1å»³1è¡›)</option>
        </select>
      </div>
      <div>
        <label>æˆ¿æ•¸</label>
        <input id="fRooms" type="text" placeholder="å¦‚ 2,3,4">
      </div>
      <div>
        <label>åªæ•¸ç¯„åœ</label>
        <input id="fPing" type="text" placeholder="å¦‚ 20-40">
      </div>
      <div>
        <label>å…¬è¨­æ¯” %</label>
        <input id="fRatio" type="text" placeholder="å¦‚ 0-35">
      </div>
      <div>
        <label>å–®åƒ¹ (è¬/åª)</label>
        <input id="fUnitPrice" type="text" placeholder="å¦‚ 40-80">
      </div>
      <div>
        <label>ç¸½åƒ¹ (è¬)</label>
        <input id="fPrice" type="text" placeholder="å¦‚ 1000-3000">
      </div>
      <div>
        <label>æ°‘åœ‹å¹´ç¯„åœ</label>
        <input id="fYear" type="text" placeholder="å¦‚ 110-114">
      </div>
      <div class="filter-btns">
        <button class="btn-clear" onclick="clearFilters()">æ¸…é™¤</button>
        <button class="btn-apply" onclick="doSearch()">å¥—ç”¨</button>
      </div>
    </div>
  </div>

  <!-- Sort -->
  <div class="sort-bar">
    <button class="active" data-sort="date" onclick="setSort(this)">æ—¥æœŸ</button>
    <button data-sort="price" onclick="setSort(this)">ç¸½åƒ¹</button>
    <button data-sort="unit_price" onclick="setSort(this)">å–®åƒ¹</button>
    <button data-sort="ping" onclick="setSort(this)">åªæ•¸</button>
    <button data-sort="public_ratio" onclick="setSort(this)">å…¬è¨­</button>
    <button data-sort="community" onclick="setSort(this)">å»ºæ¡ˆ</button>
    <select id="limitSelect" class="limit-select" onchange="rerunSearch()" title="é¡¯ç¤ºç­†æ•¸">
      <option value="100">100ç­†</option>
      <option value="200">200ç­†</option>
      <option value="500" selected>500ç­†</option>
      <option value="1000">1000ç­†</option>
      <option value="2000">å…¨éƒ¨</option>
    </select>
  </div>

  <!-- Summary -->
  <div class="summary-bar" id="summaryBar"></div>

  <!-- Results -->
  <div class="results" id="results">
    <div class="empty">ğŸ‘† è¼¸å…¥åœ°å€æˆ–å»ºæ¡ˆåç¨±é–‹å§‹æœå°‹<br><span style="font-size:12px;margin-top:8px;display:block">æˆ–é»æ“Šåœ°åœ–å³ä¸‹è§’ã€ŒğŸ” æœæ­¤å€åŸŸã€æŒ‰éˆ•</span></div>
  </div>
</div>

<!-- MAP -->
<div class="map-wrap">
  <div id="map"></div>
  <div class="map-controls">
    <button class="area-search-btn" onclick="doAreaSearch()" title="æœå°‹ç›®å‰åœ°åœ–ç¯„åœå…§çš„æˆäº¤ç´€éŒ„">ğŸ” æœæ­¤å€åŸŸ</button>
    <button onclick="locateMe()" title="ç§»å‹•åˆ°æˆ‘çš„ä½ç½®">ğŸ“</button>
    <button onclick="map.zoomIn()" title="æ”¾å¤§">ï¼‹</button>
    <button onclick="map.zoomOut()" title="ç¸®å°">ï¼</button>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// å…¨åŸŸç‹€æ…‹
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let map, markerGroup;
let unit = 'ping';
let currentSort = 'date';
let txData = [];
let activeCardIdx = -1;
let markerClusterGroup;
let collapsedCommunities = {};
let communitySummaries = {};
let locationMarker = null;
let locationCircle = null;
let lastSearchType = 'none'; // 'keyword' | 'area' | 'none'

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// åœ°åœ–åˆå§‹åŒ–
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initMap(){
  map = L.map('map',{zoomControl:false}).setView([25.033,121.565],13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    maxZoom:19, attribution:'Â© OpenStreetMap'
  }).addTo(map);

  markerClusterGroup = L.markerClusterGroup({
    maxClusterRadius: 60,
    disableClusteringAtZoom: 19,
    spiderfyOnMaxZoom: true,
    showCoverageOnHover: false,
    zoomToBoundsOnClick: true,
    spiderfyDistanceMultiplier: 2.5,
    iconCreateFunction: function(cluster) {
      const count = cluster.getChildCount();
      let dim = 42;
      if(count >= 100) dim = 58;
      else if(count >= 30) dim = 52;
      else if(count >= 10) dim = 46;

      // å¢é›†å¹³å‡ç¸½åƒ¹èˆ‡å–®åƒ¹
      const markers = cluster.getAllChildMarkers();
      let totalPrice = 0, totalUnit = 0, validP = 0, validU = 0;
      markers.forEach(m => {
        if(m._txPrice && m._txPrice > 0){ totalPrice += m._txPrice; validP++; }
        if(m._txUnitPrice && m._txUnitPrice > 0){ totalUnit += m._txUnitPrice; validU++; }
      });
      const avgWan = validP > 0 ? (totalPrice / validP / 10000) : 0;
      const avgUnitWan = validU > 0 ? (totalUnit / validU / 10000) : 0;

      let priceLabel = '';
      if(avgWan >= 10000) priceLabel = (avgWan/10000).toFixed(1)+'å„„';
      else if(avgWan >= 1) priceLabel = avgWan.toFixed(0)+'è¬';

      // é›™è‰²ï¼šå…§éƒ¨=å¹³å‡ç¸½åƒ¹è‰²ï¼Œé‚Šæ¡†=å¹³å‡å–®åƒ¹è‰²
      let innerColor = '#1a73e8';
      if(avgWan >= 4000) innerColor = '#c62828';
      else if(avgWan >= 2000) innerColor = '#ea4335';
      else if(avgWan >= 1000) innerColor = '#f9ab00';
      else if(avgWan > 0) innerColor = '#34a853';

      let outerColor = '#fff';
      if(avgUnitWan >= 70) outerColor = '#b71c1c';
      else if(avgUnitWan >= 40) outerColor = '#e65100';
      else if(avgUnitWan >= 20) outerColor = '#f57f17';
      else if(avgUnitWan > 0) outerColor = '#1b5e20';

      return L.divIcon({
        html: `<div style="
          display:flex;flex-direction:column;align-items:center;justify-content:center;
          width:${dim}px;height:${dim}px;background:${innerColor};border:4px solid ${outerColor};
          border-radius:50%;color:#fff;font-weight:700;font-size:11px;
          text-shadow:0 1px 2px rgba(0,0,0,.3);box-shadow:0 2px 8px rgba(0,0,0,.25);
          line-height:1.2;cursor:pointer;
        ">${count}ç­†<br><span style="font-size:9px">${priceLabel}</span></div>`,
        className: 'price-marker',
        iconSize: [dim, dim]
      });
    }
  });
  map.addLayer(markerClusterGroup);
  markerGroup = markerClusterGroup;

  // å¢é›†é»æ“Šï¼šé«˜ç¸®æ”¾æˆ–å¯†é›†æ™‚åœ¨å´æ¬„é¡¯ç¤ºåˆ—è¡¨
  markerClusterGroup.on('clusterclick', function(e){
    const zoom = map.getZoom();
    const count = e.layer.getChildCount();
    if(zoom >= 16 || count >= 6){
      const mkrs = e.layer.getAllChildMarkers();
      const items = mkrs
        .filter(m => typeof m._txIdx !== 'undefined' && txData[m._txIdx])
        .map(m => ({tx: txData[m._txIdx], origIdx: m._txIdx}));
      if(items.length > 0) showClusterList(items);
    }
  });

  addLegend();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// å–®ä½åˆ‡æ›
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setUnit(u){
  unit = u;
  document.getElementById('btnPing').classList.toggle('active', u==='ping');
  document.getElementById('btnSqm').classList.toggle('active', u==='sqm');
  renderResults();
  renderSummary();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// æ ¼å¼åŒ–å·¥å…·
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function fmtWan(val){
  if(!val||val<=0) return '-';
  const w = val / 10000;
  if(w >= 10000) return (w/10000).toFixed(2) + 'å„„';
  if(w >= 1) return w.toFixed(w<100?1:0) + 'è¬';
  return val.toLocaleString() + 'å…ƒ';
}

function fmtArea(sqm, ping){
  if(unit==='ping') return (ping||0).toFixed(1) + 'åª';
  return (sqm||0).toFixed(1) + 'mÂ²';
}

function fmtUnitPrice(unitPricePing, unitPriceSqm){
  if(unit==='ping'){
    if(!unitPricePing||unitPricePing<=0) return '-';
    return (unitPricePing / 10000).toFixed(1) + 'è¬/åª';
  } else {
    if(!unitPriceSqm||unitPriceSqm<=0) return '-';
    return (unitPriceSqm / 10000).toFixed(1) + 'è¬/mÂ²';
  }
}

function escHtml(s){
  if(!s) return '';
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
function escAttr(s){
  if(!s) return '';
  return s.replace(/&/g,'&amp;').replace(/'/g,'&#39;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}
function cssId(s){
  return btoa(unescape(encodeURIComponent(s))).replace(/[^a-zA-Z0-9]/g,'_');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Sidebar toggle (æ‰‹æ©Ÿ)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleSidebar(){
  document.getElementById('sidebar').classList.toggle('open');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ç¯©é¸é¢æ¿
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleFilters(){
  const p = document.getElementById('filterPanel');
  const a = document.getElementById('filterArrow');
  const show = !p.classList.contains('show');
  p.classList.toggle('show', show);
  a.textContent = show ? 'â–¼' : 'â–¶';
}

function clearFilters(){
  ['fBuildType','fRooms','fPing','fRatio','fUnitPrice','fPrice','fYear']
    .forEach(id=>{const el=document.getElementById(id); if(el) el.value='';});
}

function getFilterParams(){
  let p = '';
  const bt = document.getElementById('fBuildType').value;
  if(bt) p += '&building_type=' + encodeURIComponent(bt);
  const rm = document.getElementById('fRooms').value.trim();
  if(rm) p += '&rooms=' + encodeURIComponent(rm);
  const pg = document.getElementById('fPing').value.trim();
  if(pg) p += '&ping=' + encodeURIComponent(pg);
  const rt = document.getElementById('fRatio').value.trim();
  if(rt) p += '&public_ratio=' + encodeURIComponent(rt);
  const up = document.getElementById('fUnitPrice').value.trim();
  if(up) p += '&unit_price=' + encodeURIComponent(up);
  const pr = document.getElementById('fPrice').value.trim();
  if(pr) p += '&price=' + encodeURIComponent(pr);
  const yr = document.getElementById('fYear').value.trim();
  if(yr) p += '&year=' + encodeURIComponent(yr);
  return p;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// å‰ç«¯æ’åº
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function sortData(sortType){
  switch(sortType){
    case 'date':
      txData.sort((a,b) => (b.date_raw||'').localeCompare(a.date_raw||''));
      break;
    case 'price':
      txData.sort((a,b) => (b.price||0) - (a.price||0));
      break;
    case 'unit_price':
      txData.sort((a,b) => (b.unit_price_ping||0) - (a.unit_price_ping||0));
      break;
    case 'ping':
      txData.sort((a,b) => (b.area_ping||0) - (a.area_ping||0));
      break;
    case 'public_ratio':
      txData.sort((a,b) => (a.public_ratio||999) - (b.public_ratio||999));
      break;
    case 'community': {
      txData.sort((a,b) => {
        const ca = a.community_name || '';
        const cb = b.community_name || '';
        if(ca && !cb) return -1;
        if(!ca && cb) return 1;
        if(ca !== cb) return ca.localeCompare(cb);
        return (b.date_raw||'').localeCompare(a.date_raw||'');
      });
      break;
    }
  }
}

function setSort(btn){
  document.querySelectorAll('.sort-bar button[data-sort]').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  currentSort = btn.dataset.sort;
  if(txData.length > 0){
    sortData(currentSort);
    renderResults();
    plotMarkers(false);
  }
}

// é™ç­†æ•¸è®Šæ›´æ™‚é‡æ–°æœå°‹
function rerunSearch(){
  if(lastSearchType === 'area') doAreaSearch();
  else if(lastSearchType === 'keyword') doSearch();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// é—œéµå­—æœå°‹
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function doSearch(){
  const kw = document.getElementById('searchInput').value.trim();
  if(!kw){alert('è«‹è¼¸å…¥æœå°‹é—œéµå­—');return;}

  lastSearchType = 'keyword';
  const results = document.getElementById('results');
  results.innerHTML = '<div class="loading">ğŸ” æœå°‹ä¸­â€¦</div>';

  const limitVal = document.getElementById('limitSelect').value;
  const url = '/api/search?keyword=' + encodeURIComponent(kw) +
              '&limit=' + limitVal + getFilterParams();
  try{
    const resp = await fetch(url);
    const ctype = resp.headers.get('content-type') || '';
    if(!ctype.includes('application/json')){
      const text = await resp.text();
      results.innerHTML = `<div class="empty">âŒ ä¼ºæœå™¨å›æ‡‰ç•°å¸¸ (HTTP ${resp.status})</div>`;
      console.error('Non-JSON response from /api/search:', text.substring(0, 300));
      return;
    }
    const data = await resp.json();
    if(!data.success){
      results.innerHTML = '<div class="empty">âŒ ' + (data.error||'æœå°‹å¤±æ•—') + '</div>';
      return;
    }
    handleSearchResult(data);
  } catch(e){
    results.innerHTML = '<div class="empty">âŒ ç¶²è·¯éŒ¯èª¤: ' + e.message + '</div>';
    console.error('Search error:', e);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// å€åŸŸæœå°‹ï¼ˆåœ°åœ–å¯è¦–ç¯„åœï¼‰
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function doAreaSearch(){
  const bounds = map.getBounds();
  lastSearchType = 'area';
  const results = document.getElementById('results');
  results.innerHTML = '<div class="loading">ğŸ” æœå°‹æ­¤å€åŸŸæˆäº¤ç´€éŒ„â€¦</div>';

  const limitVal = document.getElementById('limitSelect').value;
  const url = `/api/search_area?south=${bounds.getSouth()}&north=${bounds.getNorth()}&west=${bounds.getWest()}&east=${bounds.getEast()}&limit=${limitVal}` + getFilterParams();

  try{
    const resp = await fetch(url);
    const ctype = resp.headers.get('content-type') || '';
    if(!ctype.includes('application/json')){
      const text = await resp.text();
      results.innerHTML = `<div class="empty">âŒ æœæ­¤å€åŸŸå¤±æ•— (HTTP ${resp.status})<br><span style="font-size:11px;color:#aaa">${escHtml(text.substring(0,80))}</span></div>`;
      console.error('Non-JSON response from /api/search_area:', text.substring(0, 300));
      return;
    }
    const data = await resp.json();
    if(!data.success){
      results.innerHTML = '<div class="empty">âŒ ' + (data.error||'æœå°‹å¤±æ•—') + '</div>';
      return;
    }
    if(!data.transactions || data.transactions.length === 0){
      results.innerHTML = '<div class="empty">ğŸ˜¢ æ­¤å€åŸŸæ²’æœ‰æˆäº¤ç´€éŒ„<br><span style="font-size:12px">è©¦è©¦æ”¾å¤§åœ°åœ–æˆ–ç§»å‹•åˆ°å…¶ä»–å€åŸŸ</span></div>';
      document.getElementById('summaryBar').style.display = 'none';
      markerGroup.clearLayers();
      return;
    }
    handleSearchResult(data, false);
  } catch(e){
    results.innerHTML = '<div class="empty">âŒ æœæ­¤å€åŸŸå¤±æ•—: ' + e.message + '</div>';
    console.error('Area search error:', e);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// çµ±ä¸€è™•ç†æœå°‹çµæœ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function handleSearchResult(data, fitBounds = true){
  txData = data.transactions || [];
  if(txData.length === 0){
    document.getElementById('results').innerHTML = '<div class="empty">ğŸ˜¢ æ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„è³‡æ–™</div>';
    document.getElementById('summaryBar').style.display = 'none';
    markerGroup.clearLayers();
    return;
  }

  window._communityName = data.community_name || null;
  window._searchType = data.search_type || 'address';
  window._summary = data.summary || {};
  communitySummaries = data.community_summaries || {};
  collapsedCommunities = {};

  sortData(currentSort);
  renderResults();
  renderSummary();
  plotMarkers(fitBounds);

  if(window.innerWidth <= 768){
    document.getElementById('sidebar').classList.remove('open');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// æ¸²æŸ“çµæœåˆ—è¡¨ â€” å»ºæ¡ˆåˆ†çµ„ + æ”¹å–„å¡ç‰‡
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderResults(){
  const container = document.getElementById('results');

  // æŒ‰å»ºæ¡ˆåˆ†çµ„
  const groups = [];
  const communityMap = {};
  const noComItems = [];

  txData.forEach((tx, i) => {
    const cn = tx.community_name || '';
    if(cn){
      if(!(cn in communityMap)){
        communityMap[cn] = groups.length;
        groups.push({name: cn, items: []});
      }
      groups[communityMap[cn]].items.push({tx, origIdx: i});
    } else {
      noComItems.push({tx, origIdx: i});
    }
  });

  let html = '';

  // å…¨å±€å»ºæ¡ˆåç¨±ï¼ˆå–®ä¸€å»ºæ¡ˆæœå°‹æ™‚ï¼‰
  if(window._communityName && groups.length <= 1 && window._searchType !== 'area'){
    html += `<div style="padding:10px 12px;background:#e8f5e9;border-bottom:1px solid #c8e6c9">
      <span style="font-weight:700;font-size:14px;color:#2e7d32">ğŸ˜ï¸ ${escHtml(window._communityName)}</span>
    </div>`;
  }

  // æœ‰å»ºæ¡ˆçš„ç¾¤çµ„
  groups.forEach(group => {
    const cn = group.name;
    const isCollapsed = collapsedCommunities[cn] === true;
    const stats = communitySummaries[cn] || computeLocalStats(group.items);

    html += `<div class="community-group">`;
    const inlineStats = stats
      ? [
          stats.avg_unit_price_ping > 0 ? `å‡å–® ${(stats.avg_unit_price_ping/10000).toFixed(0)}è¬/åª` : '',
          stats.avg_ping > 0 ? `å‡åª ${stats.avg_ping.toFixed(0)}åª` : '',
          stats.avg_ratio > 0 ? `å…¬è¨­ ${stats.avg_ratio.toFixed(0)}%` : '',
        ].filter(Boolean)
      : [];
    html += `<div class="community-header" onclick="toggleCommunity(this, '${escAttr(cn)}')">
      <span class="ch-arrow ${isCollapsed?'':'open'}">â–¶</span>
      <div style="flex:1;min-width:0">
        <div class="ch-name">${escHtml(cn)}</div>
        ${inlineStats.length ? `<div class="ch-stats-inline">${inlineStats.map(s=>`<span>${s}</span>`).join('')}</div>` : ''}
      </div>
      <span class="ch-count">${group.items.length} ç­†</span>
    </div>`;

    // å»ºæ¡ˆçµ±è¨ˆé¢æ¿
    if(stats){
      html += `<div class="community-stats" id="cstats-${cssId(cn)}" style="${isCollapsed?'display:none':''}">
        <div class="cs-item"><span class="cs-label">ğŸ“Š äº¤æ˜“ç­†æ•¸</span><span class="cs-value">${group.items.length} ç­†</span></div>
        <div class="cs-item"><span class="cs-label">ğŸ’° å‡ç¸½åƒ¹</span><span class="cs-value">${fmtWan(stats.avg_price)}</span></div>
        <div class="cs-item"><span class="cs-label">ğŸ“ˆ å‡å–®åƒ¹</span><span class="cs-value">${stats.avg_unit_price_ping > 0 ? (stats.avg_unit_price_ping/10000).toFixed(1)+'è¬/åª' : '-'}</span></div>
        <div class="cs-item"><span class="cs-label">ğŸ“ å‡åªæ•¸</span><span class="cs-value">${stats.avg_ping > 0 ? stats.avg_ping.toFixed(1)+'åª' : '-'}</span></div>
        <div class="cs-item"><span class="cs-label">ğŸ—ï¸ å…¬è¨­æ¯”</span><span class="cs-value" style="color:${stats.avg_ratio>35?'var(--red)':stats.avg_ratio>30?'var(--orange)':'var(--green)'}">${stats.avg_ratio > 0 ? stats.avg_ratio.toFixed(1)+'%' : '-'}</span></div>
      </div>`;
    }

    html += `<div class="community-items ${isCollapsed?'collapsed':''}" id="citems-${cssId(cn)}" style="${isCollapsed?'max-height:0':'max-height:999999px'}">`;
    group.items.forEach(item => {
      html += renderTxCard(item.tx, item.origIdx, true);
    });
    html += `</div></div>`;
  });

  // ç„¡å»ºæ¡ˆäº¤æ˜“
  if(noComItems.length > 0){
    if(groups.length > 0){
      html += `<div style="padding:8px 12px;background:#f5f5f5;border-bottom:1px solid #e0e0e0;font-size:12px;color:var(--text2);font-weight:600">å…¶ä»–äº¤æ˜“ (${noComItems.length} ç­†)</div>`;
    }
    noComItems.forEach(item => {
      html += renderTxCard(item.tx, item.origIdx, false);
    });
  }

  if(!html) html = '<div class="empty">æ²’æœ‰è³‡æ–™</div>';
  container.innerHTML = html;
}

function renderTxCard(tx, idx, inGroup){
  const isActive = idx === activeCardIdx;
  const cn = tx.community_name || '';

  // æ ¹æ“šå–®åƒ¹æ±ºå®šè‰²æ¢æ¨£å¼
  const upWan = (tx.unit_price_ping||0) / 10000;
  let priceClass = '';
  if(upWan > 100) priceClass = ' price-high';
  else if(upWan > 50) priceClass = ' price-mid';
  else if(upWan > 0) priceClass = ' price-low';

  // å»ºæ¡ˆæ¨™ç±¤ï¼šéç¾¤çµ„å…§æ°¸é é¡¯ç¤ºï¼›ç¾¤çµ„å…§ä¹Ÿé¡¯ç¤ºï¼ˆè¼ƒå°æ¨£å¼ï¼‰
  const cnTag = cn
    ? `<span class="tx-community-tag" title="${escAttr(cn)}">${escHtml(cn)}</span>`
    : '';
  const cnRow = cnTag ? `<div class="tx-community-row">${cnTag}</div>` : '';

  return `<div class="tx-card${isActive?' active':''}${priceClass}" onclick="selectTx(${idx})" data-idx="${idx}">
    <div class="tx-addr" title="${escAttr(tx.address)}">${escHtml(tx.address)}</div>
    ${cnRow}
    <div class="tx-detail-row">
      <span>ğŸ“… ${tx.date||'-'}</span>
      <span>ğŸ“ ${fmtArea(tx.area_sqm, tx.area_ping)}</span>
      <span>${tx.rooms||0}æˆ¿${tx.halls||0}å»³${tx.baths||0}è¡›</span>
      ${tx.floor ? `<span>ğŸ¢ ${escHtml(String(tx.floor))}F/${escHtml(String(tx.total_floors))}F</span>` : ''}
      ${tx.public_ratio>0 ? `<span class="tag">å…¬è¨­${tx.public_ratio}%</span>` : ''}
      ${tx.building_type ? `<span class="tag">${escHtml(tx.building_type)}</span>` : ''}
    </div>
    <div class="tx-price-col">
      <div class="tx-unit">${fmtUnitPrice(tx.unit_price_ping, tx.unit_price_sqm)}</div>
      <div class="tx-price">${fmtWan(tx.price)}</div>
    </div>
  </div>`;
}

// å‰ç«¯è¨ˆç®—å»ºæ¡ˆçµ±è¨ˆï¼ˆå¾Œç«¯æ²’æä¾›æ™‚ï¼‰
function computeLocalStats(items){
  if(!items||items.length===0) return null;
  let prices=[],ups=[],pings=[],ratios=[];
  items.forEach(({tx})=>{
    if(tx.price>0) prices.push(tx.price);
    if(tx.unit_price_ping>0) ups.push(tx.unit_price_ping);
    if(tx.area_ping>0) pings.push(tx.area_ping);
    if(tx.public_ratio>0) ratios.push(tx.public_ratio);
  });
  const avg = arr => arr.length ? arr.reduce((a,b)=>a+b,0)/arr.length : 0;
  return {
    count: items.length,
    avg_price: Math.round(avg(prices)),
    avg_unit_price_ping: avg(ups),
    avg_ping: avg(pings),
    avg_ratio: avg(ratios),
  };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// å»ºæ¡ˆæŠ˜ç–Š/å±•é–‹
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleCommunity(headerEl, name){
  const isNowCollapsed = !collapsedCommunities[name];
  collapsedCommunities[name] = isNowCollapsed;

  const itemsEl = document.getElementById('citems-' + cssId(name));
  const statsEl = document.getElementById('cstats-' + cssId(name));
  const arrow = headerEl.querySelector('.ch-arrow');

  if(itemsEl){
    if(isNowCollapsed){
      itemsEl.classList.add('collapsed');
      itemsEl.style.maxHeight = '0';
    } else {
      itemsEl.classList.remove('collapsed');
      itemsEl.style.maxHeight = '999999px';
    }
  }
  if(statsEl){
    statsEl.style.display = isNowCollapsed ? 'none' : '';
  }
  if(arrow){
    arrow.classList.toggle('open', !isNowCollapsed);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// æ¸²æŸ“çµ±è¨ˆæ‘˜è¦
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderSummary(){
  const s = window._summary;
  if(!s || !s.total){
    document.getElementById('summaryBar').style.display = 'none';
    return;
  }
  const bar = document.getElementById('summaryBar');
  bar.style.display = 'block';

  const avgUp = unit==='ping' ? fmtUnitPrice(s.avg_unit_price_ping, 0) : fmtUnitPrice(0, s.avg_unit_price_ping / 3.30579);
  const minUp = unit==='ping' ? fmtUnitPrice(s.min_unit_price_ping, 0) : fmtUnitPrice(0, s.min_unit_price_ping / 3.30579);
  const maxUp = unit==='ping' ? fmtUnitPrice(s.max_unit_price_ping, 0) : fmtUnitPrice(0, s.max_unit_price_ping / 3.30579);

  const comCount = Object.keys(communitySummaries).length;
  const comInfo = comCount > 0 ? ` ï½œ <span class="val">${comCount}</span> å€‹å»ºæ¡ˆ` : '';

  bar.innerHTML = `
    å…± <span class="val">${s.total}</span> ç­†${comInfo} ï½œ
    å‡åƒ¹ <span class="val">${fmtWan(s.avg_price)}</span> ï½œ
    å‡åª <span class="val">${s.avg_ping}åª</span> ï½œ
    å–®åƒ¹ <span class="val">${avgUp}</span>
    <br>
    å–®åƒ¹å€é–“ <span class="val">${minUp}</span> ~ <span class="val">${maxUp}</span> ï½œ
    å‡å…¬è¨­ <span class="val">${s.avg_ratio||'-'}%</span>
  `;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// åœ°åœ– marker
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function plotMarkers(fitBounds = true){
  markerClusterGroup.clearLayers();
  const boundsArr = [];

  // é¡è‰²æ˜ å°„å‡½æ•¸
  function getTotalPriceColor(price){
    const wan = (price||0) / 10000;
    if(wan <= 0) return '#888';
    if(wan >= 4000) return '#c62828';  // æ·±ç´… > 4000è¬
    if(wan >= 2000) return '#ea4335';  // ç´… 2000-4000è¬
    if(wan >= 1000) return '#f9ab00';  // æ©˜ 1000-2000è¬
    return '#34a853';                  // ç¶  < 1000è¬
  }
  function getUnitPriceColor(unitPricePing){
    const wan = (unitPricePing||0) / 10000;
    if(wan <= 0) return '#888';
    if(wan >= 70) return '#b71c1c';    // æ·±ç´… > 70è¬/åª
    if(wan >= 40) return '#e65100';    // æ·±æ©˜ 40-70è¬/åª
    if(wan >= 20) return '#f57f17';    // æ©˜é»ƒ 20-40è¬/åª
    return '#1b5e20';                  // æ·±ç¶  < 20è¬/åª
  }

  txData.forEach((tx, i) => {
    if(!tx.lat || !tx.lng) return;

    const innerColor = getTotalPriceColor(tx.price);
    const outerColor = getUnitPriceColor(tx.unit_price_ping);

    // ç¸½åƒ¹æ–‡å­—
    const priceWan = (tx.price || 0) / 10000;
    let priceText;
    if(priceWan >= 10000) priceText = (priceWan/10000).toFixed(1) + 'å„„';
    else if(priceWan >= 1) priceText = priceWan.toFixed(0) + 'è¬';
    else priceText = '-';

    // ç¤¾å€åæ¨™ç±¤ï¼ˆæˆªæ–·åˆ° 6 å­—ï¼‰
    const cn = tx.community_name || '';
    const comLabel = cn ? cn.substring(0, 6) : '';

    // é›™è‰²ç’°å½¢ markerï¼šå…§éƒ¨=ç¸½åƒ¹è‰²ï¼Œå¤–æ¡†=å–®åƒ¹è‰²
    const markerSize = comLabel ? 50 : 44;
    const markerHtml = `<div style="display:flex;flex-direction:column;align-items:center;">
      <div style="
        display:flex;align-items:center;justify-content:center;
        width:${markerSize}px;height:${markerSize}px;
        background:${innerColor};
        border:4px solid ${outerColor};
        border-radius:50%;
        font-size:${priceWan >= 10000 ? 9 : 10}px;font-weight:bold;color:white;
        text-shadow:0 1px 2px rgba(0,0,0,.4);
        box-shadow:0 2px 6px rgba(0,0,0,.25);
        line-height:1.1;
      ">${priceText}</div>
      ${comLabel ? `<div style="
        margin-top:-2px;padding:1px 4px;
        background:rgba(255,255,255,.92);border-radius:6px;
        font-size:8px;font-weight:600;color:#333;
        white-space:nowrap;max-width:60px;overflow:hidden;text-overflow:ellipsis;
        box-shadow:0 1px 3px rgba(0,0,0,.15);
        border:1px solid rgba(0,0,0,.08);
      ">${comLabel}</div>` : ''}
    </div>`;

    const totalH = comLabel ? markerSize + 14 : markerSize;
    const marker = L.marker([tx.lat, tx.lng], {
      icon: L.divIcon({html: markerHtml, iconSize:[markerSize + 8, totalH], iconAnchor:[(markerSize+8)/2, totalH/2], className:'price-marker'})
    });
    marker._txPrice = tx.price;
    marker._txUnitPrice = tx.unit_price_ping;
    marker._txIdx = i;
    marker.bindPopup(makePopup(tx), {maxWidth:320});
    marker.on('click', () => {
      activeCardIdx = i;
      renderResults();
      const card = document.querySelector(`.tx-card[data-idx="${i}"]`);
      if(card) card.scrollIntoView({behavior:'smooth', block:'center'});
    });

    markerClusterGroup.addLayer(marker);
    boundsArr.push([tx.lat, tx.lng]);
  });

  if(fitBounds && boundsArr.length > 0){
    map.fitBounds(boundsArr, {padding:[40,40], maxZoom:16});
  }
}

function makePopup(tx){
  const cn = tx.community_name
    ? `<div style="background:#e8f5e9;padding:2px 8px;border-radius:8px;display:inline-block;color:#2e7d32;font-size:12px;font-weight:600;margin-bottom:4px">ğŸ˜ï¸ ${escHtml(tx.community_name)}</div><br>`
    : '';
  return `<div style="font-size:13px;line-height:1.6">
    ${cn}
    <b>${escHtml(tx.address)}</b><br>
    ğŸ“… ${tx.date||'-'} ï½œ ğŸ“ ${fmtArea(tx.area_sqm, tx.area_ping)}<br>
    ğŸ’° <b style="color:#ea4335">${fmtWan(tx.price)}</b>
    <span style="color:#666">${fmtUnitPrice(tx.unit_price_ping, tx.unit_price_sqm)}</span><br>
    ğŸ¢ ${tx.rooms||0}æˆ¿${tx.halls||0}å»³${tx.baths||0}è¡›
    ${tx.floor?'ï½œ '+tx.floor+'F/'+tx.total_floors+'F':''}
    ${tx.public_ratio>0?'ï½œ å…¬è¨­'+tx.public_ratio+'%':''}
    ${tx.building_type?'<br>'+escHtml(tx.building_type):''}
    ${tx.note?'<br><span style="color:#888;font-size:11px">'+escHtml(tx.note)+'</span>':''}
  </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// é¸å–äº¤æ˜“
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function selectTx(idx){
  activeCardIdx = idx;
  renderResults();
  const tx = txData[idx];
  if(tx && tx.lat && tx.lng){
    map.setView([tx.lat, tx.lng], 17);
    markerClusterGroup.eachLayer(layer => {
      if(layer._txIdx === idx){
        markerClusterGroup.zoomToShowLayer(layer, () => {
          layer.openPopup();
        });
      }
    });
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// åœ–ä¾‹
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addLegend(){
  const legend = L.control({position: 'bottomleft'});
  legend.onAdd = function(){
    const div = L.DomUtil.create('div','');
    div.innerHTML = `
      <div style="background:#fff;padding:10px 12px;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,.15);font-size:11px;line-height:1.8;min-width:140px">
        <div style="font-weight:700;margin-bottom:4px;font-size:12px">ğŸ¯ åœ“å¿ƒï¼ç¸½åƒ¹</div>
        <div style="display:flex;align-items:center;gap:6px"><div style="width:14px;height:14px;border-radius:50%;background:#34a853;box-shadow:0 1px 2px rgba(0,0,0,.2)"></div><span>ï¼œ1000è¬</span></div>
        <div style="display:flex;align-items:center;gap:6px"><div style="width:14px;height:14px;border-radius:50%;background:#f9ab00;box-shadow:0 1px 2px rgba(0,0,0,.2)"></div><span>1000~2000è¬</span></div>
        <div style="display:flex;align-items:center;gap:6px"><div style="width:14px;height:14px;border-radius:50%;background:#ea4335;box-shadow:0 1px 2px rgba(0,0,0,.2)"></div><span>2000~4000è¬</span></div>
        <div style="display:flex;align-items:center;gap:6px"><div style="width:14px;height:14px;border-radius:50%;background:#c62828;box-shadow:0 1px 2px rgba(0,0,0,.2)"></div><span>ï¼4000è¬</span></div>
        <div style="font-weight:700;margin:6px 0 4px;font-size:12px">ğŸ’ å¤–ç’°ï¼å–®åƒ¹/åª</div>
        <div style="display:flex;align-items:center;gap:6px"><div style="width:14px;height:14px;border-radius:50%;background:#fff;border:3px solid #1b5e20"></div><span>ï¼œ20è¬</span></div>
        <div style="display:flex;align-items:center;gap:6px"><div style="width:14px;height:14px;border-radius:50%;background:#fff;border:3px solid #f57f17"></div><span>20~40è¬</span></div>
        <div style="display:flex;align-items:center;gap:6px"><div style="width:14px;height:14px;border-radius:50%;background:#fff;border:3px solid #e65100"></div><span>40~70è¬</span></div>
        <div style="display:flex;align-items:center;gap:6px"><div style="width:14px;height:14px;border-radius:50%;background:#fff;border:3px solid #b71c1c"></div><span>ï¼70è¬</span></div>
      </div>`;
    L.DomEvent.disableScrollPropagation(div);
    L.DomEvent.disableClickPropagation(div);
    return div;
  };
  legend.addTo(map);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GPS å®šä½
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function locateMe(){
  if(!navigator.geolocation){
    alert('æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´å®šä½åŠŸèƒ½');
    return;
  }
  const btn = document.querySelector('.map-controls button[title="ç§»å‹•åˆ°æˆ‘çš„ä½ç½®"]');
  if(btn){ btn.style.background='#e3f2fd'; btn.innerHTML='â³'; }

  navigator.geolocation.getCurrentPosition(
    pos => {
      const {latitude:lat, longitude:lng, accuracy} = pos.coords;
      map.setView([lat, lng], 16);

      // ç§»é™¤èˆŠæ¨™è¨˜
      if(locationMarker){ map.removeLayer(locationMarker); }
      if(locationCircle){ map.removeLayer(locationCircle); }

      locationCircle = L.circle([lat, lng], {
        radius: accuracy, color:'#1a73e8', fillColor:'#1a73e8',
        fillOpacity:0.1, weight:1
      }).addTo(map);

      locationMarker = L.marker([lat, lng], {
        icon: L.divIcon({
          html:'<div class="locate-pulse"></div>',
          iconSize:[16,16], className:''
        }),
        zIndexOffset: 1000
      }).addTo(map)
       .bindPopup(`ğŸ“ æ‚¨çš„ä½ç½®<br><span style="font-size:11px;color:#666">ç²¾ç¢ºåº¦: Â±${Math.round(accuracy)}m</span>`)
       .openPopup();

      setTimeout(() => { if(locationCircle) map.removeLayer(locationCircle); locationCircle=null; }, 5000);
      if(btn){ btn.style.background=''; btn.innerHTML='ğŸ“'; }
    },
    err => {
      alert('å®šä½å¤±æ•—: ' + err.message);
      if(btn){ btn.style.background=''; btn.innerHTML='ğŸ“'; }
    },
    {enableHighAccuracy:true, timeout:10000}
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// å¢é›†åˆ—è¡¨é¢æ¿
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showClusterList(items){
  const container = document.getElementById('results');
  let html = `<div class="cluster-list-header">
    <span>ğŸ“ æ­¤ä½ç½® ${items.length} ç­†é‡ç–Šè³‡æ–™</span>
    <button onclick="renderResults()">â†© è¿”å›å…¨åˆ—è¡¨</button>
  </div>`;
  items.forEach(({tx, origIdx}) => {
    html += renderTxCard(tx, origIdx, false);
  });
  container.innerHTML = html;
  if(window.innerWidth <= 768){
    document.getElementById('sidebar').classList.add('open');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// åˆå§‹åŒ–
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('DOMContentLoaded', () => {
  initMap();
});
</script>
</body>
</html>
