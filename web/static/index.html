<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>è‰¯å¯Œå±…åœ°ç”¢</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.1/dist/MarkerCluster.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.1/dist/MarkerCluster.Default.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.1/dist/leaflet.markercluster.js"></script>
<style>
/* ========== å…¨åŸŸ ========== */
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --primary:#1a73e8;--primary-dark:#1558b0;--bg:#f5f7fa;
  --card:#fff;--text:#222;--text2:#555;--border:#ddd;
  --green:#34a853;--red:#ea4335;--orange:#f9ab00;
  --sidebar-w:440px;--header-h:54px;
}
html,body{height:100%;font-family:'Segoe UI','Microsoft JhengHei',sans-serif;background:var(--bg);color:var(--text)}

/* ========== HEADER ========== */
.header{
  position:fixed;top:0;left:0;right:0;height:var(--header-h);
  background:var(--primary);color:#fff;display:flex;align-items:center;
  padding:0 16px;z-index:1100;gap:12px;
}
.header .logo{font-size:20px;font-weight:700;white-space:nowrap}

.header .unit-toggle{
  margin-left:auto;display:flex;gap:4px;background:rgba(255,255,255,.15);
  border-radius:20px;padding:2px;
}
.header .unit-toggle button{
  border:none;background:transparent;color:rgba(255,255,255,.7);
  padding:5px 14px;border-radius:18px;cursor:pointer;font-size:13px;
  transition:.2s;
}
.header .unit-toggle button.active{background:#fff;color:var(--primary);font-weight:600}
.hamburger{display:none;background:none;border:none;color:#fff;font-size:24px;cursor:pointer}

/* ========== SIDEBAR ========== */
.sidebar{
  position:fixed;top:var(--header-h);left:0;bottom:0;
  width:var(--sidebar-w);background:var(--card);
  border-right:1px solid var(--border);z-index:1050;
  display:flex;flex-direction:column;overflow:hidden;
  transition:transform .3s;
}
.sidebar.collapsed{transform:translateX(-100%)}

/* Search bar */
.search-box{padding:12px;border-bottom:1px solid var(--border);background:#fafbfc}
.search-row{display:flex;gap:6px}
.search-row input{
  flex:1;padding:9px 12px;border:1px solid var(--border);border-radius:8px;
  font-size:14px;outline:none;
}
.search-row input:focus{border-color:var(--primary)}
.search-row button{
  padding:9px 18px;background:var(--primary);color:#fff;border:none;
  border-radius:8px;cursor:pointer;font-size:14px;font-weight:600;
  white-space:nowrap;transition:.2s;
}
.search-row button:hover{background:var(--primary-dark)}

/* Filters */
.filter-toggle{
  display:flex;align-items:center;gap:6px;margin-top:8px;
  font-size:12px;color:var(--primary);cursor:pointer;user-select:none;
}
.filter-toggle:hover{text-decoration:underline}
.filter-panel{
  display:none;margin-top:8px;gap:6px;
  grid-template-columns:1fr 1fr;
}
.filter-panel.show{display:grid}
.filter-panel label{font-size:11px;color:var(--text2);margin-bottom:2px;display:block}
.filter-panel input,.filter-panel select{
  width:100%;padding:5px 8px;border:1px solid var(--border);border-radius:6px;
  font-size:12px;
}
.filter-panel .full-row{grid-column:1/-1}
.filter-btns{
  grid-column:1/-1;display:flex;gap:6px;margin-top:4px;
}
.filter-btns button{
  flex:1;padding:6px;border-radius:6px;border:1px solid var(--border);
  font-size:12px;cursor:pointer;transition:.2s;
}
.filter-btns .btn-apply{background:var(--primary);color:#fff;border-color:var(--primary)}
.filter-btns .btn-clear{background:#fff;color:var(--text2)}

/* Sort bar */
.sort-bar{
  display:flex;gap:2px;padding:8px 12px;border-bottom:1px solid var(--border);
  background:#fafbfc;flex-wrap:wrap;align-items:center;
}
.sort-bar button{
  padding:4px 10px;font-size:11px;border:1px solid var(--border);
  border-radius:14px;background:#fff;cursor:pointer;transition:.2s;
  color:var(--text2);
}
.sort-bar button.active{background:var(--primary);color:#fff;border-color:var(--primary)}
.sort-bar .limit-select{
  margin-left:auto;padding:4px 8px;font-size:11px;
  border:1px solid var(--border);border-radius:14px;
  background:#fff;color:var(--text2);cursor:pointer;
  outline:none;
}

/* Summary */
.summary-bar{
  padding:10px 12px;border-bottom:1px solid var(--border);background:#f0f6ff;
  font-size:12px;color:var(--text2);display:none;line-height:1.8;
}
.summary-bar .val{font-weight:700;color:var(--text)}

/* Results list */
.results{flex:1;overflow-y:auto;padding:0}
.results .empty{padding:40px 20px;text-align:center;color:var(--text2);font-size:14px}
.results .loading{padding:40px 20px;text-align:center;color:var(--text2)}

/* â”€â”€ å»ºæ¡ˆç¾¤çµ„ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.community-group{
  border-bottom:2px solid #e0e0e0;
}
.community-header{
  display:flex;align-items:center;gap:8px;padding:10px 12px;
  background:linear-gradient(135deg,#e8f5e9,#f1f8e9);
  cursor:pointer;user-select:none;
  border-bottom:1px solid #c8e6c9;
  transition:background .15s;
  position:sticky;top:0;z-index:10;
}
.community-header:hover{background:linear-gradient(135deg,#c8e6c9,#e8f5e9)}
.community-header .ch-arrow{
  font-size:12px;color:var(--text2);transition:transform .2s;min-width:16px;text-align:center;
}
.community-header .ch-arrow.open{transform:rotate(90deg)}
.community-header .ch-name{
  font-weight:700;font-size:14px;color:#2e7d32;flex:1;
}
.community-header .ch-count{
  background:#2e7d32;color:#fff;padding:2px 8px;border-radius:10px;
  font-size:11px;font-weight:600;
}
.community-stats{
  display:grid;grid-template-columns:repeat(5,1fr);
  gap:4px 8px;padding:8px 12px;background:#f6fbf6;
  border-bottom:1px solid #e0e0e0;font-size:11px;
}
.community-stats .cs-item{
  display:flex;flex-direction:column;align-items:center;
}
.community-stats .cs-label{color:var(--text2);font-size:10px}
.community-stats .cs-value{font-weight:700;color:var(--text);font-size:12px}
.community-items{overflow:hidden;transition:max-height .3s ease;}
.community-items.collapsed{max-height:0!important;overflow:hidden}

/* â”€â”€ äº¤æ˜“å¡ç‰‡ï¼ˆæ”¹å–„ç‰ˆ v2ï¼‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.tx-card{
  padding:10px 12px 10px 15px;border-bottom:1px solid #ebebeb;cursor:pointer;
  transition:background .15s;display:grid;
  grid-template-columns:1fr auto;grid-template-rows:auto auto auto;
  gap:2px 12px;align-items:start;
  border-left:3px solid transparent;
  position:relative;
}
.tx-card:hover{background:#f4f8ff;border-left-color:#90b8f8;}
.tx-card.active{background:#e3f0ff;border-left:3px solid var(--primary);}
.tx-card.price-high{border-left-color:#ea4335;}
.tx-card.price-mid{border-left-color:#f9ab00;}
.tx-card.price-low{border-left-color:#34a853;}
.tx-card.special{opacity:.55;border-left-style:dashed;}
.tx-parking-tag{display:inline-flex;align-items:center;padding:1px 6px;background:#fff3e0;color:#e65100;border-radius:8px;font-size:10px;font-weight:600;border:1px solid #ffe0b2;margin-left:4px;}
.cluster-analysis{background:#f0f4ff;border:1px solid #c8d6f0;border-radius:8px;padding:10px 12px;margin:8px 0;font-size:12px;}
.cluster-analysis h4{font-size:13px;margin-bottom:6px;color:var(--primary-dark);}
.cluster-analysis .ca-row{display:flex;justify-content:space-between;padding:2px 0;}
.cluster-analysis .ca-label{color:var(--text2);}
.cluster-analysis .ca-val{font-weight:700;}
.cluster-analysis .ca-communities{margin-top:6px;padding-top:6px;border-top:1px solid #dde4f0;}
.cluster-analysis .ca-community-item{display:flex;justify-content:space-between;padding:2px 0;}
.special-badge{display:inline-block;background:#ffebee;color:#c62828;padding:1px 5px;border-radius:6px;font-size:9px;font-weight:600;margin-left:4px;}
.group-badge{display:inline-block;background:#e3f2fd;color:#1565c0;border-radius:12px;padding:1px 7px;font-size:10px;font-weight:600;margin-left:4px;}

.tx-addr{
  grid-column:1;font-size:13px;font-weight:700;color:var(--text);
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
  margin-bottom:1px;
}
.tx-community-tag{
  display:inline-flex;align-items:center;padding:1px 7px;background:#e8f5e9;color:#2e7d32;
  border-radius:10px;font-size:10px;font-weight:600;white-space:nowrap;
  max-width:140px;overflow:hidden;text-overflow:ellipsis;flex-shrink:0;
  border:1px solid #c8e6c9;
}
.tx-community-row{
  grid-column:1/-1;margin-bottom:2px;
}
.tx-detail-row{
  grid-column:1;display:flex;flex-wrap:wrap;gap:3px 8px;
  font-size:11.5px;color:var(--text2);align-items:center;
  line-height:1.5;
}
.tx-detail-row .tag{
  display:inline-block;padding:1px 6px;background:#eef3ff;border-radius:10px;
  font-size:10px;color:var(--primary);border:1px solid #d0e2ff;
}
.tx-price-col{
  grid-column:2;grid-row:2/4;display:flex;flex-direction:column;
  align-items:flex-end;justify-content:center;gap:1px;
}
.tx-price{font-size:16px;font-weight:700;color:var(--red);white-space:nowrap;}
.tx-unit{font-size:11.5px;color:#666;font-weight:600;white-space:nowrap;}
.tx-total-price{font-size:11px;color:var(--text2);white-space:nowrap;}
/* å¢é›†åˆ—è¡¨æ¨™é¡Œ */
.cluster-list-header{
  padding:8px 12px;background:#fff3e0;border-bottom:2px solid #ffe0b2;
  display:flex;justify-content:space-between;align-items:center;
  position:sticky;top:0;z-index:15;
}
.cluster-list-header span{font-size:13px;font-weight:700;color:#e65100}
.cluster-list-header button{
  border:none;background:none;color:var(--primary);cursor:pointer;
  font-size:12px;padding:4px 8px;border-radius:6px;
}
.cluster-list-header button:hover{background:#e3f0ff}

/* ========== MAP ========== */
.map-wrap{
  position:fixed;top:var(--header-h);bottom:0;
  left:var(--sidebar-w);right:0;
}
#map{width:100%;height:100%}

/* Map controls */
.map-controls{
  position:absolute;bottom:30px;right:14px;z-index:900;
  display:flex;flex-direction:column;gap:6px;
}
.map-controls button{
  width:40px;height:40px;border-radius:50%;border:none;
  background:#fff;box-shadow:0 2px 8px rgba(0,0,0,.15);
  cursor:pointer;font-size:20px;display:flex;align-items:center;
  justify-content:center;transition:.2s;color:var(--text);
}
.map-controls button:hover{background:var(--primary);color:#fff}
.map-controls .area-search-btn{
  width:auto!important;border-radius:20px!important;padding:0 16px!important;font-size:13px!important;
  font-weight:600;gap:6px;height:38px;
}
.map-controls .area-search-btn:hover{background:var(--green);color:#fff;border-color:var(--green)}

/* å®šä½è„ˆè¡å‹•ç•« */
@keyframes pulse{
  0%{box-shadow:0 0 0 0 rgba(26,115,232,.4)}
  70%{box-shadow:0 0 0 20px rgba(26,115,232,0)}
  100%{box-shadow:0 0 0 0 rgba(26,115,232,0)}
}
.locate-pulse{
  width:16px;height:16px;background:var(--primary);border:3px solid #fff;
  border-radius:50%;animation:pulse 2s infinite;
}

/* price marker no-bg override */
.price-marker{background:none!important;border:none!important}

/* â”€â”€ å»ºæ¡ˆç¾¤çµ„æ”¹å–„ â”€â”€â”€ */
.community-header .ch-stats-inline{
  display:flex;gap:8px;align-items:center;flex-wrap:wrap;
  font-size:10px;color:#555;margin-top:2px;
}
.community-header .ch-stats-inline span{
  background:rgba(255,255,255,.7);border-radius:8px;padding:1px 6px;
  font-size:10px;color:#333;font-weight:600;
}
/* ========== è¨­å®šé¢æ¿ ========== */
.settings-btn{background:none;border:none;color:#fff;font-size:18px;cursor:pointer;padding:4px 8px;border-radius:8px;transition:.2s}
.settings-btn:hover{background:rgba(255,255,255,.2)}
.settings-panel{
  position:fixed;top:var(--header-h);right:0;width:280px;max-width:90vw;max-height:calc(100vh - var(--header-h));
  background:#fff;box-shadow:-4px 0 20px rgba(0,0,0,.12);z-index:1200;
  transform:translateX(100%);transition:transform .3s;overflow-y:auto;padding:16px;border-radius:0 0 0 12px;
}
.settings-panel.open{transform:translateX(0)}
.settings-panel h3{font-size:15px;font-weight:700;margin-bottom:12px;color:var(--text)}
.settings-panel label{font-size:12px;color:var(--text2);margin-bottom:4px;display:block}
.settings-panel select{width:100%;padding:6px 10px;border:1px solid var(--border);border-radius:8px;font-size:13px;margin-bottom:12px;outline:none}
.settings-group{margin-bottom:14px}
.settings-group-title{font-size:13px;font-weight:600;color:var(--primary);margin-bottom:6px}
.settings-panel input[type=number]{
  width:100%;padding:5px 8px;border:1px solid var(--border);border-radius:6px;
  font-size:12px;margin-bottom:4px;outline:none;
}
.settings-thresholds{display:grid;grid-template-columns:1fr 1fr;gap:4px 8px;margin-top:4px}
.settings-thresholds label{font-size:10px;color:var(--text2)}
.settings-overlay{position:fixed;inset:0;background:rgba(0,0,0,.15);z-index:1150;display:none}
.settings-overlay.show{display:block}

/* ========== å¿«é€Ÿç¯©é¸ ========== */
.quick-filters{
  display:flex;gap:4px;padding:6px 12px;border-bottom:1px solid var(--border);
  background:#fafbfc;flex-wrap:wrap;align-items:center;
}
.quick-filters span{font-size:10px;color:var(--text2);margin-right:2px}
.quick-filters button{
  padding:3px 10px;font-size:11px;border:1px solid var(--border);
  border-radius:14px;background:#fff;cursor:pointer;transition:.2s;
  color:var(--text2);
}
.quick-filters button.active{background:#e3f0ff;color:var(--primary);border-color:var(--primary);font-weight:600}
.quick-filters button:hover{background:#f0f4ff}

/* ========== æ‰‹æ©Ÿ ========== */
@media(max-width:768px){
  .hamburger{display:flex;align-items:center;justify-content:center;width:38px;height:38px}
  .header .logo{font-size:16px}
  .header .unit-toggle button{padding:4px 10px;font-size:12px}
  .sidebar{width:100%;transform:translateX(-100%)}
  .sidebar.open{transform:translateX(0)}
  .map-wrap{left:0}
  .sort-bar{overflow-x:auto;flex-wrap:nowrap;-webkit-overflow-scrolling:touch;scrollbar-width:none}
  .sort-bar::-webkit-scrollbar{display:none}
  .sort-bar button{white-space:nowrap;flex-shrink:0}
  .tx-card{padding:8px 10px 8px 12px}
  .tx-price{font-size:14px}
  .community-stats{grid-template-columns:repeat(3,1fr)}
  .search-row input{font-size:16px}
  .map-controls{bottom:16px;right:8px}
  .map-controls button{width:36px;height:36px;font-size:18px}
  .map-controls .area-search-btn{font-size:12px!important;padding:0 12px!important;height:34px}
  .settings-panel{width:100%;max-width:100vw;border-radius:0}
}
@media(max-width:400px){
  .header{padding:0 8px;gap:6px}
  .header .loc-toggle{margin-left:4px}
  .header .logo{font-size:14px}
}
</style>
</head>
<body>

<!-- HEADER -->
<div class="header">
  <button class="hamburger" onclick="toggleSidebar()">â˜°</button>
  <div class="logo">ğŸ¢ è‰¯å¯Œå±…åœ°ç”¢</div>
  <div class="unit-toggle" style="margin-left:auto">
    <button id="btnPing" class="active" onclick="setUnit('ping')">åª</button>
    <button id="btnSqm" onclick="setUnit('sqm')">mÂ²</button>
  </div>
  <button class="settings-btn" onclick="toggleSettings()" title="åœ“åœˆé¡¯ç¤ºè¨­å®š">âš™ï¸</button>
</div>

<!-- SETTINGS PANEL -->
<div class="settings-overlay" id="settingsOverlay" onclick="toggleSettings()"></div>
<div class="settings-panel" id="settingsPanel">
  <h3>âš™ï¸ åœ“åœˆé¡¯ç¤ºè¨­å®š</h3>
  <div class="settings-group">
    <div class="settings-group-title">ğŸ”´ å¤–ç’°é¡è‰²</div>
    <select id="sOuter" onchange="applySettings()">
      <option value="total_price">ç¸½åƒ¹</option>
      <option value="unit_price">å–®åƒ¹/åª</option>
    </select>
  </div>
  <div class="settings-group">
    <div class="settings-group-title">ğŸŸ¢ å…§åœˆé¡è‰²</div>
    <select id="sInner" onchange="applySettings()">
      <option value="unit_price">å–®åƒ¹/åª</option>
      <option value="total_price">ç¸½åƒ¹</option>
    </select>
  </div>
  <div class="settings-group">
    <div class="settings-group-title">ğŸ“Š åƒ¹æ ¼è¨ˆç®—æ–¹å¼</div>
    <select id="sContent" onchange="applySettings()">
      <option value="recent2yr">è¿‘å…©å¹´å‡åƒ¹(æ’é™¤ç‰¹æ®Š)</option>
      <option value="all">å…¨æœŸé–“å‡åƒ¹</option>
    </select>
  </div>
  <div class="settings-group">
    <div class="settings-group-title">ğŸ¨ å–®åƒ¹è‰²éšé–€æª»ï¼ˆè¬/åªï¼‰</div>
    <div class="settings-thresholds">
      <div><label>ğŸŸ¢ ç¶  ï¼œ</label><input type="number" id="sUnitT1" value="20" onchange="applySettings()"></div>
      <div><label>ğŸŸ¡ é»ƒ ï¼œ</label><input type="number" id="sUnitT2" value="40" onchange="applySettings()"></div>
      <div><label>ğŸŸ  æ©˜ ï¼œ</label><input type="number" id="sUnitT3" value="70" onchange="applySettings()"></div>
      <div><label>ğŸ”´ ç´… â‰¥</label><input type="number" id="sUnitT3r" value="70" disabled style="opacity:.5"></div>
    </div>
  </div>
  <div class="settings-group">
    <div class="settings-group-title">ğŸ¨ ç¸½åƒ¹è‰²éšé–€æª»ï¼ˆè¬ï¼‰</div>
    <div class="settings-thresholds">
      <div><label>ğŸŸ¢ ç¶  ï¼œ</label><input type="number" id="sTotalT1" value="500" onchange="applySettings()"></div>
      <div><label>ğŸŸ¡ é»ƒ ï¼œ</label><input type="number" id="sTotalT2" value="1500" onchange="applySettings()"></div>
      <div><label>ğŸŸ  æ©˜ ï¼œ</label><input type="number" id="sTotalT3" value="3000" onchange="applySettings()"></div>
      <div><label>ğŸ”´ ç´… â‰¥</label><input type="number" id="sTotalT3r" value="3000" disabled style="opacity:.5"></div>
    </div>
  </div>
  <div class="settings-group">
    <div class="settings-group-title">ğŸ“ è‡ªå‹•ç²¾ç¢ºå®šä½</div>
    <div style="font-size:11px;color:var(--text2);line-height:1.6">
      æ”¾å¤§åˆ° 16 ç´šä»¥ä¸Šè‡ªå‹•ä½¿ç”¨ OSM ç²¾ç¢ºåº§æ¨™<br>
      å…¶ä»–ç¸®æ”¾ä½¿ç”¨ DB å»ºæ¡ˆåº§æ¨™ï¼ˆè¼ƒå¿«ï¼‰
    </div>
    <label style="margin-top:4px;font-size:11px;display:flex;align-items:center;gap:4px">
      <input type="number" id="sOsmZoom" value="16" min="13" max="19" style="width:50px" onchange="applySettings()"> ç´šä»¥ä¸Šä½¿ç”¨ç²¾ç¢ºå®šä½
    </label>
  </div>
  <div style="font-size:11px;color:#999;margin-top:8px;line-height:1.6">
    ğŸ’¡ è®Šæ›´å¾Œåœ°åœ–è‡ªå‹•é‡ç¹ª<br>
    ğŸ¯ å¤–ç’°ï¼ç¬¬ä¸€æŒ‡æ¨™ï¼Œå…§åœˆï¼ç¬¬äºŒæŒ‡æ¨™
  </div>
</div>

<!-- SIDEBAR -->
<div class="sidebar" id="sidebar">
  <!-- Search -->
  <div class="search-box">
    <div class="search-row">
      <input id="searchInput" type="text" placeholder="æœå°‹åœ°å€ / å»ºæ¡ˆåç¨±â€¦" 
             onkeydown="if(event.key==='Enter')doSearch()">
      <button onclick="doSearch()">æœå°‹</button>
    </div>
    <div class="filter-toggle" onclick="toggleFilters()">
      <span id="filterArrow">â–¶</span> é€²éšç¯©é¸
    </div>
    <div class="filter-panel" id="filterPanel">
      <div>
        <label>å»ºç‰©å‹æ…‹</label>
        <select id="fBuildType">
          <option value="">å…¨éƒ¨</option>
          <option value="ä½å®…å¤§æ¨“">ä½å®…å¤§æ¨“(11æ¨“å«ä»¥ä¸Šæœ‰é›»æ¢¯)</option>
          <option value="è¯å»ˆ">è¯å»ˆ(10æ¨“å«ä»¥ä¸‹æœ‰é›»æ¢¯)</option>
          <option value="å…¬å¯“">å…¬å¯“(5æ¨“å«ä»¥ä¸‹ç„¡é›»æ¢¯)</option>
          <option value="é€å¤©å">é€å¤©å</option>
          <option value="å¥—æˆ¿">å¥—æˆ¿(1æˆ¿1å»³1è¡›)</option>
        </select>
      </div>
      <div>
        <label>æˆ¿æ•¸</label>
        <input id="fRooms" type="text" placeholder="å¦‚ 2,3,4">
      </div>
      <div>
        <label>åªæ•¸ç¯„åœ</label>
        <input id="fPing" type="text" placeholder="å¦‚ 20-40">
      </div>
      <div>
        <label>å…¬è¨­æ¯” %</label>
        <input id="fRatio" type="text" placeholder="å¦‚ 0-35">
      </div>
      <div>
        <label>å–®åƒ¹ (è¬/åª)</label>
        <input id="fUnitPrice" type="text" placeholder="å¦‚ 40-80">
      </div>
      <div>
        <label>ç¸½åƒ¹ (è¬)</label>
        <input id="fPrice" type="text" placeholder="å¦‚ 1000-3000">
      </div>
      <div>
        <label>æ°‘åœ‹å¹´ç¯„åœ</label>
        <input id="fYear" type="text" placeholder="å¦‚ 110-114">
      </div>
      <div class="full-row" style="display:flex;align-items:center;gap:8px;padding:4px 0">
        <label style="display:flex;align-items:center;gap:4px;cursor:pointer;font-size:12px;color:var(--text)">
          <input type="checkbox" id="fExcludeSpecial"> æ’é™¤ç‰¹æ®Šäº¤æ˜“
        </label>
        <span style="font-size:10px;color:#999" title="è¦ªå‹ã€å“¡å·¥ã€å…±æœ‰äººã€æ³•æ‹ã€èª¿å”ç­‰éå¸‚å ´æ­£å¸¸äº¤æ˜“">â„¹ï¸</span>
      </div>
      <div class="filter-btns">
        <button class="btn-clear" onclick="clearFilters()">æ¸…é™¤</button>
        <button class="btn-apply" onclick="doSearch()">å¥—ç”¨</button>
      </div>
    </div>
  </div>

  <!-- Quick Filters -->
  <div class="quick-filters">
    <span>å¿«é€Ÿ:</span>
    <button onclick="quickFilter('1yr')" id="qf1yr">è¿‘ä¸€å¹´</button>
    <button onclick="quickFilter('2yr')" id="qf2yr">è¿‘å…©å¹´</button>
    <button onclick="quickFilter('nospecial')" id="qfNoSpec">æ’é™¤ç‰¹æ®Š</button>
    <button onclick="quickFilter('clear')">âœ• æ¸…é™¤</button>
  </div>

  <!-- Sort -->
  <div class="sort-bar">
    <button class="active" data-sort="date" onclick="setSort(this)">æ—¥æœŸ</button>
    <button data-sort="price" onclick="setSort(this)">ç¸½åƒ¹</button>
    <button data-sort="unit_price" onclick="setSort(this)">å–®åƒ¹</button>
    <button data-sort="ping" onclick="setSort(this)">åªæ•¸</button>
    <button data-sort="public_ratio" onclick="setSort(this)">å…¬è¨­</button>
    <button data-sort="community" onclick="setSort(this)">å»ºæ¡ˆ</button>
    <select id="limitSelect" class="limit-select" onchange="rerunSearch()" title="é¡¯ç¤ºç­†æ•¸">
      <option value="100">100ç­†</option>
      <option value="200">200ç­†</option>
      <option value="500" selected>500ç­†</option>
      <option value="1000">1000ç­†</option>
      <option value="2000">å…¨éƒ¨</option>
    </select>
  </div>

  <!-- Summary -->
  <div class="summary-bar" id="summaryBar"></div>

  <!-- Results -->
  <div class="results" id="results">
    <div class="empty">ğŸ‘† è¼¸å…¥åœ°å€æˆ–å»ºæ¡ˆåç¨±é–‹å§‹æœå°‹<br><span style="font-size:12px;margin-top:8px;display:block">æˆ–é»æ“Šåœ°åœ–å³ä¸‹è§’ã€ŒğŸ” æœæ­¤å€åŸŸã€æŒ‰éˆ•</span></div>
  </div>
</div>

<!-- MAP -->
<div class="map-wrap">
  <div id="map"></div>
  <div class="map-controls">
    <button class="area-search-btn" onclick="doAreaSearch()" title="æœå°‹ç›®å‰åœ°åœ–ç¯„åœå…§çš„æˆäº¤ç´€éŒ„">ğŸ” æœæ­¤å€åŸŸ</button>
    <button onclick="locateMe()" title="ç§»å‹•åˆ°æˆ‘çš„ä½ç½®">ğŸ“</button>
    <button onclick="map.zoomIn()" title="æ”¾å¤§">ï¼‹</button>
    <button onclick="map.zoomOut()" title="ç¸®å°">ï¼</button>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// å…¨åŸŸç‹€æ…‹
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let map, markerGroup;
let unit = 'ping';
let currentSort = 'date';
let txData = [];
let activeCardIdx = -1;
let markerClusterGroup;
let collapsedCommunities = {};
let communitySummaries = {};
let locationMarker = null;
let locationCircle = null;
let lastSearchType = 'none'; // 'keyword' | 'area' | 'none'
let markerSettings = {
  outerMode:'total_price', innerMode:'unit_price', contentMode:'recent2yr',
  unitThresholds:[20,40,70], totalThresholds:[500,1500,3000], osmZoom:16
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// åœ°åœ–åˆå§‹åŒ–
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initMap(){
  map = L.map('map',{zoomControl:false}).setView([25.033,121.565],13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    maxZoom:19, attribution:'Â© OpenStreetMap'
  }).addTo(map);

  markerClusterGroup = L.markerClusterGroup({
    maxClusterRadius: 55,
    disableClusteringAtZoom: 18,
    spiderfyOnMaxZoom: false,
    showCoverageOnHover: false,
    zoomToBoundsOnClick: true,
    iconCreateFunction: function(cluster) {
      const markers = cluster.getAllChildMarkers();
      let totalCount = 0, totalPrice = 0, totalUnit = 0, validP = 0, validU = 0;
      markers.forEach(m => {
        const gc = m._groupCount || 1;
        totalCount += gc;
        if(m._avgPrice && m._avgPrice > 0){ totalPrice += m._avgPrice * gc; validP += gc; }
        if(m._avgUnitPrice && m._avgUnitPrice > 0){ totalUnit += m._avgUnitPrice * gc; validU += gc; }
      });

      const labels = markers.map(m => m._groupLabel).filter(Boolean);
      const uniqueLabels = [...new Set(labels)];
      const sameComm = uniqueLabels.length === 1;
      const commLabel = sameComm ? uniqueLabels[0].substring(0, 6) : '';

      let sz = 44;
      if(totalCount >= 100) sz = 60;
      else if(totalCount >= 30) sz = 54;
      else if(totalCount >= 10) sz = 48;

      const avgPriceWan = validP > 0 ? (totalPrice / validP / 10000) : 0;
      const avgUnitWan = validU > 0 ? (totalUnit / validU / 10000) : 0;

      let priceText = '';
      if(avgPriceWan >= 10000) priceText = (avgPriceWan/10000).toFixed(1)+'å„„';
      else if(avgPriceWan >= 1) priceText = avgPriceWan.toFixed(0)+'è¬';

      const outerColor = getColorForMode(markerSettings.outerMode, avgPriceWan, avgUnitWan);
      const innerColor = getColorForMode(markerSettings.innerMode, avgPriceWan, avgUnitWan);

      const line1 = priceText || totalCount+'ç­†';
      const line2 = priceText ? totalCount+'ç­†' : '';

      const svgHtml = makeMarkerSVG({sz, outerColor, innerColor, line1, line2});
      const labelHtml = commLabel
        ? `<div style="margin-top:-2px;padding:1px 4px;background:rgba(255,255,255,.92);border-radius:6px;font-size:8px;font-weight:600;color:#333;white-space:nowrap;max-width:70px;overflow:hidden;text-overflow:ellipsis;box-shadow:0 1px 3px rgba(0,0,0,.15);border:1px solid rgba(0,0,0,.08);">${commLabel}</div>`
        : '';

      const totalH = commLabel ? sz + 14 : sz;
      return L.divIcon({
        html: `<div style="display:flex;flex-direction:column;align-items:center;">${svgHtml}${labelHtml}</div>`,
        className: 'price-marker',
        iconSize: [sz + 8, totalH],
        iconAnchor: [(sz+8)/2, totalH/2]
      });
    }
  });
  map.addLayer(markerClusterGroup);
  markerGroup = markerClusterGroup;

  // å¢é›†/ç¾¤çµ„é»æ“Š â†’ å´æ¬„åˆ—è¡¨
  markerClusterGroup.on('clusterclick', function(e){
    const zoom = map.getZoom();
    const mkrs = e.layer.getAllChildMarkers();
    // æ”¶é›†æ‰€æœ‰äº¤æ˜“
    const items = [];
    mkrs.forEach(m => {
      if(m._groupItems) items.push(...m._groupItems);
    });
    if(items.length > 0) showClusterList(items);
  });

  addLegend();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// å–®ä½åˆ‡æ›
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setUnit(u){
  unit = u;
  document.getElementById('btnPing').classList.toggle('active', u==='ping');
  document.getElementById('btnSqm').classList.toggle('active', u==='sqm');
  renderResults();
  renderSummary();
}

function getLocationMode(){
  return map && map.getZoom() >= markerSettings.osmZoom ? 'osm' : 'db';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// æ ¼å¼åŒ–å·¥å…·
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function fmtWan(val){
  if(!val||val<=0) return '-';
  const w = val / 10000;
  if(w >= 10000) return (w/10000).toFixed(2) + 'å„„';
  if(w >= 1) return w.toFixed(w<100?1:0) + 'è¬';
  return val.toLocaleString() + 'å…ƒ';
}

function fmtArea(sqm, ping){
  if(unit==='ping') return (ping||0).toFixed(1) + 'åª';
  return (sqm||0).toFixed(1) + 'mÂ²';
}

function fmtUnitPrice(unitPricePing, unitPriceSqm){
  if(unit==='ping'){
    if(!unitPricePing||unitPricePing<=0) return '-';
    return (unitPricePing / 10000).toFixed(1) + 'è¬/åª';
  } else {
    if(!unitPriceSqm||unitPriceSqm<=0) return '-';
    return (unitPriceSqm / 10000).toFixed(1) + 'è¬/mÂ²';
  }
}

function escHtml(s){
  if(!s) return '';
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
function escAttr(s){
  if(!s) return '';
  return s.replace(/&/g,'&amp;').replace(/'/g,'&#39;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}
function cssId(s){
  return btoa(unescape(encodeURIComponent(s))).replace(/[^a-zA-Z0-9]/g,'_');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Sidebar toggle (æ‰‹æ©Ÿ)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleSidebar(){
  document.getElementById('sidebar').classList.toggle('open');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ç¯©é¸é¢æ¿
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleFilters(){
  const p = document.getElementById('filterPanel');
  const a = document.getElementById('filterArrow');
  const show = !p.classList.contains('show');
  p.classList.toggle('show', show);
  a.textContent = show ? 'â–¼' : 'â–¶';
}

function clearFilters(){
  ['fBuildType','fRooms','fPing','fRatio','fUnitPrice','fPrice','fYear']
    .forEach(id=>{const el=document.getElementById(id); if(el) el.value='';});
  const cb = document.getElementById('fExcludeSpecial'); if(cb) cb.checked=false;
  document.querySelectorAll('.quick-filters button').forEach(b=>b.classList.remove('active'));
}

function quickFilter(mode){
  const nowYear = new Date().getFullYear() - 1911;
  if(mode === '1yr'){
    document.getElementById('fYear').value = `${nowYear-1}-${nowYear}`;
    document.getElementById('qf1yr').classList.add('active');
    document.getElementById('qf2yr').classList.remove('active');
  } else if(mode === '2yr'){
    document.getElementById('fYear').value = `${nowYear-2}-${nowYear}`;
    document.getElementById('qf2yr').classList.add('active');
    document.getElementById('qf1yr').classList.remove('active');
  } else if(mode === 'nospecial'){
    const cb = document.getElementById('fExcludeSpecial');
    cb.checked = !cb.checked;
    document.getElementById('qfNoSpec').classList.toggle('active', cb.checked);
  } else if(mode === 'clear'){
    clearFilters();
    if(txData.length > 0) rerunSearch();
    return;
  }
  if(txData.length > 0) rerunSearch();
}

function getFilterParams(){
  let p = '';
  const bt = document.getElementById('fBuildType').value;
  if(bt) p += '&building_type=' + encodeURIComponent(bt);
  const rm = document.getElementById('fRooms').value.trim();
  if(rm) p += '&rooms=' + encodeURIComponent(rm);
  const pg = document.getElementById('fPing').value.trim();
  if(pg) p += '&ping=' + encodeURIComponent(pg);
  const rt = document.getElementById('fRatio').value.trim();
  if(rt) p += '&public_ratio=' + encodeURIComponent(rt);
  const up = document.getElementById('fUnitPrice').value.trim();
  if(up) p += '&unit_price=' + encodeURIComponent(up);
  const pr = document.getElementById('fPrice').value.trim();
  if(pr) p += '&price=' + encodeURIComponent(pr);
  const yr = document.getElementById('fYear').value.trim();
  if(yr) p += '&year=' + encodeURIComponent(yr);
  const exSp = document.getElementById('fExcludeSpecial');
  if(exSp && exSp.checked) p += '&exclude_special=1';
  return p;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// å‰ç«¯æ’åº
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function sortData(sortType){
  switch(sortType){
    case 'date':
      txData.sort((a,b) => (b.date_raw||'').localeCompare(a.date_raw||''));
      break;
    case 'price':
      txData.sort((a,b) => (b.price||0) - (a.price||0));
      break;
    case 'unit_price':
      txData.sort((a,b) => (b.unit_price_ping||0) - (a.unit_price_ping||0));
      break;
    case 'ping':
      txData.sort((a,b) => (b.area_ping||0) - (a.area_ping||0));
      break;
    case 'public_ratio':
      txData.sort((a,b) => (a.public_ratio||999) - (b.public_ratio||999));
      break;
    case 'community': {
      txData.sort((a,b) => {
        const ca = a.community_name || '';
        const cb = b.community_name || '';
        if(ca && !cb) return -1;
        if(!ca && cb) return 1;
        if(ca !== cb) return ca.localeCompare(cb);
        return (b.date_raw||'').localeCompare(a.date_raw||'');
      });
      break;
    }
  }
}

function setSort(btn){
  document.querySelectorAll('.sort-bar button[data-sort]').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  currentSort = btn.dataset.sort;
  if(txData.length > 0){
    sortData(currentSort);
    renderResults();
    plotMarkers(false);
  }
}

// é™ç­†æ•¸è®Šæ›´æ™‚é‡æ–°æœå°‹
function rerunSearch(){
  if(lastSearchType === 'area') doAreaSearch();
  else if(lastSearchType === 'keyword') doSearch();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// é—œéµå­—æœå°‹
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function doSearch(){
  const kw = document.getElementById('searchInput').value.trim();
  if(!kw){alert('è«‹è¼¸å…¥æœå°‹é—œéµå­—');return;}

  lastSearchType = 'keyword';
  const results = document.getElementById('results');
  results.innerHTML = '<div class="loading">ğŸ” æœå°‹ä¸­â€¦</div>';

  const limitVal = document.getElementById('limitSelect').value;
  const url = '/api/search?keyword=' + encodeURIComponent(kw) +
              '&limit=' + limitVal + '&location_mode=' + getLocationMode() + getFilterParams();
  try{
    const resp = await fetch(url);
    const ctype = resp.headers.get('content-type') || '';
    if(!ctype.includes('application/json')){
      const text = await resp.text();
      results.innerHTML = `<div class="empty">âŒ ä¼ºæœå™¨å›æ‡‰ç•°å¸¸ (HTTP ${resp.status})</div>`;
      console.error('Non-JSON response from /api/search:', text.substring(0, 300));
      return;
    }
    const data = await resp.json();
    if(!data.success){
      results.innerHTML = '<div class="empty">âŒ ' + (data.error||'æœå°‹å¤±æ•—') + '</div>';
      return;
    }
    handleSearchResult(data);
  } catch(e){
    results.innerHTML = '<div class="empty">âŒ ç¶²è·¯éŒ¯èª¤: ' + e.message + '</div>';
    console.error('Search error:', e);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// å€åŸŸæœå°‹ï¼ˆåœ°åœ–å¯è¦–ç¯„åœï¼‰
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function doAreaSearch(){
  const bounds = map.getBounds();
  lastSearchType = 'area';
  const results = document.getElementById('results');
  results.innerHTML = '<div class="loading">ğŸ” æœå°‹æ­¤å€åŸŸæˆäº¤ç´€éŒ„â€¦</div>';

  const limitVal = document.getElementById('limitSelect').value;
  const url = `/api/search_area?south=${bounds.getSouth()}&north=${bounds.getNorth()}&west=${bounds.getWest()}&east=${bounds.getEast()}&limit=${limitVal}&location_mode=${getLocationMode()}` + getFilterParams();

  try{
    const resp = await fetch(url);
    const ctype = resp.headers.get('content-type') || '';
    if(!ctype.includes('application/json')){
      const text = await resp.text();
      results.innerHTML = `<div class="empty">âŒ æœæ­¤å€åŸŸå¤±æ•— (HTTP ${resp.status})<br><span style="font-size:11px;color:#aaa">${escHtml(text.substring(0,80))}</span></div>`;
      console.error('Non-JSON response from /api/search_area:', text.substring(0, 300));
      return;
    }
    const data = await resp.json();
    if(!data.success){
      results.innerHTML = '<div class="empty">âŒ ' + (data.error||'æœå°‹å¤±æ•—') + '</div>';
      return;
    }
    if(!data.transactions || data.transactions.length === 0){
      results.innerHTML = '<div class="empty">ğŸ˜¢ æ­¤å€åŸŸæ²’æœ‰æˆäº¤ç´€éŒ„<br><span style="font-size:12px">è©¦è©¦æ”¾å¤§åœ°åœ–æˆ–ç§»å‹•åˆ°å…¶ä»–å€åŸŸ</span></div>';
      document.getElementById('summaryBar').style.display = 'none';
      markerGroup.clearLayers();
      return;
    }
    handleSearchResult(data, false);
  } catch(e){
    results.innerHTML = '<div class="empty">âŒ æœæ­¤å€åŸŸå¤±æ•—: ' + e.message + '</div>';
    console.error('Area search error:', e);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// çµ±ä¸€è™•ç†æœå°‹çµæœ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function handleSearchResult(data, fitBounds = true){
  txData = data.transactions || [];
  if(txData.length === 0){
    document.getElementById('results').innerHTML = '<div class="empty">ğŸ˜¢ æ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„è³‡æ–™</div>';
    document.getElementById('summaryBar').style.display = 'none';
    markerGroup.clearLayers();
    return;
  }

  window._communityName = data.community_name || null;
  window._searchType = data.search_type || 'address';
  window._summary = data.summary || {};
  communitySummaries = data.community_summaries || {};
  collapsedCommunities = {};

  sortData(currentSort);
  renderResults();
  renderSummary();
  plotMarkers(fitBounds);

  if(window.innerWidth <= 768){
    document.getElementById('sidebar').classList.remove('open');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// æ¸²æŸ“çµæœåˆ—è¡¨ â€” å»ºæ¡ˆåˆ†çµ„ + æ”¹å–„å¡ç‰‡
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderResults(){
  const container = document.getElementById('results');

  // æŒ‰å»ºæ¡ˆåˆ†çµ„
  const groups = [];
  const communityMap = {};
  const noComItems = [];

  txData.forEach((tx, i) => {
    const cn = tx.community_name || '';
    if(cn){
      if(!(cn in communityMap)){
        communityMap[cn] = groups.length;
        groups.push({name: cn, items: []});
      }
      groups[communityMap[cn]].items.push({tx, origIdx: i});
    } else {
      noComItems.push({tx, origIdx: i});
    }
  });

  let html = '';

  // å…¨å±€å»ºæ¡ˆåç¨±ï¼ˆå–®ä¸€å»ºæ¡ˆæœå°‹æ™‚ï¼‰
  if(window._communityName && groups.length <= 1 && window._searchType !== 'area'){
    html += `<div style="padding:10px 12px;background:#e8f5e9;border-bottom:1px solid #c8e6c9">
      <span style="font-weight:700;font-size:14px;color:#2e7d32">ğŸ˜ï¸ ${escHtml(window._communityName)}</span>
    </div>`;
  }

  // æœ‰å»ºæ¡ˆçš„ç¾¤çµ„
  groups.forEach(group => {
    const cn = group.name;
    const isCollapsed = collapsedCommunities[cn] === true;
    const stats = communitySummaries[cn] || computeLocalStats(group.items);

    html += `<div class="community-group">`;
    const inlineStats = stats
      ? [
          stats.avg_unit_price_ping > 0 ? `å‡å–® ${(stats.avg_unit_price_ping/10000).toFixed(0)}è¬/åª` : '',
          stats.avg_ping > 0 ? `å‡åª ${stats.avg_ping.toFixed(0)}åª` : '',
          stats.avg_ratio > 0 ? `å…¬è¨­ ${stats.avg_ratio.toFixed(0)}%` : '',
        ].filter(Boolean)
      : [];
    html += `<div class="community-header" onclick="toggleCommunity(this, '${escAttr(cn)}')">
      <span class="ch-arrow ${isCollapsed?'':'open'}">â–¶</span>
      <div style="flex:1;min-width:0">
        <div class="ch-name">${escHtml(cn)}</div>
        ${inlineStats.length ? `<div class="ch-stats-inline">${inlineStats.map(s=>`<span>${s}</span>`).join('')}</div>` : ''}
      </div>
      <span class="ch-count">${group.items.length} ç­†</span>
    </div>`;

    // å»ºæ¡ˆçµ±è¨ˆé¢æ¿
    if(stats){
      html += `<div class="community-stats" id="cstats-${cssId(cn)}" style="${isCollapsed?'display:none':''}">
        <div class="cs-item"><span class="cs-label">ğŸ“Š äº¤æ˜“ç­†æ•¸</span><span class="cs-value">${group.items.length} ç­†</span></div>
        <div class="cs-item"><span class="cs-label">ğŸ’° å‡ç¸½åƒ¹</span><span class="cs-value">${fmtWan(stats.avg_price)}</span></div>
        <div class="cs-item"><span class="cs-label">ğŸ“ˆ å‡å–®åƒ¹</span><span class="cs-value">${stats.avg_unit_price_ping > 0 ? (stats.avg_unit_price_ping/10000).toFixed(1)+'è¬/åª' : '-'}</span></div>
        <div class="cs-item"><span class="cs-label">ğŸ“ å‡åªæ•¸</span><span class="cs-value">${stats.avg_ping > 0 ? stats.avg_ping.toFixed(1)+'åª' : '-'}</span></div>
        <div class="cs-item"><span class="cs-label">ğŸ—ï¸ å…¬è¨­æ¯”</span><span class="cs-value" style="color:${stats.avg_ratio>35?'var(--red)':stats.avg_ratio>30?'var(--orange)':'var(--green)'}">${stats.avg_ratio > 0 ? stats.avg_ratio.toFixed(1)+'%' : '-'}</span></div>
      </div>`;
    }

    html += `<div class="community-items ${isCollapsed?'collapsed':''}" id="citems-${cssId(cn)}" style="${isCollapsed?'max-height:0':'max-height:999999px'}">`;
    group.items.forEach(item => {
      html += renderTxCard(item.tx, item.origIdx, true);
    });
    html += `</div></div>`;
  });

  // ç„¡å»ºæ¡ˆäº¤æ˜“
  if(noComItems.length > 0){
    if(groups.length > 0){
      html += `<div style="padding:8px 12px;background:#f5f5f5;border-bottom:1px solid #e0e0e0;font-size:12px;color:var(--text2);font-weight:600">å…¶ä»–äº¤æ˜“ (${noComItems.length} ç­†)</div>`;
    }
    noComItems.forEach(item => {
      html += renderTxCard(item.tx, item.origIdx, false);
    });
  }

  if(!html) html = '<div class="empty">æ²’æœ‰è³‡æ–™</div>';
  container.innerHTML = html;
}

function renderTxCard(tx, idx, inGroup){
  const isActive = idx === activeCardIdx;
  const cn = tx.community_name || '';

  // æ ¹æ“šå–®åƒ¹æ±ºå®šè‰²æ¢æ¨£å¼
  const upWan = (tx.unit_price_ping||0) / 10000;
  let priceClass = '';
  if(upWan > 100) priceClass = ' price-high';
  else if(upWan > 50) priceClass = ' price-mid';
  else if(upWan > 0) priceClass = ' price-low';

  // å»ºæ¡ˆæ¨™ç±¤ï¼šéç¾¤çµ„å…§æ°¸é é¡¯ç¤ºï¼›ç¾¤çµ„å…§ä¹Ÿé¡¯ç¤ºï¼ˆè¼ƒå°æ¨£å¼ï¼‰
  const cnTag = cn
    ? `<span class="tx-community-tag" title="${escAttr(cn)}">${escHtml(cn)}</span>`
    : '';
  const cnRow = cnTag ? `<div class="tx-community-row">${cnTag}</div>` : '';

  const specialCls = tx.is_special ? ' special' : '';
  const specialBadge = tx.is_special ? '<span class="special-badge">ç‰¹æ®Š</span>' : '';
  const parkingTag = tx.has_parking
    ? `<span class="tx-parking-tag">ğŸš— å«è»Šä½${tx.parking_price > 0 ? ' ' + fmtWan(tx.parking_price) : ''}</span>`
    : '';

  return `<div class="tx-card${isActive?' active':''}${priceClass}${specialCls}" onclick="selectTx(${idx})" data-idx="${idx}">
    <div class="tx-addr" title="${escAttr(tx.address)}">${escHtml(tx.address)}${specialBadge}</div>
    ${cnRow}
    <div class="tx-detail-row">
      <span>ğŸ“… ${tx.date||'-'}</span>
      <span>ğŸ“ ${fmtArea(tx.area_sqm, tx.area_ping)}</span>
      <span>${tx.rooms||0}æˆ¿${tx.halls||0}å»³${tx.baths||0}è¡›</span>
      ${tx.floor ? `<span>ğŸ¢ ${escHtml(String(tx.floor))}F/${escHtml(String(tx.total_floors))}F</span>` : ''}
      ${tx.public_ratio>0 ? `<span class="tag">å…¬è¨­${tx.public_ratio}%</span>` : ''}
      ${tx.building_type ? `<span class="tag">${escHtml(tx.building_type)}</span>` : ''}
      ${parkingTag}
      ${tx.note ? `<span style="color:#888;font-size:10px">ğŸ“ ${escHtml(tx.note.length>30?tx.note.substring(0,30)+'â€¦':tx.note)}</span>` : ''}
    </div>
    <div class="tx-price-col">
      <div class="tx-unit">${fmtUnitPrice(tx.unit_price_ping, tx.unit_price_sqm)}</div>
      <div class="tx-price">${fmtWan(tx.price)}</div>
    </div>
  </div>`;
}

// å‰ç«¯è¨ˆç®—å»ºæ¡ˆçµ±è¨ˆï¼ˆå¾Œç«¯æ²’æä¾›æ™‚ï¼‰
function computeLocalStats(items){
  if(!items||items.length===0) return null;
  let prices=[],ups=[],pings=[],ratios=[];
  items.forEach(({tx})=>{
    if(tx.price>0) prices.push(tx.price);
    if(tx.unit_price_ping>0) ups.push(tx.unit_price_ping);
    if(tx.area_ping>0) pings.push(tx.area_ping);
    if(tx.public_ratio>0) ratios.push(tx.public_ratio);
  });
  const avg = arr => arr.length ? arr.reduce((a,b)=>a+b,0)/arr.length : 0;
  return {
    count: items.length,
    avg_price: Math.round(avg(prices)),
    avg_unit_price_ping: avg(ups),
    avg_ping: avg(pings),
    avg_ratio: avg(ratios),
  };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// å»ºæ¡ˆæŠ˜ç–Š/å±•é–‹
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleCommunity(headerEl, name){
  const isNowCollapsed = !collapsedCommunities[name];
  collapsedCommunities[name] = isNowCollapsed;

  const itemsEl = document.getElementById('citems-' + cssId(name));
  const statsEl = document.getElementById('cstats-' + cssId(name));
  const arrow = headerEl.querySelector('.ch-arrow');

  if(itemsEl){
    if(isNowCollapsed){
      itemsEl.classList.add('collapsed');
      itemsEl.style.maxHeight = '0';
    } else {
      itemsEl.classList.remove('collapsed');
      itemsEl.style.maxHeight = '999999px';
    }
  }
  if(statsEl){
    statsEl.style.display = isNowCollapsed ? 'none' : '';
  }
  if(arrow){
    arrow.classList.toggle('open', !isNowCollapsed);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// æ¸²æŸ“çµ±è¨ˆæ‘˜è¦
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderSummary(){
  const s = window._summary;
  if(!s || !s.total){
    document.getElementById('summaryBar').style.display = 'none';
    return;
  }
  const bar = document.getElementById('summaryBar');
  bar.style.display = 'block';

  const avgUp = unit==='ping' ? fmtUnitPrice(s.avg_unit_price_ping, 0) : fmtUnitPrice(0, s.avg_unit_price_ping / 3.30579);
  const minUp = unit==='ping' ? fmtUnitPrice(s.min_unit_price_ping, 0) : fmtUnitPrice(0, s.min_unit_price_ping / 3.30579);
  const maxUp = unit==='ping' ? fmtUnitPrice(s.max_unit_price_ping, 0) : fmtUnitPrice(0, s.max_unit_price_ping / 3.30579);

  const comCount = Object.keys(communitySummaries).length;
  const comInfo = comCount > 0 ? ` ï½œ <span class="val">${comCount}</span> å€‹å»ºæ¡ˆ` : '';

  bar.innerHTML = `
    å…± <span class="val">${s.total}</span> ç­†${comInfo} ï½œ
    å‡åƒ¹ <span class="val">${fmtWan(s.avg_price)}</span> ï½œ
    å‡åª <span class="val">${s.avg_ping}åª</span> ï½œ
    å–®åƒ¹ <span class="val">${avgUp}</span>
    <br>
    å–®åƒ¹å€é–“ <span class="val">${minUp}</span> ~ <span class="val">${maxUp}</span> ï½œ
    å‡å…¬è¨­ <span class="val">${s.avg_ratio||'-'}%</span>
  `;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// åœ°åœ– marker â€” å»ºæ¡ˆ/åœ°å€ç¾¤çµ„åŒ–
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// æŠŠåœ°å€çš„æ¨“å±¤è³‡è¨Šå»æ‰ï¼Œå–ã€Œæ£Ÿã€çš„ key
function baseAddress(addr){
  if(!addr) return '';
  return addr.replace(/\d+æ¨“.*$/, '').replace(/\d+F.*$/i, '').replace(/åœ°ä¸‹.*$/, '');
}

function stripCityJS(addr){
  if(!addr) return '';
  return addr.replace(/^(?:(?:å°|è‡º)(?:åŒ—|ä¸­|å—|æ±)å¸‚|(?:æ–°åŒ—|æ¡ƒåœ’|é«˜é›„|åŸºéš†|æ–°ç«¹|å˜‰ç¾©)[å¸‚ç¸£]|.{2,3}ç¸£)/, '');
}

/**
 * å°‡ txData åˆ†çµ„ï¼š
 *   Phase 1 â€” æŒ‰ç¤¾å€åæˆ–åŒæ£Ÿåœ°å€åˆ†çµ„
 *   Phase 2 â€” è¨ˆç®—å„çµ„ä¸­å¿ƒåº§æ¨™ï¼ˆä¸­ä½æ•¸ï¼‰
 *   Phase 3 â€” è¿‘è·é›¢åˆä½µï¼ˆâ‰ˆ28m Union-Findï¼‰ï¼Œè§£æ±ºä¸åŒç¤¾å€/åœ°å€åœ¨åŒåº§æ¨™é‡ç–Š
 * å›å‚³: [{label, items:[{tx, origIdx}], lats, lngs, prices, unitPrices}, ...]
 */
function buildGroups(){
  // â”€â”€ Phase 1: æŒ‰ç¤¾å€å/åœ°å€æ–‡å­—åˆ†çµ„ â”€â”€
  const raw = {};
  txData.forEach((tx, idx) => {
    if(!tx.lat || !tx.lng) return;
    let key;
    if(tx.community_name){
      key = 'c:' + tx.community_name;
    } else {
      key = 'a:' + baseAddress(tx.address_raw || tx.address);
    }
    if(!raw[key]){
      raw[key] = {
        label: tx.community_name || stripCityJS(baseAddress(tx.address)),
        items: [], lats: [], lngs: [],
        prices: [], unitPrices: [],
      };
    }
    const g = raw[key];
    g.items.push({tx, origIdx: idx});
    g.lats.push(tx.lat);
    g.lngs.push(tx.lng);
    if(tx.price > 0) g.prices.push(tx.price);
    if(tx.unit_price_ping > 0) g.unitPrices.push(tx.unit_price_ping);
  });

  // â”€â”€ Phase 2: å„çµ„ä¸­å¿ƒï¼ˆä¸­ä½æ•¸ï¼‰â”€â”€
  const arr = Object.values(raw);
  const len = arr.length;
  arr.forEach(g => {
    const sLat = g.lats.slice().sort((a,b)=>a-b);
    const sLng = g.lngs.slice().sort((a,b)=>a-b);
    const m = Math.floor(sLat.length / 2);
    g._cLat = sLat[m];
    g._cLng = sLng[m];
  });

  // â”€â”€ Phase 3: Union-Find è¿‘è·é›¢åˆä½µï¼ˆâ‰ˆ28m å…§è¦–ç‚ºåŒä½ç½®ï¼‰â”€â”€
  //    0.00025Â° â‰ˆ 28m(lat) / 25m(lng) @ 25Â°N
  const MERGE = 0.00025;
  const par = Array.from({length: len}, (_, i) => i);
  function find(x){ while(par[x]!==x){ par[x]=par[par[x]]; x=par[x]; } return x; }
  for(let i = 0; i < len; i++)
    for(let j = i+1; j < len; j++)
      if(Math.abs(arr[i]._cLat - arr[j]._cLat) < MERGE &&
         Math.abs(arr[i]._cLng - arr[j]._cLng) < MERGE)
        par[find(i)] = find(j);

  // æ”¶é›†åˆä½µçµæœ
  const buckets = {};
  for(let i = 0; i < len; i++){
    const r = find(i);
    if(!buckets[r]) buckets[r] = [];
    buckets[r].push(arr[i]);
  }

  // â”€â”€ Phase 4: ç”Ÿæˆæœ€çµ‚ç¾¤çµ„ â”€â”€
  const merged = Object.values(buckets).map(gs => {
    if(gs.length === 1) return gs[0];
    // åˆä½µå¤šå€‹é‡ç–Šç¾¤çµ„
    const m = { items:[], lats:[], lngs:[], prices:[], unitPrices:[] };
    const lbls = [];
    gs.forEach(g => {
      m.items.push(...g.items);
      m.lats.push(...g.lats);
      m.lngs.push(...g.lngs);
      m.prices.push(...g.prices);
      m.unitPrices.push(...g.unitPrices);
      if(g.label) lbls.push(g.label);
    });
    const ul = [...new Set(lbls)];
    if(ul.length <= 1) m.label = ul[0] || '';
    else if(ul.length === 2) m.label = ul.join('Â·');
    else m.label = ul[0] + 'ç­‰' + ul.length + 'æ¡ˆ';
    return m;
  });

  if(merged.length !== arr.length)
    console.log(`ğŸ“ ç¾¤çµ„åˆä½µ: ${arr.length} â†’ ${merged.length}ï¼ˆ${arr.length - merged.length} å€‹é‡ç–Šç¾¤çµ„è¢«åˆä½µï¼‰`);

  // â”€â”€ Phase 5: è¿‘å…©å¹´åˆ†æï¼ˆæ’é™¤ç‰¹æ®Šäº¤æ˜“ï¼‰â”€â”€
  const nowYear = new Date().getFullYear() - 1911;
  const twoYearThreshold = (nowYear - 2) * 10000;
  merged.forEach(g => {
    const recent = g.items.filter(({tx}) => {
      if(tx.is_special) return false;
      const dr = parseInt(String(tx.date_raw||'0').replace(/\D/g,''),10);
      return dr >= twoYearThreshold;
    });
    const rPrices = recent.map(({tx})=>tx.price).filter(v=>v>0);
    const rUnits = recent.map(({tx})=>tx.unit_price_ping).filter(v=>v>0);
    g.recentCount = recent.length;
    g.recentAvgPrice = rPrices.length ? rPrices.reduce((a,b)=>a+b,0)/rPrices.length : 0;
    g.recentAvgUnitPrice = rUnits.length ? rUnits.reduce((a,b)=>a+b,0)/rUnits.length : 0;
  });

  return merged;
}

function getUnitPriceColor(wan){
  if(wan <= 0) return '#888';
  const t = markerSettings.unitThresholds;
  if(wan >= t[2]) return '#b71c1c';
  if(wan >= t[1]) return '#e65100';
  if(wan >= t[0]) return '#f57f17';
  return '#1b5e20';
}

function getTotalPriceColor(wan){
  if(wan <= 0) return '#888';
  const t = markerSettings.totalThresholds;
  if(wan >= t[2]) return '#b71c1c';
  if(wan >= t[1]) return '#e65100';
  if(wan >= t[0]) return '#f57f17';
  return '#1b5e20';
}

function getColorForMode(mode, avgPriceWan, avgUnitWan){
  if(mode === 'total_price') return getTotalPriceColor(avgPriceWan);
  return getUnitPriceColor(avgUnitWan);
}

function makeMarkerSVG({sz, outerColor, innerColor, line1, line2, fontSz1, fontSz2}){
  const cx = sz/2, cy = sz/2;
  const outerR = sz/2 - 1;
  const ringW = Math.max(4, Math.floor(sz * 0.1));
  const innerR = outerR - ringW - 1.5;
  const hasTwo = line1 && line2;
  const y1 = hasTwo ? cy - 4 : cy;
  const y2 = cy + 7;
  const fs1 = fontSz1 || (sz >= 54 ? 11 : 10);
  const fs2 = fontSz2 || (sz >= 54 ? 9 : 8);
  return `<svg xmlns="http://www.w3.org/2000/svg" width="${sz}" height="${sz}">
    <circle cx="${cx}" cy="${cy}" r="${outerR}" fill="${outerColor}" stroke="rgba(255,255,255,.9)" stroke-width="2"/>
    <circle cx="${cx}" cy="${cy}" r="${innerR}" fill="${innerColor}" stroke="rgba(255,255,255,.5)" stroke-width="1.5"/>
    ${line1?`<text x="${cx}" y="${y1}" text-anchor="middle" dominant-baseline="central" fill="#fff" font-size="${fs1}" font-weight="700" font-family="Arial,sans-serif" style="paint-order:stroke" stroke="rgba(0,0,0,.25)" stroke-width=".8">${line1}</text>`:''}
    ${line2?`<text x="${cx}" y="${y2}" text-anchor="middle" dominant-baseline="central" fill="rgba(255,255,255,.95)" font-size="${fs2}" font-weight="600" font-family="Arial,sans-serif" style="paint-order:stroke" stroke="rgba(0,0,0,.2)" stroke-width=".6">${line2}</text>`:''}
  </svg>`;
}

function plotMarkers(fitBounds = true){
  markerClusterGroup.clearLayers();
  const boundsArr = [];
  const groups = buildGroups();

  groups.forEach(g => {
    const n = g.items.length;
    const sortedLats = g.lats.slice().sort((a,b)=>a-b);
    const sortedLngs = g.lngs.slice().sort((a,b)=>a-b);
    const mid = Math.floor(sortedLats.length / 2);
    const lat = sortedLats[mid];
    const lng = sortedLngs[mid];

    // é¸æ“‡è³‡æ–™ä¾†æºï¼šè¿‘å…©å¹´ or å…¨éƒ¨
    const useRecent = markerSettings.contentMode === 'recent2yr' && g.recentCount > 0;
    const avgPrice = useRecent ? g.recentAvgPrice : (g.prices.length ? g.prices.reduce((a,b)=>a+b,0)/g.prices.length : 0);
    const avgUnitPrice = useRecent ? g.recentAvgUnitPrice : (g.unitPrices.length ? g.unitPrices.reduce((a,b)=>a+b,0)/g.unitPrices.length : 0);

    const avgPriceWan = avgPrice / 10000;
    const avgUnitWan = avgUnitPrice / 10000;

    const outerColor = getColorForMode(markerSettings.outerMode, avgPriceWan, avgUnitWan);
    const innerColor = getColorForMode(markerSettings.innerMode, avgPriceWan, avgUnitWan);
    const label = g.label ? g.label.substring(0, 8) : '';

    // åƒ¹æ ¼æ–‡å­—
    let priceText = '';
    if(avgPriceWan >= 10000) priceText = (avgPriceWan/10000).toFixed(1)+'å„„';
    else if(avgPriceWan >= 1) priceText = Math.round(avgPriceWan)+'è¬';
    else priceText = '-';

    // å°ºå¯¸
    let sz = n >= 20 ? 56 : (n >= 5 ? 50 : 44);
    if(n === 1) sz = 42;

    // è¡Œæ–‡å­—ï¼šåƒ¹éŒ¢åœ¨ä¸Šé¢ï¼Œç­†æ•¸åœ¨ä¸‹é¢
    let line1, line2;
    if(n === 1){
      line1 = priceText;
      line2 = '';
    } else {
      line1 = priceText;
      line2 = n + 'ç­†';
    }

    const svgHtml = makeMarkerSVG({sz, outerColor, innerColor, line1, line2});
    const labelHtml = label
      ? `<div style="margin-top:-2px;padding:1px 5px;background:rgba(255,255,255,.95);border-radius:6px;font-size:${n>1?9:8}px;font-weight:700;color:#333;white-space:nowrap;max-width:80px;overflow:hidden;text-overflow:ellipsis;box-shadow:0 1px 3px rgba(0,0,0,.15);border:1px solid rgba(0,0,0,.08);">${escHtml(label)}</div>` : '';
    const totalH = label ? sz + 15 : sz;

    const icon = L.divIcon({
      html: `<div style="display:flex;flex-direction:column;align-items:center;">${svgHtml}${labelHtml}</div>`,
      iconSize: [sz+8, totalH],
      iconAnchor: [(sz+8)/2, totalH/2],
      className: 'price-marker'
    });

    const marker = L.marker([lat, lng], {icon});
    marker._groupCount = n;
    marker._avgPrice = avgPrice;
    marker._avgUnitPrice = avgUnitPrice;
    marker._groupLabel = g.label;
    marker._groupItems = g.items;

    if(n === 1){
      const tx = g.items[0].tx;
      const origIdx = g.items[0].origIdx;
      marker.bindPopup(makePopup(tx), {maxWidth:320});
      marker.on('click', () => {
        activeCardIdx = origIdx;
        renderResults();
        const card = document.querySelector(`.tx-card[data-idx="${origIdx}"]`);
        if(card) card.scrollIntoView({behavior:'smooth', block:'center'});
      });
    } else {
      marker.on('click', () => showClusterList(g.items));
    }

    markerClusterGroup.addLayer(marker);
    boundsArr.push([lat, lng]);
  });

  if(fitBounds && boundsArr.length > 0){
    map.fitBounds(boundsArr, {padding:[40,40], maxZoom:16});
  }
}

function makePopup(tx){
  const cn = tx.community_name
    ? `<div style="background:#e8f5e9;padding:2px 8px;border-radius:8px;display:inline-block;color:#2e7d32;font-size:12px;font-weight:600;margin-bottom:4px">ğŸ˜ï¸ ${escHtml(tx.community_name)}</div><br>`
    : '';
  return `<div style="font-size:13px;line-height:1.6">
    ${cn}
    <b>${escHtml(tx.address)}</b><br>
    ğŸ“… ${tx.date||'-'} ï½œ ğŸ“ ${fmtArea(tx.area_sqm, tx.area_ping)}<br>
    ğŸ’° <b style="color:#ea4335">${fmtWan(tx.price)}</b>
    <span style="color:#666">${fmtUnitPrice(tx.unit_price_ping, tx.unit_price_sqm)}</span><br>
    ğŸ¢ ${tx.rooms||0}æˆ¿${tx.halls||0}å»³${tx.baths||0}è¡›
    ${tx.floor?'ï½œ '+tx.floor+'F/'+tx.total_floors+'F':''}
    ${tx.public_ratio>0?'ï½œ å…¬è¨­'+tx.public_ratio+'%':''}
    ${tx.building_type?'<br>'+escHtml(tx.building_type):''}
    ${tx.has_parking?'<br>ğŸš— å«è»Šä½ '+fmtWan(tx.parking_price):''}
    ${tx.note?'<br><span style="color:#888;font-size:11px">'+escHtml(tx.note)+'</span>':''}
  </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// é¸å–äº¤æ˜“
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function selectTx(idx){
  activeCardIdx = idx;
  renderResults();
  const tx = txData[idx];
  if(tx && tx.lat && tx.lng){
    map.setView([tx.lat, tx.lng], 17);
    // æ‰¾åˆ°åŒ…å«æ­¤äº¤æ˜“çš„ç¾¤çµ„ marker
    markerClusterGroup.eachLayer(layer => {
      if(layer._groupItems && layer._groupItems.some(it => it.origIdx === idx)){
        markerClusterGroup.zoomToShowLayer(layer, () => {
          if(layer._groupItems.length === 1) layer.openPopup();
        });
      }
    });
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// åœ–ä¾‹
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addLegend(){
  const legend = L.control({position: 'bottomleft'});
  legend.onAdd = function(){
    const div = L.DomUtil.create('div','');
    div.innerHTML = `
      <div style="background:#fff;padding:10px 12px;border-radius:10px;box-shadow:0 2px 12px rgba(0,0,0,.15);font-size:11px;line-height:1.8;min-width:170px">
        <div style="font-weight:700;margin-bottom:4px;font-size:12px">ğŸ¯ é›™åœˆè‰²å½©åœ–ä¾‹</div>
        <div style="font-weight:600;font-size:10px;color:#1a73e8;margin-bottom:2px">â— å¤–ç’°ï¼ç¸½åƒ¹ ï½œ â— å…§åœˆï¼å–®åƒ¹/åª</div>
        <div style="display:flex;align-items:center;gap:6px"><svg width="18" height="18"><circle cx="9" cy="9" r="8" fill="#1b5e20" stroke="#fff" stroke-width="1.5"/><circle cx="9" cy="9" r="5" fill="#1b5e20"/></svg><span>ä½ï¼ˆï¼œ500è¬/ï¼œ20è¬ï¼‰</span></div>
        <div style="display:flex;align-items:center;gap:6px"><svg width="18" height="18"><circle cx="9" cy="9" r="8" fill="#f57f17" stroke="#fff" stroke-width="1.5"/><circle cx="9" cy="9" r="5" fill="#f57f17"/></svg><span>ä¸­ï¼ˆ500-1500/20-40è¬ï¼‰</span></div>
        <div style="display:flex;align-items:center;gap:6px"><svg width="18" height="18"><circle cx="9" cy="9" r="8" fill="#e65100" stroke="#fff" stroke-width="1.5"/><circle cx="9" cy="9" r="5" fill="#e65100"/></svg><span>ä¸­é«˜ï¼ˆ1500-3000/40-70è¬ï¼‰</span></div>
        <div style="display:flex;align-items:center;gap:6px"><svg width="18" height="18"><circle cx="9" cy="9" r="8" fill="#b71c1c" stroke="#fff" stroke-width="1.5"/><circle cx="9" cy="9" r="5" fill="#b71c1c"/></svg><span>é«˜ï¼ˆï¼3000è¬/ï¼70è¬ï¼‰</span></div>
        <div style="font-weight:600;margin-top:6px;font-size:10px;color:#555">ğŸ“Š åœˆå…§ï¼è¿‘2å¹´å‡åƒ¹(æ’é™¤ç‰¹æ®Š)</div>
        <div style="font-size:10px;color:#999">âš™ï¸ é»å³ä¸Šè§’è¨­å®šå¯è‡ªè¨‚é¡è‰²</div>
      </div>`;
    L.DomEvent.disableScrollPropagation(div);
    L.DomEvent.disableClickPropagation(div);
    return div;
  };
  legend.addTo(map);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GPS å®šä½
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function locateMe(){
  if(!navigator.geolocation){
    alert('æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´å®šä½åŠŸèƒ½');
    return;
  }
  const btn = document.querySelector('.map-controls button[title="ç§»å‹•åˆ°æˆ‘çš„ä½ç½®"]');
  if(btn){ btn.style.background='#e3f2fd'; btn.innerHTML='â³'; }

  navigator.geolocation.getCurrentPosition(
    pos => {
      const {latitude:lat, longitude:lng, accuracy} = pos.coords;
      map.setView([lat, lng], 16);

      // ç§»é™¤èˆŠæ¨™è¨˜
      if(locationMarker){ map.removeLayer(locationMarker); }
      if(locationCircle){ map.removeLayer(locationCircle); }

      locationCircle = L.circle([lat, lng], {
        radius: accuracy, color:'#1a73e8', fillColor:'#1a73e8',
        fillOpacity:0.1, weight:1
      }).addTo(map);

      locationMarker = L.marker([lat, lng], {
        icon: L.divIcon({
          html:'<div class="locate-pulse"></div>',
          iconSize:[16,16], className:''
        }),
        zIndexOffset: 1000
      }).addTo(map)
       .bindPopup(`ğŸ“ æ‚¨çš„ä½ç½®<br><span style="font-size:11px;color:#666">ç²¾ç¢ºåº¦: Â±${Math.round(accuracy)}m</span>`)
       .openPopup();

      setTimeout(() => { if(locationCircle) map.removeLayer(locationCircle); locationCircle=null; }, 5000);
      if(btn){ btn.style.background=''; btn.innerHTML='ğŸ“'; }
    },
    err => {
      alert('å®šä½å¤±æ•—: ' + err.message);
      if(btn){ btn.style.background=''; btn.innerHTML='ğŸ“'; }
    },
    {enableHighAccuracy:true, timeout:10000}
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// å¢é›†åˆ—è¡¨é¢æ¿
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showClusterList(items){
  const container = document.getElementById('results');

  // ç¤¾å€/å»ºæ¡ˆåˆ†çµ„
  const comGroups = {};
  items.forEach(it => {
    const cn = it.tx.community_name || 'æœªçŸ¥å»ºæ¡ˆ';
    if(!comGroups[cn]) comGroups[cn] = [];
    comGroups[cn].push(it);
  });
  const comList = Object.entries(comGroups).sort((a,b)=>b[1].length-a[1].length);

  let html = `<div class="cluster-list-header">
    <span>ğŸ“ æ­¤ä½ç½® ${items.length} ç­†é‡ç–Šè³‡æ–™</span>
    <button onclick="renderResults()">â†© è¿”å›å…¨åˆ—è¡¨</button>
  </div>`;

  comList.forEach(([cn, comItems]) => {
    html += `<div style="padding:6px 12px;background:var(--card-bg);border-bottom:1px solid var(--border);font-weight:600;font-size:13px;color:var(--text1)">ğŸ˜ï¸ ${escHtml(cn)}ï¼ˆ${comItems.length}ç­†ï¼‰</div>`;
    comItems.forEach(({tx, origIdx}) => {
      html += renderTxCard(tx, origIdx, false);
    });
  });

  container.innerHTML = html;
  if(window.innerWidth <= 768){
    document.getElementById('sidebar').classList.add('open');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// è¨­å®šé¢æ¿
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleSettings(){
  const panel = document.getElementById('settingsPanel');
  const overlay = document.getElementById('settingsOverlay');
  const isOpen = panel.classList.contains('open');
  panel.classList.toggle('open', !isOpen);
  overlay.classList.toggle('show', !isOpen);
}

function applySettings(){
  markerSettings.outerMode = document.getElementById('sOuter').value;
  markerSettings.innerMode = document.getElementById('sInner').value;
  markerSettings.contentMode = document.getElementById('sContent').value;
  markerSettings.unitThresholds = [
    parseFloat(document.getElementById('sUnitT1').value) || 20,
    parseFloat(document.getElementById('sUnitT2').value) || 40,
    parseFloat(document.getElementById('sUnitT3').value) || 70
  ];
  markerSettings.totalThresholds = [
    parseFloat(document.getElementById('sTotalT1').value) || 500,
    parseFloat(document.getElementById('sTotalT2').value) || 1500,
    parseFloat(document.getElementById('sTotalT3').value) || 3000
  ];
  markerSettings.osmZoom = parseInt(document.getElementById('sOsmZoom').value) || 16;
  // åŒæ­¥ç´…è‰²é–€æª»é¡¯ç¤º
  document.getElementById('sUnitT3r').value = markerSettings.unitThresholds[2];
  document.getElementById('sTotalT3r').value = markerSettings.totalThresholds[2];
  try{ localStorage.setItem('markerSettings', JSON.stringify(markerSettings)); }catch(e){}
  if(txData.length > 0) plotMarkers(false);
}

function loadSettings(){
  try{
    const saved = localStorage.getItem('markerSettings');
    if(saved){
      const s = JSON.parse(saved);
      markerSettings = {...markerSettings, ...s};
    }
    document.getElementById('sOuter').value = markerSettings.outerMode;
    document.getElementById('sInner').value = markerSettings.innerMode;
    document.getElementById('sContent').value = markerSettings.contentMode;
    const ut = markerSettings.unitThresholds || [20,40,70];
    const tt = markerSettings.totalThresholds || [500,1500,3000];
    document.getElementById('sUnitT1').value = ut[0];
    document.getElementById('sUnitT2').value = ut[1];
    document.getElementById('sUnitT3').value = ut[2];
    document.getElementById('sUnitT3r').value = ut[2];
    document.getElementById('sTotalT1').value = tt[0];
    document.getElementById('sTotalT2').value = tt[1];
    document.getElementById('sTotalT3').value = tt[2];
    document.getElementById('sTotalT3r').value = tt[2];
    document.getElementById('sOsmZoom').value = markerSettings.osmZoom || 16;
  }catch(e){}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// åˆå§‹åŒ–
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('DOMContentLoaded', () => {
  loadSettings();
  initMap();
  // æ‰‹æ©Ÿï¼šé»æ“Šåœ°åœ–æ™‚è‡ªå‹•æ”¶åˆå´æ¬„
  if(window.innerWidth <= 768){
    map.on('click', () => {
      document.getElementById('sidebar').classList.remove('open');
    });
  }
});
</script>
</body>
</html>
