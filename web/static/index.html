<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>è‰¯å¯Œå±…åœ°ç”¢</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.1/dist/MarkerCluster.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.1/dist/MarkerCluster.Default.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.1/dist/leaflet.markercluster.js"></script>
<style>
/* ========== å…¨åŸŸ ========== */
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --primary:#1a73e8;--primary-dark:#1558b0;--bg:#f5f7fa;
  --card:#fff;--text:#222;--text2:#555;--border:#ddd;
  --green:#34a853;--red:#ea4335;--orange:#f9ab00;
  --sidebar-w:420px;--header-h:54px;
}
html,body{height:100%;font-family:'Segoe UI','Microsoft JhengHei',sans-serif;background:var(--bg);color:var(--text)}

/* ========== HEADER ========== */
.header{
  position:fixed;top:0;left:0;right:0;height:var(--header-h);
  background:var(--primary);color:#fff;display:flex;align-items:center;
  padding:0 16px;z-index:1100;gap:12px;
}
.header .logo{font-size:20px;font-weight:700;white-space:nowrap}
.header .unit-toggle{
  margin-left:auto;display:flex;gap:4px;background:rgba(255,255,255,.15);
  border-radius:20px;padding:2px;
}
.header .unit-toggle button{
  border:none;background:transparent;color:rgba(255,255,255,.7);
  padding:5px 14px;border-radius:18px;cursor:pointer;font-size:13px;
  transition:.2s;
}
.header .unit-toggle button.active{background:#fff;color:var(--primary);font-weight:600}
.hamburger{display:none;background:none;border:none;color:#fff;font-size:24px;cursor:pointer}

/* ========== SIDEBAR ========== */
.sidebar{
  position:fixed;top:var(--header-h);left:0;bottom:0;
  width:var(--sidebar-w);background:var(--card);
  border-right:1px solid var(--border);z-index:1050;
  display:flex;flex-direction:column;overflow:hidden;
  transition:transform .3s;
}
.sidebar.collapsed{transform:translateX(-100%)}

/* Search bar */
.search-box{padding:12px;border-bottom:1px solid var(--border);background:#fafbfc}
.search-row{display:flex;gap:6px}
.search-row input{
  flex:1;padding:9px 12px;border:1px solid var(--border);border-radius:8px;
  font-size:14px;outline:none;
}
.search-row input:focus{border-color:var(--primary)}
.search-row button{
  padding:9px 18px;background:var(--primary);color:#fff;border:none;
  border-radius:8px;cursor:pointer;font-size:14px;font-weight:600;
  white-space:nowrap;transition:.2s;
}
.search-row button:hover{background:var(--primary-dark)}

/* Filters */
.filter-toggle{
  display:flex;align-items:center;gap:6px;margin-top:8px;
  font-size:12px;color:var(--primary);cursor:pointer;user-select:none;
}
.filter-toggle:hover{text-decoration:underline}
.filter-panel{
  display:none;margin-top:8px;gap:6px;
  grid-template-columns:1fr 1fr;
}
.filter-panel.show{display:grid}
.filter-panel label{font-size:11px;color:var(--text2);margin-bottom:2px;display:block}
.filter-panel input,.filter-panel select{
  width:100%;padding:5px 8px;border:1px solid var(--border);border-radius:6px;
  font-size:12px;
}
.filter-panel .full-row{grid-column:1/-1}
.filter-btns{
  grid-column:1/-1;display:flex;gap:6px;margin-top:4px;
}
.filter-btns button{
  flex:1;padding:6px;border-radius:6px;border:1px solid var(--border);
  font-size:12px;cursor:pointer;transition:.2s;
}
.filter-btns .btn-apply{background:var(--primary);color:#fff;border-color:var(--primary)}
.filter-btns .btn-clear{background:#fff;color:var(--text2)}

/* Sort bar */
.sort-bar{
  display:flex;gap:2px;padding:8px 12px;border-bottom:1px solid var(--border);
  background:#fafbfc;flex-wrap:wrap;
}
.sort-bar button{
  padding:4px 10px;font-size:11px;border:1px solid var(--border);
  border-radius:14px;background:#fff;cursor:pointer;transition:.2s;
  color:var(--text2);
}
.sort-bar button.active{background:var(--primary);color:#fff;border-color:var(--primary)}
.sort-bar .limit-select{
  margin-left:auto;padding:4px 8px;font-size:11px;
  border:1px solid var(--border);border-radius:14px;
  background:#fff;color:var(--text2);cursor:pointer;
  outline:none;
}

/* Summary */
.summary-bar{
  padding:10px 12px;border-bottom:1px solid var(--border);background:#f0f6ff;
  font-size:12px;color:var(--text2);display:none;line-height:1.8;
}
.summary-bar .val{font-weight:700;color:var(--text)}

/* Results list */
.results{flex:1;overflow-y:auto;padding:0}
.results .empty{padding:40px 20px;text-align:center;color:var(--text2);font-size:14px}
.results .loading{padding:40px 20px;text-align:center;color:var(--text2)}

.tx-card{
  padding:12px;border-bottom:1px solid #eee;cursor:pointer;
  transition:background .15s;
}
.tx-card:hover{background:#f0f6ff}
.tx-card.active{background:#e3f0ff;border-left:3px solid var(--primary)}
.tx-addr{font-size:13px;font-weight:600;color:var(--text);margin-bottom:4px;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.tx-meta{font-size:11px;color:var(--text2);display:flex;flex-wrap:wrap;gap:6px 12px}
.tx-meta .tag{
  display:inline-block;padding:1px 6px;background:#eef3ff;border-radius:10px;
  font-size:10px;color:var(--primary);
}
.tx-price{
  font-size:15px;font-weight:700;color:var(--red);margin-top:4px;
}
.tx-unit{font-size:12px;color:var(--text2);font-weight:400}
.community-badge{
  display:inline-block;padding:3px 10px;background:#e8f5e9;color:#2e7d32;
  border-radius:12px;font-size:12px;font-weight:600;margin-bottom:6px;
}

/* ========== MAP ========== */
.map-wrap{
  position:fixed;top:var(--header-h);bottom:0;
  left:var(--sidebar-w);right:0;
}
#map{width:100%;height:100%}

/* Map controls */
.map-controls{
  position:absolute;bottom:30px;right:14px;z-index:900;
  display:flex;flex-direction:column;gap:6px;
}
.map-controls button{
  width:40px;height:40px;border-radius:50%;border:none;
  background:#fff;box-shadow:0 2px 8px rgba(0,0,0,.15);
  cursor:pointer;font-size:20px;display:flex;align-items:center;
  justify-content:center;transition:.2s;color:var(--text);
}
.map-controls button:hover{background:var(--primary);color:#fff}

/* ========== æ‰‹æ©Ÿ ========== */
@media(max-width:768px){
  .hamburger{display:block}
  .sidebar{width:100%;transform:translateX(-100%)}
  .sidebar.open{transform:translateX(0)}
  .map-wrap{left:0}
}
</style>
</head>
<body>

<!-- HEADER -->
<div class="header">
  <button class="hamburger" onclick="toggleSidebar()">â˜°</button>
  <div class="logo">ğŸ¢ è‰¯å¯Œå±…åœ°ç”¢</div>
  <div class="unit-toggle">
    <button id="btnPing" class="active" onclick="setUnit('ping')">åª</button>
    <button id="btnSqm" onclick="setUnit('sqm')">mÂ²</button>
  </div>
</div>

<!-- SIDEBAR -->
<div class="sidebar" id="sidebar">
  <!-- Search -->
  <div class="search-box">
    <div class="search-row">
      <input id="searchInput" type="text" placeholder="æœå°‹åœ°å€ / å»ºæ¡ˆåç¨±â€¦" 
             onkeydown="if(event.key==='Enter')doSearch()">
      <button onclick="doSearch()">æœå°‹</button>
    </div>
    <div class="filter-toggle" onclick="toggleFilters()">
      <span id="filterArrow">â–¶</span> é€²éšç¯©é¸
    </div>
    <div class="filter-panel" id="filterPanel">
      <div>
        <label>å»ºç‰©å‹æ…‹</label>
        <select id="fBuildType">
          <option value="">å…¨éƒ¨</option>
          <option value="ä½å®…å¤§æ¨“">ä½å®…å¤§æ¨“(11æ¨“å«ä»¥ä¸Šæœ‰é›»æ¢¯)</option>
          <option value="è¯å»ˆ">è¯å»ˆ(10æ¨“å«ä»¥ä¸‹æœ‰é›»æ¢¯)</option>
          <option value="å…¬å¯“">å…¬å¯“(5æ¨“å«ä»¥ä¸‹ç„¡é›»æ¢¯)</option>
          <option value="é€å¤©å">é€å¤©å</option>
          <option value="å¥—æˆ¿">å¥—æˆ¿(1æˆ¿1å»³1è¡›)</option>
        </select>
      </div>
      <div>
        <label>æˆ¿æ•¸</label>
        <input id="fRooms" type="text" placeholder="å¦‚ 2,3,4">
      </div>
      <div>
        <label>åªæ•¸ç¯„åœ</label>
        <input id="fPing" type="text" placeholder="å¦‚ 20-40">
      </div>
      <div>
        <label>å…¬è¨­æ¯” %</label>
        <input id="fRatio" type="text" placeholder="å¦‚ 0-35">
      </div>
      <div>
        <label>å–®åƒ¹ (è¬/åª)</label>
        <input id="fUnitPrice" type="text" placeholder="å¦‚ 40-80">
      </div>
      <div>
        <label>ç¸½åƒ¹ (è¬)</label>
        <input id="fPrice" type="text" placeholder="å¦‚ 1000-3000">
      </div>
      <div>
        <label>æ°‘åœ‹å¹´ç¯„åœ</label>
        <input id="fYear" type="text" placeholder="å¦‚ 110-114">
      </div>
      <div class="filter-btns">
        <button class="btn-clear" onclick="clearFilters()">æ¸…é™¤</button>
        <button class="btn-apply" onclick="doSearch()">å¥—ç”¨</button>
      </div>
    </div>
  </div>

  <!-- Sort -->
  <div class="sort-bar">
    <button class="active" data-sort="date" onclick="setSort(this)">æ—¥æœŸæ–°â†’èˆŠ</button>
    <button data-sort="price" onclick="setSort(this)">ç¸½åƒ¹é«˜â†’ä½</button>
    <button data-sort="unit_price" onclick="setSort(this)">å–®åƒ¹é«˜â†’ä½</button>
    <button data-sort="ping" onclick="setSort(this)">åªæ•¸å¤§â†’å°</button>
    <button data-sort="public_ratio" onclick="setSort(this)">å…¬è¨­ä½â†’é«˜</button>
    <button data-sort="count" onclick="setSort(this)">æˆäº¤ç­†æ•¸å¤šâ†’å°‘</button>
    <select id="limitSelect" class="limit-select" onchange="doSearch()" title="é¡¯ç¤ºç­†æ•¸">
      <option value="100">100ç­†</option>
      <option value="200">200ç­†</option>
      <option value="500" selected>500ç­†</option>
      <option value="1000">1000ç­†</option>
      <option value="2000">å…¨éƒ¨</option>
    </select>
  </div>

  <!-- Summary -->
  <div class="summary-bar" id="summaryBar"></div>

  <!-- Results -->
  <div class="results" id="results">
    <div class="empty">ğŸ‘† è¼¸å…¥åœ°å€æˆ–å»ºæ¡ˆåç¨±é–‹å§‹æœå°‹</div>
  </div>
</div>

<!-- MAP -->
<div class="map-wrap">
  <div id="map"></div>
  <div class="map-controls">
    <button onclick="locateMe()" title="æˆ‘çš„ä½ç½®">ğŸ“</button>
    <button onclick="map.zoomIn()" title="æ”¾å¤§">ï¼‹</button>
    <button onclick="map.zoomOut()" title="ç¸®å°">ï¼</button>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// å…¨åŸŸç‹€æ…‹
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let map, markerGroup;
let unit = 'ping';           // 'ping' | 'sqm'
let currentSort = 'date';
let txData = [];              // ç›®å‰çš„æœå°‹çµæœ
let activeCardIdx = -1;
let markerClusterGroup;       // MarkerClusterGroup ç”¨æ–¼èšé¡

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// åœ°åœ–åˆå§‹åŒ–
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initMap(){
  map = L.map('map',{zoomControl:false}).setView([25.033,121.565],13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    maxZoom:19, attribution:'Â© OpenStreetMap'
  }).addTo(map);
  
  // ä½¿ç”¨ MarkerClusterGroup æ›¿ä»£ layerGroup
  markerClusterGroup = L.markerClusterGroup({
    maxClusterRadius: 80,
    disableClusteringAtZoom: 17
  });
  map.addLayer(markerClusterGroup);
  markerGroup = markerClusterGroup;  // ä¿æŒå‘å¾Œç›¸å®¹
  
  // æ·»åŠ åœ–ä¾‹
  addLegend();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// å–®ä½åˆ‡æ›
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setUnit(u){
  unit = u;
  document.getElementById('btnPing').classList.toggle('active', u==='ping');
  document.getElementById('btnSqm').classList.toggle('active', u==='sqm');
  renderResults();
  renderSummary();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// æ ¼å¼åŒ–å·¥å…·
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function fmtWan(val){
  // val æ˜¯å…ƒï¼Œè½‰è¬
  if(!val||val<=0) return '-';
  const w = val / 10000;
  if(w >= 10000) return (w/10000).toFixed(2) + 'å„„';
  if(w >= 1) return w.toFixed(w<100?1:0) + 'è¬';
  return val.toLocaleString() + 'å…ƒ';
}

function fmtArea(sqm, ping){
  if(unit==='ping') return (ping||0).toFixed(1) + 'åª';
  return (sqm||0).toFixed(1) + 'mÂ²';
}

function fmtUnitPrice(unitPricePing, unitPriceSqm){
  // unitPricePing æ˜¯ å…ƒ/åª, unitPriceSqm æ˜¯ å…ƒ/mÂ²
  if(unit==='ping'){
    if(!unitPricePing||unitPricePing<=0) return '-';
    const w = unitPricePing / 10000;
    return w.toFixed(1) + 'è¬/åª';
  } else {
    if(!unitPriceSqm||unitPriceSqm<=0) return '-';
    const w = unitPriceSqm / 10000;
    return w.toFixed(1) + 'è¬/mÂ²';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Sidebar toggle (æ‰‹æ©Ÿ)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleSidebar(){
  document.getElementById('sidebar').classList.toggle('open');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ç¯©é¸é¢æ¿
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleFilters(){
  const p = document.getElementById('filterPanel');
  const a = document.getElementById('filterArrow');
  const show = !p.classList.contains('show');
  p.classList.toggle('show', show);
  a.textContent = show ? 'â–¼' : 'â–¶';
}

function clearFilters(){
  ['fBuildType','fRooms','fPing','fRatio','fUnitPrice','fPrice','fYear']
    .forEach(id=>{const el=document.getElementById(id); if(el) el.value='';});
}

function getFilterParams(){
  let p = '';
  const bt = document.getElementById('fBuildType').value;
  if(bt) p += '&building_type=' + encodeURIComponent(bt);
  const rm = document.getElementById('fRooms').value.trim();
  if(rm) p += '&rooms=' + encodeURIComponent(rm);
  const pg = document.getElementById('fPing').value.trim();
  if(pg) p += '&ping=' + encodeURIComponent(pg);
  const rt = document.getElementById('fRatio').value.trim();
  if(rt) p += '&public_ratio=' + encodeURIComponent(rt);
  const up = document.getElementById('fUnitPrice').value.trim();
  if(up) p += '&unit_price=' + encodeURIComponent(up);
  const pr = document.getElementById('fPrice').value.trim();
  if(pr) p += '&price=' + encodeURIComponent(pr);
  const yr = document.getElementById('fYear').value.trim();
  if(yr) p += '&year=' + encodeURIComponent(yr);
  return p;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// å‰ç«¯æ’åºï¼ˆå…¨éƒ¨åœ¨ç™½èª¿å…§è™•ç†ã€ä¸å†å‘¼å« APIï¼‰
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function sortData(sortType){
  switch(sortType){
    case 'date':
      txData.sort((a,b) => (b.date_raw||'').localeCompare(a.date_raw||''));
      break;
    case 'price':
      txData.sort((a,b) => (b.price||0) - (a.price||0));
      break;
    case 'unit_price':
      txData.sort((a,b) => (b.unit_price_ping||0) - (a.unit_price_ping||0));
      break;
    case 'ping':
      txData.sort((a,b) => (b.area_ping||0) - (a.area_ping||0));
      break;
    case 'public_ratio':
      txData.sort((a,b) => (a.public_ratio||999) - (b.public_ratio||999));
      break;
    case 'count':{
      const addrCount = {};
      txData.forEach(tx => {
        addrCount[tx.address] = (addrCount[tx.address]||0) + 1;
      });
      txData.sort((a,b) => addrCount[b.address] - addrCount[a.address]);
      break;
    }
  }
}

function setSort(btn){
  document.querySelectorAll('.sort-bar button').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  currentSort = btn.dataset.sort;
  if(txData.length > 0){
    sortData(currentSort);
    renderResults();
    plotMarkers();
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// æœå°‹
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function doSearch(){
  const kw = document.getElementById('searchInput').value.trim();
  if(!kw){alert('è«‹è¼¸å…¥æœå°‹é—œéµå­—');return;}

  const results = document.getElementById('results');
  results.innerHTML = '<div class="loading">ğŸ” æœå°‹ä¸­â€¦</div>';

  const limitVal = document.getElementById('limitSelect').value;
  const url = '/api/search?keyword=' + encodeURIComponent(kw) +
              '&limit=' + limitVal + getFilterParams();
  try{
    const resp = await fetch(url);
    const data = await resp.json();
    if(!data.success){
      results.innerHTML = '<div class="empty">âŒ ' + (data.error||'æœå°‹å¤±æ•—') + '</div>';
      return;
    }
    txData = data.transactions || [];
    if(txData.length === 0){
      results.innerHTML = '<div class="empty">ğŸ˜¢ æ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„è³‡æ–™</div>';
      document.getElementById('summaryBar').style.display = 'none';
      markerGroup.clearLayers();
      return;
    }

    // é¡¯ç¤ºå»ºæ¡ˆ badge
    window._communityName = data.community_name || null;
    window._searchType = data.search_type || 'address';
    window._summary = data.summary || {};

    // å‰ç«¯æ’åº
    sortData(currentSort);

    renderResults();
    renderSummary();
    plotMarkers();

    // æ‰‹æ©Ÿä¸Šè‡ªå‹•æ”¶èµ· sidebar
    if(window.innerWidth <= 768){
      document.getElementById('sidebar').classList.remove('open');
    }
  } catch(e){
    results.innerHTML = '<div class="empty">âŒ ç¶²è·¯éŒ¯èª¤: ' + e.message + '</div>';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// æ¸²æŸ“çµæœåˆ—è¡¨
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderResults(){
  const container = document.getElementById('results');
  let html = '';

  if(window._communityName){
    html += '<div style="padding:10px 12px"><span class="community-badge">ğŸ˜ï¸ ' +
            escHtml(window._communityName) + '</span></div>';
  }

  txData.forEach((tx, i) => {
    const isActive = i === activeCardIdx;
    html += `<div class="tx-card${isActive?' active':''}" onclick="selectTx(${i})" data-idx="${i}">
      <div class="tx-addr" title="${escHtml(tx.address)}">${escHtml(tx.address)}</div>
      <div class="tx-meta">
        <span>ğŸ“… ${tx.date||'-'}</span>
        <span>ğŸ“ ${fmtArea(tx.area_sqm, tx.area_ping)}</span>
        <span>${tx.rooms||0}æˆ¿${tx.halls||0}å»³${tx.baths||0}è¡›</span>
        ${tx.floor?'<span>ğŸ¢ '+escHtml(tx.floor)+'F/'+escHtml(tx.total_floors)+'F</span>':''}
        ${tx.public_ratio>0?'<span class="tag">å…¬è¨­'+tx.public_ratio+'%</span>':''}
        ${tx.building_type?'<span class="tag">'+escHtml(tx.building_type)+'</span>':''}
      </div>
      <div class="tx-price">${fmtWan(tx.price)} <span class="tx-unit">${fmtUnitPrice(tx.unit_price_ping, tx.unit_price_sqm)}</span></div>
    </div>`;
  });
  container.innerHTML = html;
}

function escHtml(s){
  if(!s) return '';
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// æ¸²æŸ“çµ±è¨ˆæ‘˜è¦
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderSummary(){
  const s = window._summary;
  if(!s || !s.total){
    document.getElementById('summaryBar').style.display = 'none';
    return;
  }
  const bar = document.getElementById('summaryBar');
  bar.style.display = 'block';
  
  const avgUp = unit==='ping' ? fmtUnitPrice(s.avg_unit_price_ping, 0) : fmtUnitPrice(0, s.avg_unit_price_ping / 3.30579);
  const minUp = unit==='ping' ? fmtUnitPrice(s.min_unit_price_ping, 0) : fmtUnitPrice(0, s.min_unit_price_ping / 3.30579);
  const maxUp = unit==='ping' ? fmtUnitPrice(s.max_unit_price_ping, 0) : fmtUnitPrice(0, s.max_unit_price_ping / 3.30579);
  
  bar.innerHTML = `
    å…± <span class="val">${s.total}</span> ç­† ï½œ
    å‡åƒ¹ <span class="val">${fmtWan(s.avg_price)}</span> ï½œ
    å‡åª <span class="val">${s.avg_ping}åª</span> ï½œ
    å–®åƒ¹ <span class="val">${avgUp}</span>
    <br>
    å–®åƒ¹å€é–“ <span class="val">${minUp}</span> ~ <span class="val">${maxUp}</span> ï½œ
    å‡å…¬è¨­ <span class="val">${s.avg_ratio||'-'}%</span>
  `;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// åœ°åœ– marker
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function plotMarkers(){
  markerClusterGroup.clearLayers();
  const bounds = [];

  txData.forEach((tx, i) => {
    if(!tx.lat || !tx.lng) return;

    // ä¾æ“šç¸½åƒ¹å€é–“æ±ºå®šé¡è‰²
    let color = '#888';
    if (tx.price > 0) {
      if (tx.price > 40000000) {
        color = '#ea4335'; // > 4000è¬
      } else if (tx.price > 20000000) {
        color = '#f9ab00'; // 2000~4000è¬
      } else {
        color = '#34a853'; // â‰¤ 2000è¬
      }
    }

    // æ ¼å¼åŒ–ç¸½åƒ¹ç”¨æ–¼é¡¯ç¤º
    const priceText = tx.price >= 100000000 
      ? (tx.price / 100000000).toFixed(1) + 'å„„'
      : (tx.price / 10000).toFixed(0) + 'è¬';

    // å»ºç«‹è‡ªè¨‚ marker HTML
    const markerHtml = `
      <div style="
        display: flex;
        align-items: center;
        justify-content: center;
        width: 50px;
        height: 50px;
        background: ${color};
        border: 3px solid white;
        border-radius: 50%;
        font-size: 12px;
        font-weight: bold;
        color: white;
        text-shadow: 0 1px 2px rgba(0,0,0,0.3);
      ">
        ${priceText}
      </div>
    `;

    const markerIcon = L.divIcon({
      html: markerHtml,
      iconSize: [50, 50],
      className: 'price-marker'
    });

    const marker = L.marker([tx.lat, tx.lng], {icon: markerIcon});
    marker.bindPopup(makePopup(tx), {maxWidth:300});
    marker.on('click', () => {
      activeCardIdx = i;
      renderResults();
      // æ»¾å‹•åˆ°å°æ‡‰å¡ç‰‡
      const card = document.querySelector(`.tx-card[data-idx="${i}"]`);
      if(card) card.scrollIntoView({behavior:'smooth', block:'center'});
    });

    markerClusterGroup.addLayer(marker);
    bounds.push([tx.lat, tx.lng]);
  });

  if(bounds.length > 0){
    map.fitBounds(bounds, {padding:[40,40], maxZoom:16});
  }
}

function makePopup(tx){
  return `<div style="font-size:13px;line-height:1.6">
    <b>${escHtml(tx.address)}</b><br>
    ğŸ“… ${tx.date||'-'} ï½œ ğŸ“ ${fmtArea(tx.area_sqm, tx.area_ping)}<br>
    ğŸ’° <b style="color:#ea4335">${fmtWan(tx.price)}</b>
    <span style="color:#666">${fmtUnitPrice(tx.unit_price_ping, tx.unit_price_sqm)}</span><br>
    ğŸ¢ ${tx.rooms||0}æˆ¿${tx.halls||0}å»³${tx.baths||0}è¡›
    ${tx.floor?'ï½œ '+tx.floor+'F/'+tx.total_floors+'F':''}
    ${tx.public_ratio>0?'ï½œ å…¬è¨­'+tx.public_ratio+'%':''}
    ${tx.building_type?'<br>'+escHtml(tx.building_type):''}
    ${tx.note?'<br><span style="color:#888;font-size:11px">'+escHtml(tx.note)+'</span>':''}
  </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// é¸å–äº¤æ˜“
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function selectTx(idx){
  activeCardIdx = idx;
  renderResults();
  const tx = txData[idx];
  if(tx && tx.lat && tx.lng){
    map.setView([tx.lat, tx.lng], 16);
    // é–‹å•Ÿå°æ‡‰ popup
    markerGroup.eachLayer(layer => {
      const ll = layer.getLatLng();
      if(Math.abs(ll.lat - tx.lat) < 0.0001 && Math.abs(ll.lng - tx.lng) < 0.0001){
        layer.openPopup();
      }
    });
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// åœ–ä¾‹
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addLegend(){
  const legend = L.control({position: 'bottomright'});
  
  legend.onAdd = function(){
    const div = L.DomUtil.create('div', 'info legend');
    div.innerHTML = `
      <style>
        .legend {
          background: white;
          padding: 12px;
          border-radius: 5px;
          box-shadow: 0 0 15px rgba(0,0,0,0.2);
          font-size: 13px;
          line-height: 1.8;
        }
        .legend-item {
          display: flex;
          align-items: center;
          gap: 8px;
          margin-bottom: 6px;
        }
        .legend-color {
          width: 20px;
          height: 20px;
          border-radius: 50%;
          border: 2px solid #fff;
          box-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }
      </style>
      <div style="font-weight: bold; margin-bottom: 8px;">ç¸½åƒ¹å€é–“</div>
      <div class="legend-item">
        <div class="legend-color" style="background: #34a853;"></div>
        <span>â‰¤ 2000è¬</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background: #f9ab00;"></div>
        <span>2000 ~ 4000è¬</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background: #ea4335;"></div>
        <span>&gt; 4000è¬</span>
      </div>
    `;
    
    // é˜»æ­¢åœ°åœ–äº‹ä»¶å†’æ³¡
    L.DomEvent.disableScrollPropagation(div);
    L.DomEvent.disableClickPropagation(div);
    
    return div;
  };
  
  legend.addTo(map);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GPS å®šä½
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function locateMe(){
  if(!navigator.geolocation){
    alert('æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´å®šä½åŠŸèƒ½');
    return;
  }
  navigator.geolocation.getCurrentPosition(
    pos => {
      const {latitude:lat, longitude:lng} = pos.coords;
      map.setView([lat,lng], 16);
      L.marker([lat,lng]).addTo(map)
        .bindPopup('ğŸ“ æ‚¨çš„ä½ç½®').openPopup();
    },
    err => alert('å®šä½å¤±æ•—: ' + err.message),
    {enableHighAccuracy:true, timeout:10000}
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// åˆå§‹åŒ–
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('DOMContentLoaded', () => {
  initMap();
});
</script>
</body>
</html>
