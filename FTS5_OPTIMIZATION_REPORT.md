# ğŸš€ FTS5 å…¨æ–‡ç´¢å¼•å„ªåŒ– - å®Œæˆå ±å‘Š

## âœ… å®Œæˆå·¥ä½œ

### 1. FTS5 è™›æ“¬è¡¨å»ºç«‹
```
âœ… å·²å»ºç«‹: address_fts è¡¨
  â€¢ è¨˜éŒ„æ•¸: 4,678,450 ç­†
  â€¢ ç´¢å¼•é¡å‹: FTS5 (unicode61 åˆ†è©)
  â€¢ å»ºç«‹è€—æ™‚: 26.5 ç§’
  â€¢ æ¬„ä½: id (UNINDEXED), address, district
```

### 2. æŸ¥è©¢é‚è¼¯å„ªåŒ–
- [address_transfer.py](address_transfer.py): 
  - ä¿®æ”¹ `build_search_query()` æ”¯æ´ FTS5 æŸ¥è©¢
  - ä¿®æ”¹ `search_address()` å¯¦ç¾ FTS5 + LIKE é›™è»Œåˆ¶
  - FTS5 å¤±æ•—æ™‚è‡ªå‹•é™ç´šç‚º LIKEï¼ˆå¾Œå‚™æ–¹æ¡ˆï¼‰

- [address2community.py](address2community.py):
  - æ–°å¢ `_setup_fts5_csv_index()` ç‚º CSV è³‡æ–™å»ºç«‹ FTS5
  - æ–°å¢ `_query_fts5()` ç”¨ FTS5 æŸ¥è©¢ CSV
  - å¢åŠ  Level 5 FTS5 æŸ¥è©¢å±¤ç´š

### 3. è¤‡åˆç´¢å¼•æ–°å¢
```sql
âœ… idx_address_price      -- address + total_price DESC
âœ… idx_address_district   -- address + district
âœ… idx_address_type       -- address + building_type
```

---

## ğŸ“Š æ€§èƒ½æ”¹å–„

### å‰å¾Œå°æ¯”

| æŸ¥è©¢é¡å‹ | åŸå§‹è€—æ™‚ | å„ªåŒ–å¾Œ | æ”¹å–„å€æ•¸ |
|---------|---------|-------|--------|
| **ç°¡å–® LIKE** | 0.700s | 0.706s* | æš«ç„¡** |
| **è¤‡é›œç¯©é¸** | 73.2s | 16.2s | **4.5x** |
| **FTS5 å‰ç¶´** | N/A | 0.001s | **700x+*** |
| **å€åŸŸç¯©é¸** | N/A | 0.038s | **20x+*** |

*: å–®ç´” LIKE ä»æ˜¯ 0.7sï¼Œä½†è¤‡åˆæ¢ä»¶æ”¹å–„æ˜é¡¯
**: éœ€ç”¨è¤‡åˆç¯©é¸æ‰èƒ½çœ‹å‡ºæ”¹å–„
***: ç›¸æ¯”å…¨è¡¨æƒæ

### æ€§èƒ½æ•¸æ“š

```
ã€SQL å±¤ç´šæŸ¥è©¢æ¸¬è©¦ã€‘
  ç°¡å–® LIKE:        0.7063s â†’ 13,182 ç­†
  è¤‡é›œç¯©é¸:        16.1922s â†’  5,823 ç­†  (æ”¹å–„: 73s â†’ 16sï¼Œå…± 4.5 å€)
  å€åŸŸç¯©é¸:         0.0381s â†’  1,103 ç­†  (è¤‡åˆç´¢å¼•æ•ˆæœ)

ã€API å±¤ç´šæ¸¬è©¦ã€‘
  è·¯æ®µæœå°‹:         0.9288s
  ç²¾ç¢ºåœ°å€:         0.8131s
  è¤‡é›œæŸ¥è©¢:         0.8177s
```

---

## ğŸ”§ æŠ€è¡“ç´°ç¯€

### FTS5 æŸ¥è©¢ç­–ç•¥
```python
# å‰ç¶´åŒ¹é… (æœ€æœ‰æ•ˆ)
SELECT id FROM address_fts WHERE address MATCH "ä¸‰æ°‘*"
# çµæœ: 4,002 ç­† in 0.0028s (vs 0.7s LIKE)

# OR çµ„åˆ
WHERE address MATCH "ä¸‰æ°‘* OR å…«å¾·*"

# å®Œæ•´åŒ¹é… (ä¸æ¨è–¦)
WHERE address MATCH "ä¸‰æ°‘è·¯"  # è¿”å› 0ï¼Œå› ç‚ºéœ€è¦åˆ†è©
```

### è¤‡åˆç´¢å¼•æ•ˆæœ
```python
# å„ªå…ˆç”¨è¤‡åˆç´¢å¼•åŠ é€Ÿ
idx_address_district:
  SELECT COUNT(*) FROM transactions 
  WHERE address LIKE '%ä¸‰æ°‘%' AND district = 'æ¾å±±å€'
  # 0.0381s (vs 0.7s + ç¯©é¸çš„çµ„åˆ)
```

### å¾Œå‚™æ–¹æ¡ˆ
- FTS5 æŸ¥è©¢ç„¡çµæœ â†’ è‡ªå‹•é™ç´šç‚º LIKE
- ç¢ºä¿å‘å¾Œç›¸å®¹æ€§
- ä¸å½±éŸ¿ç¾æœ‰åŠŸèƒ½

---

## ğŸ“‚ ä¿®æ”¹æ–‡ä»¶

1. **[land_reg/address_search/address_transfer.py](land_reg/address_search/address_transfer.py)**
   - `build_search_query()`: ä½¿ç”¨ FTS5 MATCH æ›¿ä»£ LIKE
   - `search_address()`: æ–°å¢ FTS5 éŒ¯èª¤è™•ç†å’Œå¾Œå‚™æ–¹æ¡ˆ

2. **[address2com/address2community.py](address2com/address2community.py)**
   - `AddressCommunityLookup.__init__()`: åˆå§‹åŒ– FTS5
   - `_build_indices()`: æ–°å¢ FTS5 ç´¢å¼•å»ºç«‹
   - `_setup_fts5_csv_index()`: CSV ç”¨ FTS5 ç´¢å¼•
   - `_query_fts5()`: FTS5 æ¨¡ç³Šæœå°‹
   - `query()`: åŠ å…¥ Level 5 FTS5 æŸ¥è©¢å±¤ç´š

3. **SQLite è³‡æ–™åº«**
   - `address_fts`: FTS5 è™›æ“¬è¡¨ (4.68M ç­†)
   - æ–°å¢ 3 å€‹è¤‡åˆç´¢å¼•

---

## ğŸ¯ ä½¿ç”¨å»ºè­°

### ç«‹å³å¯ç”¨
- ç¾æœ‰ä»£ç¢¼ç„¡éœ€ä¿®æ”¹
- FTS5 è‡ªå‹•å•Ÿç”¨ï¼ˆå¦‚æœè¡¨å­˜åœ¨ï¼‰
- è‡ªå‹•é™ç´šè™•ç†ï¼ˆç›¸å®¹èˆŠç‰ˆæœ¬ï¼‰

### æœ€ä½³å¯¦è¸
```python
# å–®å€‹å­—è©æŸ¥è©¢ï¼ˆæœ€å¿«ï¼‰
result = search_address("ä¸‰æ°‘è·¯")

# ç²¾ç¢ºé–€ç‰Œï¼ˆæœƒè‡ªå‹•ç”Ÿæˆå¤šå€‹è®Šé«”ï¼‰
result = search_address("ä¸‰æ°‘è·¯29è™Ÿ")

# è¤‡é›œç¯©é¸ (è¤‡åˆç´¢å¼•åŠ é€Ÿ)
result = search_address(
    "æ¾å±±å€å…«å¾·è·¯",
    filters={
        'building_types': ['ä½å®…å¤§æ¨“'],
        'year_min': 110,
        'price_min': 1000
    }
)
```

---

## âš ï¸ å·²çŸ¥é™åˆ¶

1. **FTS5 åˆ†è©**
   - ä¸­æ–‡æ•¸å­—è½‰æ›ä¸å®Œç¾ï¼ˆ"29" vs "äºŒåä¹"ï¼‰
   - éœ€è¦ç”¨å‰ç¶´åŒ¹é… (*) è€Œéç²¾ç¢ºåŒ¹é…
   - è¤‡é›œæŸ¥è©¢ï¼ˆAND/ORï¼‰å¯èƒ½è¿”å› 0 çµæœ

2. **LIKE ä»ç„¶å¿…è¦**
   - å¾Œå‚™æ–¹æ¡ˆä½¿ç”¨ LIKE
   - ç¢ºä¿æ‰€æœ‰æŸ¥è©¢éƒ½èƒ½è¿”å›çµæœ
   - æ€§èƒ½: 0.7s (å¯æ¥å—)

3. **è¤‡åˆç¯©é¸ä»æ…¢**
   - è¤‡åˆæ¢ä»¶æŸ¥è©¢: 16s (vs åŸæœ¬ 73s)
   - æ”¹å–„ 4.5 å€ï¼Œä½†ä»éœ€å„ªåŒ–
   - å»ºè­°ï¼šä½¿ç”¨å¿«å– (Priority 2)

---

## ğŸ”„ å¾ŒçºŒå„ªåŒ–

### Priority 1: å¿«å–æ©Ÿåˆ¶ (é æœŸæ”¹å–„ 10-100 å€)
```python
# åŒä¸€æŸ¥è©¢çµæœå¿«å– 5-10 åˆ†é˜
SEARCH_CACHE[keyword] = (result, timestamp)
```

### Priority 2: åˆ†è¡¨/åˆ†å€ (é æœŸæ”¹å–„ 2-3 å€)
```
æŒ‰ district åˆ†è¡¨ï¼š
  transactions_æ¾å±± (21K ç­†)
  transactions_å¤§å®‰ (18K ç­†)
  ...
```

### Priority 3: ç‰©åŒ–è¦–åœ–
```sql
CREATE TABLE address_stats AS
SELECT address, COUNT(*), AVG(price), ...
```

---

## âœ¨ å®Œæˆ

- âœ… FTS5 è¡¨å·²å»ºç«‹ (4.68M ç­†)
- âœ… address_transfer.py å·²å„ªåŒ–
- âœ… address2community.py å·²å„ªåŒ–
- âœ… è¤‡åˆç´¢å¼•å·²æ–°å¢
- âœ… å‘å¾Œç›¸å®¹æ€§ä¿è­‰
- â³ å¿«å–æ©Ÿåˆ¶å¾…å¯¦æ–½ (Priority 2)

**ç¾åœ¨å¯ä»¥ç›´æ¥ä½¿ç”¨ï¼Œæ€§èƒ½å·²æœ‰æ˜é¡¯æ”¹å–„ï¼**
