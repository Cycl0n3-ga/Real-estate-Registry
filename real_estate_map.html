<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ¿åœ°ç”¢åƒ¹æ ¼åœ°åœ–æŸ¥è©¢</title>
    <style>
        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            margin: 0;
            padding: 0;
            background: #f5f5f5;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        h1 {
            margin: 0 0 10px 0;
        }
        .search-box {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .search-input {
            width: 70%;
            padding: 12px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 5px;
            margin-right: 10px;
        }
        .search-btn {
            padding: 12px 30px;
            font-size: 16px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .search-btn:hover {
            background: #5568d3;
        }
        .content {
            display: flex;
            gap: 20px;
        }
        #map {
            flex: 1;
            height: 600px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .sidebar {
            width: 350px;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            max-height: 600px;
            overflow-y: auto;
        }
        .property-card {
            border: 1px solid #eee;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            transition: all 0.3s;
            cursor: pointer;
        }
        .property-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }
        .property-card.selected {
            border-color: #667eea;
            background: #f0f4ff;
        }
        .price {
            font-size: 24px;
            color: #e74c3c;
            font-weight: bold;
            margin: 10px 0;
        }
        .address {
            color: #333;
            font-weight: 500;
            margin-bottom: 8px;
        }
        .detail {
            color: #666;
            font-size: 14px;
            margin: 5px 0;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        .stats {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .stats h3 {
            margin-top: 0;
            color: #333;
        }
        .stat-item {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            font-size: 14px;
        }
        .export-btn {
            padding: 10px 20px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
        }
        .export-btn:hover {
            background: #218838;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ  æˆ¿åœ°ç”¢åƒ¹æ ¼åœ°åœ–æŸ¥è©¢ç³»çµ±</h1>
            <p>è¼¸å…¥åœ°å€é—œéµå­—ï¼Œåœ¨åœ°åœ–ä¸ŠæŸ¥çœ‹æˆ¿åœ°ç”¢äº¤æ˜“è³‡è¨Š</p>
        </div>

        <div class="search-box">
            <input type="text" 
                   id="locationInput" 
                   class="search-input" 
                   placeholder="è«‹è¼¸å…¥åœ°å€é—œéµå­—ï¼Œä¾‹å¦‚ï¼šæ—¥èˆˆä¸€è¡—ï¼–è™Ÿ" 
                   onkeypress="if(event.key==='Enter') searchProperties()">
            <button class="search-btn" onclick="searchProperties()">ğŸ” æœå°‹</button>
        </div>

        <div class="content">
            <div id="map"></div>
            <div class="sidebar">
                <div id="stats" style="display:none;">
                    <div class="stats">
                        <h3>ğŸ“Š çµ±è¨ˆè³‡è¨Š</h3>
                        <div class="stat-item">
                            <span>ç‰©ä»¶æ•¸é‡ï¼š</span>
                            <span id="totalCount">0</span>
                        </div>
                        <div class="stat-item">
                            <span>å¹³å‡ç¸½åƒ¹ï¼š</span>
                            <span id="avgPrice">0</span>
                        </div>
                        <div class="stat-item">
                            <span>å¹³å‡å–®åƒ¹ï¼š</span>
                            <span id="avgUnitPrice">0</span>
                        </div>
                        <div class="stat-item">
                            <span>æœ€é«˜åƒ¹æ ¼ï¼š</span>
                            <span id="maxPrice">0</span>
                        </div>
                        <div class="stat-item">
                            <span>æœ€ä½åƒ¹æ ¼ï¼š</span>
                            <span id="minPrice">0</span>
                        </div>
                    </div>
                    <button class="export-btn" onclick="exportToCSV()">ğŸ“¥ åŒ¯å‡ºCSV</button>
                </div>
                <div id="propertyList"></div>
            </div>
        </div>
    </div>

    <script>
        let map;
        let markers = [];
        let propertiesData = [];
        let infoWindow;

        // åˆå§‹åŒ–åœ°åœ–
        function initMap() {
            // é è¨­ä¸­å¿ƒï¼šå°ç£å°åŒ—
            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: 25.0330, lng: 121.5654 },
                zoom: 12,
                styles: [
                    {
                        featureType: "poi",
                        elementType: "labels",
                        stylers: [{ visibility: "off" }]
                    }
                ]
            });
            infoWindow = new google.maps.InfoWindow();
        }

        // æœå°‹ç‰©ä»¶
        async function searchProperties() {
            const location = document.getElementById('locationInput').value.trim();
            if (!location) {
                alert('è«‹è¼¸å…¥åœ°å€é—œéµå­—');
                return;
            }

            document.getElementById('propertyList').innerHTML = '<div class="loading">â³ æœå°‹ä¸­...</div>';
            document.getElementById('stats').style.display = 'none';

            try {
                // è®€å–CSVä¸¦éæ¿¾æ•¸æ“š
                const response = await fetch('/home/cyclone/land/ALL_lvr_land_a.csv');
                const csvText = await response.text();
                const rows = parseCSV(csvText);
                
                // éæ¿¾ç¬¦åˆåœ°å€çš„ç‰©ä»¶
                propertiesData = rows.filter(row => 
                    row['åœŸåœ°ä½ç½®å»ºç‰©é–€ç‰Œ'] && row['åœŸåœ°ä½ç½®å»ºç‰©é–€ç‰Œ'].includes(location)
                );

                if (propertiesData.length === 0) {
                    document.getElementById('propertyList').innerHTML = '<div class="loading">ğŸ˜” æ‰¾ä¸åˆ°ç¬¦åˆçš„ç‰©ä»¶</div>';
                    return;
                }

                // æ¸…é™¤èˆŠæ¨™è¨˜
                clearMarkers();

                // é¡¯ç¤ºçµ±è¨ˆè³‡è¨Š
                displayStats();

                // é¡¯ç¤ºç‰©ä»¶åˆ—è¡¨
                displayProperties();

                // åœ¨åœ°åœ–ä¸Šæ¨™è¨˜
                await addMarkersToMap();

            } catch (error) {
                console.error('Error:', error);
                document.getElementById('propertyList').innerHTML = '<div class="loading">âŒ è¼‰å…¥å¤±æ•—ï¼š' + error.message + '</div>';
            }
        }

        // è§£æCSV
        function parseCSV(text) {
            const lines = text.split('\n');
            const headers = lines[0].split(',').map(h => h.trim());
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                
                const values = parseCSVLine(lines[i]);
                const row = {};
                headers.forEach((header, index) => {
                    row[header] = values[index] ? values[index].trim() : '';
                });
                data.push(row);
            }
            return data;
        }

        // è§£æCSVè¡Œï¼ˆè™•ç†å¼•è™Ÿå…§çš„é€—è™Ÿï¼‰
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current);
            return result;
        }

        // é¡¯ç¤ºçµ±è¨ˆè³‡è¨Š
        function displayStats() {
            const prices = propertiesData.map(p => parseFloat(p['ç¸½åƒ¹å…ƒ']) || 0).filter(p => p > 0);
            const unitPrices = propertiesData.map(p => parseFloat(p['å–®åƒ¹å…ƒå¹³æ–¹å…¬å°º']) || 0).filter(p => p > 0);

            if (prices.length > 0) {
                document.getElementById('totalCount').textContent = propertiesData.length;
                document.getElementById('avgPrice').textContent = formatPrice(average(prices));
                document.getElementById('avgUnitPrice').textContent = formatNumber(average(unitPrices)) + ' å…ƒ/ã¡';
                document.getElementById('maxPrice').textContent = formatPrice(Math.max(...prices));
                document.getElementById('minPrice').textContent = formatPrice(Math.min(...prices));
                document.getElementById('stats').style.display = 'block';
            }
        }

        // é¡¯ç¤ºç‰©ä»¶åˆ—è¡¨
        function displayProperties() {
            const listHtml = propertiesData.map((property, index) => {
                const price = formatPrice(property['ç¸½åƒ¹å…ƒ']);
                const unitPrice = formatNumber(property['å–®åƒ¹å…ƒå¹³æ–¹å…¬å°º']);
                const area = formatNumber(property['å»ºç‰©ç§»è½‰ç¸½é¢ç©å¹³æ–¹å…¬å°º']);
                const address = property['åœŸåœ°ä½ç½®å»ºç‰©é–€ç‰Œ'] || 'åœ°å€ä¸è©³';
                const type = property['å»ºç‰©å‹æ…‹'] || 'æœªè¨»æ˜';
                const date = property['äº¤æ˜“å¹´æœˆæ—¥'] || 'æœªè¨»æ˜';

                return `
                    <div class="property-card" id="card-${index}" onclick="selectProperty(${index})">
                        <div class="address">ğŸ“ ${address}</div>
                        <div class="price">${price}</div>
                        <div class="detail">ğŸ’° å–®åƒ¹ï¼š${unitPrice} å…ƒ/ã¡</div>
                        <div class="detail">ğŸ“ é¢ç©ï¼š${area} ã¡</div>
                        <div class="detail">ğŸ—ï¸ é¡å‹ï¼š${type}</div>
                        <div class="detail">ğŸ“… äº¤æ˜“æ—¥æœŸï¼š${date}</div>
                    </div>
                `;
            }).join('');

            document.getElementById('propertyList').innerHTML = listHtml;
        }

        // åœ¨åœ°åœ–ä¸Šæ·»åŠ æ¨™è¨˜
        async function addMarkersToMap() {
            const geocoder = new google.maps.Geocoder();
            const bounds = new google.maps.LatLngBounds();
            let geocodePromises = [];

            for (let i = 0; i < propertiesData.length; i++) {
                const property = propertiesData[i];
                const address = property['åœŸåœ°ä½ç½®å»ºç‰©é–€ç‰Œ'];
                
                if (!address) continue;

                const promise = new Promise((resolve) => {
                    geocoder.geocode({ address: address + ', å°ç£' }, (results, status) => {
                        if (status === 'OK' && results[0]) {
                            const position = results[0].geometry.location;
                            const price = formatPrice(property['ç¸½åƒ¹å…ƒ']);
                            
                            const marker = new google.maps.Marker({
                                position: position,
                                map: map,
                                title: address,
                                label: {
                                    text: `${i + 1}`,
                                    color: 'white',
                                    fontSize: '12px',
                                    fontWeight: 'bold'
                                },
                                icon: {
                                    path: google.maps.SymbolPath.CIRCLE,
                                    scale: 15,
                                    fillColor: getPriceColor(property['ç¸½åƒ¹å…ƒ']),
                                    fillOpacity: 0.8,
                                    strokeColor: 'white',
                                    strokeWeight: 2
                                }
                            });

                            marker.addListener('click', () => {
                                selectProperty(i);
                            });

                            markers.push(marker);
                            bounds.extend(position);
                        }
                        resolve();
                    });
                });

                geocodePromises.push(promise);

                // é¿å…è¶…éGoogle APIé™åˆ¶ï¼Œæ¯10å€‹è«‹æ±‚æš«åœä¸€ä¸‹
                if (i % 10 === 9) {
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }

            await Promise.all(geocodePromises);

            if (markers.length > 0) {
                map.fitBounds(bounds);
            }
        }

        // é¸æ“‡ç‰©ä»¶
        function selectProperty(index) {
            // æ›´æ–°å¡ç‰‡æ¨£å¼
            document.querySelectorAll('.property-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.getElementById(`card-${index}`).classList.add('selected');

            // æ²å‹•åˆ°é¸ä¸­çš„å¡ç‰‡
            document.getElementById(`card-${index}`).scrollIntoView({ behavior: 'smooth', block: 'nearest' });

            // é¡¯ç¤ºè³‡è¨Šçª—å£
            if (markers[index]) {
                const property = propertiesData[index];
                const content = `
                    <div style="padding: 10px; max-width: 300px;">
                        <h3 style="margin-top: 0; color: #667eea;">${property['åœŸåœ°ä½ç½®å»ºç‰©é–€ç‰Œ']}</h3>
                        <p style="font-size: 20px; color: #e74c3c; font-weight: bold; margin: 10px 0;">
                            ${formatPrice(property['ç¸½åƒ¹å…ƒ'])}
                        </p>
                        <p><strong>å–®åƒ¹ï¼š</strong>${formatNumber(property['å–®åƒ¹å…ƒå¹³æ–¹å…¬å°º'])} å…ƒ/ã¡</p>
                        <p><strong>é¢ç©ï¼š</strong>${formatNumber(property['å»ºç‰©ç§»è½‰ç¸½é¢ç©å¹³æ–¹å…¬å°º'])} ã¡</p>
                        <p><strong>é¡å‹ï¼š</strong>${property['å»ºç‰©å‹æ…‹'] || 'æœªè¨»æ˜'}</p>
                        <p><strong>äº¤æ˜“æ—¥æœŸï¼š</strong>${property['äº¤æ˜“å¹´æœˆæ—¥'] || 'æœªè¨»æ˜'}</p>
                        <p><strong>æ¨“å±¤ï¼š</strong>${property['ç§»è½‰å±¤æ¬¡'] || 'æœªè¨»æ˜'} / ${property['ç¸½æ¨“å±¤æ•¸'] || 'æœªè¨»æ˜'}</p>
                    </div>
                `;
                infoWindow.setContent(content);
                infoWindow.open(map, markers[index]);
                map.panTo(markers[index].getPosition());
                map.setZoom(Math.max(map.getZoom(), 16));
            }
        }

        // æ¸…é™¤æ¨™è¨˜
        function clearMarkers() {
            markers.forEach(marker => marker.setMap(null));
            markers = [];
        }

        // æ ¹æ“šåƒ¹æ ¼ç²å–é¡è‰²
        function getPriceColor(priceStr) {
            const price = parseFloat(priceStr) || 0;
            if (price < 5000000) return '#2ecc71';      // ç¶ è‰² - ä½åƒ¹
            if (price < 10000000) return '#f39c12';     // æ©™è‰² - ä¸­åƒ¹
            if (price < 20000000) return '#e67e22';     // æ·±æ©™ - ä¸­é«˜åƒ¹
            return '#e74c3c';                            // ç´…è‰² - é«˜åƒ¹
        }

        // æ ¼å¼åŒ–åƒ¹æ ¼
        function formatPrice(price) {
            const num = parseFloat(price) || 0;
            if (num >= 100000000) {
                return (num / 100000000).toFixed(2) + ' å„„å…ƒ';
            } else if (num >= 10000) {
                return (num / 10000).toFixed(0) + ' è¬å…ƒ';
            }
            return num.toFixed(0) + ' å…ƒ';
        }

        // æ ¼å¼åŒ–æ•¸å­—
        function formatNumber(num) {
            const n = parseFloat(num) || 0;
            return n.toFixed(2);
        }

        // è¨ˆç®—å¹³å‡å€¼
        function average(arr) {
            return arr.reduce((a, b) => a + b, 0) / arr.length;
        }

        // åŒ¯å‡ºCSV
        function exportToCSV() {
            if (propertiesData.length === 0) {
                alert('æ²’æœ‰è³‡æ–™å¯ä»¥åŒ¯å‡º');
                return;
            }

            const headers = Object.keys(propertiesData[0]);
            const csvContent = [
                headers.join(','),
                ...propertiesData.map(row => 
                    headers.map(header => {
                        const value = row[header] || '';
                        return value.includes(',') ? `"${value}"` : value;
                    }).join(',')
                )
            ].join('\n');

            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `æˆ¿åœ°ç”¢æŸ¥è©¢çµæœ_${new Date().toISOString().slice(0,10)}.csv`;
            link.click();
        }
    </script>

    <!-- Google Maps API -->
    <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&callback=initMap&language=zh-TW" async defer></script>
</body>
</html>