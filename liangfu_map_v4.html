<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‰¯å¯Œå±…åœ°ç”¢ - å°ˆæ¥­æˆ¿åœ°ç”¢åœ°åœ–ç³»çµ±</title>
    <!-- Leaflet.js CDNï¼ˆå®Œå…¨å…è²»ï¼‰ -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Leaflet MarkerCluster -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Microsoft JhengHei', 'Segoe UI', Arial, sans-serif; overflow: hidden; }

        .top-nav {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white; padding: 15px 20px; display: flex; align-items: center;
            justify-content: space-between; box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            z-index: 2000; position: relative; flex-wrap: wrap;
        }
        .logo { font-size: 24px; font-weight: bold; display: flex; align-items: center; gap: 10px; }
        .search-bar { flex: 1; min-width: 250px; max-width: 500px; margin: 0 15px; position: relative; }
        .search-input {
            width: 100%; padding: 10px 40px 10px 15px; border: none; border-radius: 20px;
            font-size: 14px; box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        .search-btn {
            position: absolute; right: 4px; top: 50%; transform: translateY(-50%);
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            border: none; padding: 6px 16px; border-radius: 18px; color: white;
            cursor: pointer; font-weight: 600; font-size: 12px;
        }
        .nav-actions { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .unit-toggle {
            background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3);
            padding: 4px 2px; border-radius: 16px; display: flex; gap: 2px;
        }
        .unit-btn {
            background: transparent; border: none; padding: 4px 12px; border-radius: 14px;
            color: white; cursor: pointer; transition: all 0.3s; font-size: 12px;
        }
        .unit-btn.active { background: white; color: #1e3c72; font-weight: 600; }
        .nav-btn {
            background: rgba(255,255,255,0.2); border: none; padding: 6px 15px;
            border-radius: 18px; color: white; cursor: pointer; transition: all 0.3s; font-size: 12px;
        }
        .nav-btn:hover { background: rgba(255,255,255,0.3); }

        .main-container { display: flex; height: calc(100vh - 70px); }

        .left-panel {
            width: 380px; background: white; overflow-y: auto;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1); z-index: 1000; transition: width 0.3s;
        }
        
        @media (max-width: 1024px) {
            .left-panel {
                position: absolute; left: 0; top: 0; width: 320px; height: 100%;
                background: white; box-shadow: 2px 0 15px rgba(0,0,0,0.2);
                transform: translateX(-100%); transition: transform 0.3s;
                z-index: 1500;
            }
            .left-panel.open { transform: translateX(0); }
            .panel-toggle { display: flex !important; }
            .main-container { position: relative; }
        }

        .filter-section { padding: 15px; border-bottom: 1px solid #eee; }
        .filter-title {
            font-weight: 600; font-size: 15px; color: #333; display: flex;
            justify-content: space-between; align-items: center; cursor: pointer;
        }
        .filter-title:hover { color: #667eea; }
        .filter-content { max-height: 1000px; overflow: hidden; transition: max-height 0.3s; }
        .filter-content.collapsed { max-height: 0; }
        .collapse-icon { font-size: 14px; transition: transform 0.3s; }
        .collapse-icon.collapsed { transform: rotate(-90deg); }

        .filter-group { margin-bottom: 12px; }
        .filter-label { font-size: 12px; color: #666; margin-bottom: 6px; display: block; font-weight: 500; }
        .filter-row { display: flex; gap: 8px; margin-bottom: 8px; }
        .filter-input { flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px; }
        .apply-filter-btn {
            width: 100%; padding: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;
            margin-top: 8px; font-size: 13px;
        }
        .apply-filter-btn:hover { opacity: 0.9; }
        .reset-filter-btn {
            width: 100%; padding: 10px; margin-top: 6px; font-size: 13px;
            background: #95a5a6; color: white; border: none; border-radius: 6px;
            cursor: pointer; font-weight: 600;
        }
        .reset-filter-btn:hover { opacity: 0.9; }

        .projects-list { padding: 10px; overflow-y: auto; flex: 1; }
        .project-card {
            background: white; border: 1px solid #e0e0e0; border-radius: 10px;
            padding: 12px; margin-bottom: 10px; cursor: pointer; transition: all 0.3s;
        }
        .project-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.15); transform: translateY(-2px); }
        .project-card.active {
            border-color: #667eea; background: linear-gradient(135deg, rgba(102,126,234,0.05) 0%, rgba(118,75,162,0.05) 100%);
        }
        .project-name { font-weight: 600; font-size: 14px; color: #333; margin-bottom: 4px; }
        .project-address { font-size: 12px; color: #666; margin-bottom: 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .project-price { font-size: 16px; color: #e74c3c; font-weight: bold; margin: 8px 0; }
        .project-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-top: 8px; }
        .stat-item { font-size: 11px; color: #666; }
        .project-badge {
            display: inline-block; background: #667eea; color: white;
            padding: 3px 8px; border-radius: 10px; font-size: 11px; font-weight: 600;
        }

        .map-container { flex: 1; position: relative; }
        #map { width: 100%; height: 100%; }

        .panel-toggle {
            position: absolute; top: 15px; left: 15px; z-index: 1400;
            background: white; border: none; padding: 8px 12px;
            border-radius: 6px; cursor: pointer; display: none; font-size: 18px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .map-controls {
            position: absolute; top: 20px; right: 20px; z-index: 1000;
            display: flex; flex-direction: column; gap: 8px;
        }
        .map-control-btn {
            background: white; border: none; padding: 10px; border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2); cursor: pointer; font-size: 16px;
        }
        .map-control-btn:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.3); }

        /* æ¨¡æ…‹æ¡† */
        .modal {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7); z-index: 3000; justify-content: center; align-items: center;
            padding: 20px;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: white; border-radius: 15px; width: 90%; max-width: 1000px;
            max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; padding: 20px; border-radius: 15px 15px 0 0;
            display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;
        }
        .modal-title { font-size: 20px; font-weight: bold; flex: 1; min-width: 200px; }
        .close-btn {
            background: rgba(255,255,255,0.2); border: none; color: white; font-size: 24px;
            width: 36px; height: 36px; border-radius: 50%; cursor: pointer;
        }
        .close-btn:hover { background: rgba(255,255,255,0.3); }
        .modal-body { padding: 25px; }
        .project-detail-header { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .detail-stat-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 15px; border-radius: 10px; text-align: center;
        }
        .detail-stat-label { font-size: 12px; color: #666; margin-bottom: 6px; }
        .detail-stat-value { font-size: 22px; font-weight: bold; color: #333; }
        .section-title { font-size: 16px; font-weight: 600; margin-bottom: 15px; color: #333; }
        .sales-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 8px; margin-top: 15px;
        }
        .unit-cell {
            aspect-ratio: 1; border: 2px solid #ddd; border-radius: 6px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            cursor: pointer; transition: all 0.3s; padding: 8px;
        }
        .unit-cell.sold { background: #ffebee; border-color: #e74c3c; }
        .unit-cell:hover { transform: scale(1.05); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .unit-number { font-weight: 600; font-size: 12px; margin-bottom: 4px; }
        .unit-price { font-size: 10px; color: #666; }
        .transactions-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 12px; }
        .transactions-table th { background: #f5f5f5; padding: 10px; text-align: left; font-weight: 600; border-bottom: 2px solid #ddd; }
        .transactions-table td { padding: 10px; border-bottom: 1px solid #eee; }
        .transactions-table tr:hover { background: #f9f9f9; }

        .loading-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.9); display: flex; justify-content: center;
            align-items: center; z-index: 2000;
        }
        .loading-spinner {
            width: 40px; height: 40px; border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .hidden { display: none !important; }

        @media (max-width: 768px) {
            .top-nav { padding: 10px 12px; }
            .logo { font-size: 18px; }
            .search-bar { max-width: 100%; margin: 5px 8px; flex-basis: 100%; }
            .nav-actions { margin-top: 8px; }
            .left-panel { width: 100%; }
            .modal-header { flex-direction: column; gap: 10px; }
            .modal-title { min-width: auto; }
            .project-detail-header { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <div class="top-nav">
        <div class="logo">ğŸ  è‰¯å¯Œå±…åœ°ç”¢</div>
        <div class="search-bar">
            <input type="text" id="mainSearch" class="search-input"
                   placeholder="æœå°‹åœ°å€ã€å»ºæ¡ˆåç¨±ã€åœ°å€..."
                   onkeypress="if(event.key==='Enter') performSearch()">
            <button class="search-btn" onclick="performSearch()">æœå°‹</button>
        </div>
        <div class="nav-actions">
            <div class="unit-toggle">
                <button class="unit-btn" id="unitBtnSqm" onclick="setUnit('sqm')">ã¡</button>
                <button class="unit-btn active" id="unitBtnPing" onclick="setUnit('ping')">åª</button>
            </div>
            <button class="nav-btn" onclick="loadAllProjects()">ğŸ”„ é‡æ–°è¼‰å…¥</button>
        </div>
    </div>

    <div class="main-container">
        <button class="panel-toggle" onclick="togglePanel()">â˜°</button>
        <div class="left-panel" id="leftPanel">
            <div class="filter-section">
                <div class="filter-title" onclick="toggleFilterSection(this)">
                    <span>ğŸ¯ é€²éšç¯©é¸</span>
                    <span class="collapse-icon">â–¼</span>
                </div>
                <div class="filter-content">
                    <div class="filter-group">
                        <div class="filter-label">ğŸ”„ æ’åºæ–¹å¼</div>
                        <select id="sortBy" class="filter-input" style="width:100%;margin-bottom:6px;">
                            <option value="transaction_count">äº¤æ˜“ç­†æ•¸ï¼ˆé è¨­ï¼‰</option>
                            <option value="date">æˆäº¤æ—¥æœŸ</option>
                            <option value="price">æˆäº¤é‡‘é¡</option>
                            <option value="unit_price">å–®åƒ¹</option>
                            <option value="area">åªæ•¸</option>
                            <option value="ratio">å…¬è¨­æ¯”</option>
                        </select>
                        <select id="sortOrder" class="filter-input" style="width:100%;">
                            <option value="desc">ç”±é«˜åˆ°ä½</option>
                            <option value="asc">ç”±ä½åˆ°é«˜</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <div class="filter-label">ç¸½åƒ¹ç¯„åœï¼ˆè¬å…ƒï¼‰</div>
                        <div class="filter-row">
                            <input type="number" id="minPrice" class="filter-input" placeholder="æœ€ä½">
                            <input type="number" id="maxPrice" class="filter-input" placeholder="æœ€é«˜">
                        </div>
                    </div>
                    <div class="filter-group">
                        <div class="filter-label" id="unitPriceLabel">å–®åƒ¹ç¯„åœï¼ˆå…ƒ/åªï¼‰</div>
                        <div class="filter-row">
                            <input type="number" id="minUnitPrice" class="filter-input" placeholder="æœ€ä½">
                            <input type="number" id="maxUnitPrice" class="filter-input" placeholder="æœ€é«˜">
                        </div>
                    </div>
                    <div class="filter-group">
                        <div class="filter-label">åªæ•¸ç¯„åœï¼ˆåªï¼‰</div>
                        <div class="filter-row">
                            <input type="number" id="minPing" class="filter-input" placeholder="æœ€ä½">
                            <input type="number" id="maxPing" class="filter-input" placeholder="æœ€é«˜">
                        </div>
                    </div>
                    <div class="filter-group">
                        <div class="filter-label">æˆäº¤å¹´ä»½ï¼ˆè¥¿å…ƒï¼‰</div>
                        <div class="filter-row">
                            <input type="number" id="minYear" class="filter-input" placeholder="æœ€æ—©" value="2020">
                            <input type="number" id="maxYear" class="filter-input" placeholder="æœ€æ™š" value="2026">
                        </div>
                    </div>
                    <div class="filter-group">
                        <div class="filter-label">å…¬è¨­æ¯”ç¯„åœï¼ˆ%ï¼‰</div>
                        <div class="filter-row">
                            <input type="number" id="minRatio" class="filter-input" placeholder="æœ€ä½">
                            <input type="number" id="maxRatio" class="filter-input" placeholder="æœ€é«˜">
                        </div>
                    </div>
                    <div class="filter-group">
                        <div class="filter-label">å»ºç‰©å‹æ…‹</div>
                        <select id="buildingType" class="filter-input" style="width:100%;">
                            <option value="">å…¨éƒ¨</option>
                            <option value="ä½å®…å¤§æ¨“">ä½å®…å¤§æ¨“</option>
                            <option value="è¯å»ˆ">è¯å»ˆ</option>
                            <option value="å…¬å¯“">å…¬å¯“</option>
                            <option value="é€å¤©å">é€å¤©å</option>
                            <option value="å¥—æˆ¿">å¥—æˆ¿</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <div class="filter-label">æˆ¿æ•¸</div>
                        <select id="roomCount" class="filter-input" style="width:100%;">
                            <option value="">å…¨éƒ¨</option>
                            <option value="1">1æˆ¿</option>
                            <option value="2">2æˆ¿</option>
                            <option value="3">3æˆ¿</option>
                            <option value="4">4æˆ¿</option>
                            <option value="5">5æˆ¿ä»¥ä¸Š</option>
                        </select>
                    </div>
                    <button class="apply-filter-btn" onclick="applyFilters()">å¥—ç”¨ç¯©é¸</button>
                    <button class="reset-filter-btn" onclick="resetFilters()">æ¸…é™¤ç¯©é¸</button>
                </div>
            </div>
            <div class="projects-list" id="projectsList">
                <div style="text-align:center;padding:30px 15px;color:#999;">
                    <div style="font-size:36px;margin-bottom:10px;">ğŸ¢</div>
                    <p style="font-size:13px;">è¼‰å…¥å»ºæ¡ˆä¸­...</p>
                </div>
            </div>
        </div>

        <div class="map-container">
            <div id="loadingOverlay" class="loading-overlay">
                <div class="loading-spinner"></div>
            </div>
            <div id="map"></div>
            <div class="map-controls">
                <button class="map-control-btn" onclick="map.zoomIn()" title="æ”¾å¤§">+</button>
                <button class="map-control-btn" onclick="map.zoomOut()" title="ç¸®å°">âˆ’</button>
                <button class="map-control-btn" onclick="resetMapView()" title="é‡ç½®">ğŸ¯</button>
            </div>
        </div>
    </div>

    <!-- å»ºæ¡ˆè©³æƒ…æ¨¡æ…‹æ¡† -->
    <div id="salesModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">è¼‰å…¥ä¸­...</div>
                <button class="close-btn" onclick="closeModal()">âœ•</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
        </div>
    </div>

    <script>
        // ===================== å…¨å±€è®Šæ•¸ =====================
        const API_BASE = 'http://localhost:5000';
        const PING_TO_SQM = 3.3057;
        const SQM_TO_PING = 1 / PING_TO_SQM;

        let map, markerClusterGroup, markers = [];
        let projects = [];
        let selectedProjectId = null;
        let currentUnit = 'ping';

        // ===================== åˆå§‹åŒ– Leaflet åœ°åœ– =====================
        function initMap() {
            map = L.map('map', {
                center: [25.0330, 121.5654],
                zoom: 12,
                zoomControl: false
            });

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
                maxZoom: 19
            }).addTo(map);

            markerClusterGroup = L.markerClusterGroup({
                maxClusterRadius: 50,
                spiderfyOnMaxZoom: true,
                showCoverageOnHover: false,
                iconCreateFunction: function(cluster) {
                    const count = cluster.getChildCount();
                    let size = 'small';
                    if (count > 50) size = 'large';
                    else if (count > 10) size = 'medium';
                    return L.divIcon({
                        html: '<div style="background:linear-gradient(135deg,#667eea,#764ba2);color:white;border-radius:50%;width:36px;height:36px;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:12px;border:3px solid white;box-shadow:0 2px 6px rgba(0,0,0,0.3);">' + count + '</div>',
                        className: 'price-marker',
                        iconSize: [36, 36]
                    });
                }
            });
            map.addLayer(markerClusterGroup);

            loadAllProjects();
        }

        // ===================== UI æ§åˆ¶ =====================
        function togglePanel() {
            document.getElementById('leftPanel').classList.toggle('open');
        }

        function toggleFilterSection(titleEl) {
            const contentEl = titleEl.nextElementSibling;
            const iconEl = titleEl.querySelector('.collapse-icon');
            contentEl.classList.toggle('collapsed');
            iconEl.classList.toggle('collapsed');
        }

        function setUnit(unit) {
            currentUnit = unit;
            document.getElementById('unitBtnSqm').classList.toggle('active', unit === 'sqm');
            document.getElementById('unitBtnPing').classList.toggle('active', unit === 'ping');
            document.getElementById('unitPriceLabel').textContent = unit === 'sqm' ? 'å–®åƒ¹ç¯„åœï¼ˆå…ƒ/ã¡ï¼‰' : 'å–®åƒ¹ç¯„åœï¼ˆå…ƒ/åªï¼‰';
            if (projects.length > 0) displayProjects(projects);
        }

        function convertArea(sqm) {
            return currentUnit === 'ping' ? (sqm * SQM_TO_PING).toFixed(2) : sqm.toFixed(2);
        }
        function convertUnitPrice(pricePerPing) {
            if (currentUnit === 'sqm') return (pricePerPing / PING_TO_SQM).toFixed(2);
            return pricePerPing.toFixed(2);
        }
        function getUnitText() { return currentUnit === 'ping' ? 'åª' : 'ã¡'; }
        function getUnitPriceText() { return currentUnit === 'ping' ? 'å…ƒ/åª' : 'å…ƒ/ã¡'; }

        // ===================== è¼‰å…¥è³‡æ–™ =====================
        async function loadAllProjects() {
            showLoading();
            try {
                const response = await fetch(`${API_BASE}/api/projects`);
                const result = await response.json();
                if (result.success) {
                    projects = result.projects || [];
                    displayProjects(projects);
                    addMarkersToMap(projects);
                } else {
                    alert('è¼‰å…¥å»ºæ¡ˆå¤±æ•—ï¼š' + (result.error || 'æœªçŸ¥éŒ¯èª¤'));
                }
            } catch (error) {
                console.error('è¼‰å…¥å»ºæ¡ˆå¤±æ•—:', error);
                document.getElementById('projectsList').innerHTML = '<div style="text-align:center;padding:30px 15px;color:#e74c3c;">âŒ ç„¡æ³•é€£æ¥ä¼ºæœå™¨</div>';
            } finally {
                hideLoading();
            }
        }

        // ===================== é¡¯ç¤ºå»ºæ¡ˆåˆ—è¡¨ =====================
        function displayProjects(projectList) {
            const container = document.getElementById('projectsList');
            if (!projectList || projectList.length === 0) {
                container.innerHTML = '<div style="text-align:center;padding:30px 15px;color:#999;"><div style="font-size:36px;margin-bottom:10px;">ğŸ˜”</div><p style="font-size:13px;">æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„å»ºæ¡ˆ</p></div>';
                return;
            }
            container.innerHTML = projectList.map(project => {
                // é˜²ç¦¦æ€§æª¢æŸ¥
                const projectId = (project?.id || '').toString();
                const projectName = (project?.name || 'æœªçŸ¥å»ºæ¡ˆ').substring(0, 25);
                const projectAddress = (project?.address || 'ä½ç½®ä¸è©³').substring(0, 35);
                const transCount = project?.transaction_count || 0;
                const avgPrice = project?.avg_price || 0;
                const avgPing = project?.avg_ping || 0;
                const avgRatio = project?.avg_ratio || 0;
                const latestDate = project?.latest_date || '-';
                const unitPrice = project?.avg_unit_price ? convertUnitPrice(project.avg_unit_price) : '0';

                // å®‰å…¨çš„ replace æ–¹æ³•
                const safeName = (projectName).replace(/'/g, "\\'").replace(/"/g, '\\"');
                const safeAddr = (projectAddress).replace(/'/g, "\\'").replace(/"/g, '\\"');

                return `
                    <div class="project-card ${selectedProjectId === projectId ? 'active' : ''}"
                         onclick="selectProject('${safeName}', '${safeAddr}', '${projectId}')">
                        <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:6px;">
                            <div style="flex:1; min-width:0;">
                                <div class="project-name">${projectName}</div>
                                <div class="project-address">ğŸ“ ${projectAddress}</div>
                            </div>
                            <span class="project-badge">${transCount} ç­†</span>
                        </div>
                        <div class="project-price">${formatPrice(avgPrice)}</div>
                        <div class="project-stats">
                            <div class="stat-item"><span style="color:#999;">å–®åƒ¹:</span>${unitPrice} ${getUnitPriceText()}</div>
                            <div class="stat-item"><span style="color:#999;">åªæ•¸:</span>${avgPing.toFixed(2)} åª</div>
                            <div class="stat-item"><span style="color:#999;">å…¬è¨­:</span>${avgRatio.toFixed(1)}%</div>
                            <div class="stat-item"><span style="color:#999;">æœ€æ–°:</span>${latestDate}</div>
                        </div>
                    </div>`;
            }).join('');
        }

        // ===================== åœ°åœ–æ¨™è¨˜ =====================
        function addMarkersToMap(projectList) {
            markerClusterGroup.clearLayers();
            markers = [];
            const bounds = L.latLngBounds();

            if (!projectList || projectList.length === 0) return;

            projectList.forEach(project => {
                if (!project?.lat || !project?.lng) return;

                const color = getPriceColor(project.avg_price || 0);
                const priceShort = formatPriceShort(project.avg_price || 0);

                const icon = L.divIcon({
                    html: `<div style="background:${color};border-radius:50%;width:32px;height:32px;display:flex;align-items:center;justify-content:center;color:white;font-size:9px;font-weight:bold;border:3px solid white;box-shadow:0 2px 6px rgba(0,0,0,0.3);">${priceShort}</div>`,
                    className: 'price-marker',
                    iconSize: [32, 32],
                    iconAnchor: [16, 16]
                });

                const marker = L.marker([project.lat, project.lng], { icon: icon });
                marker.bindPopup(`
                    <div style="min-width:180px;font-size:12px;">
                        <b>${project.name || 'æœªçŸ¥'}</b><br>
                        ğŸ“ ${project.address || 'ä½ç½®ä¸è©³'}<br>
                        ğŸ’° ${formatPrice(project.avg_price || 0)}<br>
                        ğŸ“ ${project.avg_ping ? project.avg_ping.toFixed(2) : '-'} åª<br>
                        ğŸ“Š ${project.transaction_count || 0} ç­†äº¤æ˜“
                    </div>
                `);
                marker.on('click', () => selectProject(project.name || '', project.address || '', project.id || ''));

                markerClusterGroup.addLayer(marker);
                markers.push(marker);
                bounds.extend([project.lat, project.lng]);
            });

            if (markers.length > 0) {
                try { map.fitBounds(bounds, { padding: [50, 50] }); } catch(e) {}
            }
        }

        // ===================== å»ºæ¡ˆæ“ä½œ =====================
        function selectProject(projectName, projectAddr, projectId) {
            selectedProjectId = projectId;
            displayProjects(projects);
            showProjectDetail(projectId, projectAddr, projectName);
        }

        async function showProjectDetail(projectId, address, projectName) {
            document.getElementById('modalTitle').textContent = 'è¼‰å…¥ä¸­...';
            document.getElementById('salesModal').classList.add('active');
            
            // å¦‚æœæ²’æœ‰å»ºæ¡ˆåç¨±ï¼Œå…ˆç”¨ address2community API æŸ¥è©¢
            let finalProjectName = projectName;
            if (!projectName || projectName === 'æœªçŸ¥') {
                try {
                    const a2cResponse = await fetch(`${API_BASE}/api/address2community?address=${encodeURIComponent(address)}`);
                    const a2cResult = await a2cResponse.json();
                    if (a2cResult.success && a2cResult.best) {
                        finalProjectName = a2cResult.best;
                        document.getElementById('modalTitle').textContent = `ğŸ˜ï¸ ${finalProjectName}`;
                    }
                } catch (error) {
                    console.log('address2community æŸ¥è©¢å¤±æ•—:', error);
                }
            }
            
            try {
                // å˜—è©¦1: ç”¨å»ºæ¡ˆåç¨±æœå°‹
                let searchResult = null;
                if (finalProjectName && finalProjectName !== 'æœªçŸ¥') {
                    const response1 = await fetch(`${API_BASE}/api/projects?keyword=${encodeURIComponent(finalProjectName)}&limit=1`);
                    const result1 = await response1.json();
                    if (result1.success && result1.projects && result1.projects.length > 0) {
                        searchResult = result1.projects[0];
                    }
                }
                
                // å˜—è©¦2: ç”¨åœ°å€æœå°‹ï¼ˆå‚™ç”¨æ–¹æ¡ˆï¼‰
                if (!searchResult) {
                    const response2 = await fetch(`${API_BASE}/api/projects?keyword=${encodeURIComponent(address)}&limit=1`);
                    const result2 = await response2.json();
                    if (result2.success && result2.projects && result2.projects.length > 0) {
                        searchResult = result2.projects[0];
                    }
                }
                
                if (searchResult) {
                    // å–å¾—è©²å»ºæ¡ˆçš„è©³ç´°äº¤æ˜“è³‡æ–™
                    const detailResponse = await fetch(`${API_BASE}/api/project/${searchResult.id}?address=${encodeURIComponent(address)}`);
                    const detailResult = await detailResponse.json();
                    if (detailResult.success && detailResult.transactions && detailResult.transactions.length > 0) {
                        // å°‡ transactions æ·»åŠ åˆ° project ç‰©ä»¶ä¸­ä»¥ä¾› renderProjectDetail ä½¿ç”¨
                        const projectWithTx = {
                            ...detailResult.project,
                            transactions: detailResult.transactions,
                            sales_control: detailResult.summary
                        };
                        renderProjectDetail(projectWithTx, finalProjectName || searchResult.name);
                    } else {
                        document.getElementById('modalBody').innerHTML = `<p style="text-align:center;padding:30px;">ğŸ“­ æ­¤åœ°å€æš«ç„¡äº¤æ˜“ç´€éŒ„<br><small style="color:#999;">åœ°å€: ${address}<br>å»ºæ¡ˆ: ${finalProjectName || 'æœªçŸ¥'}</small></p>`;
                    }
                } else {
                    document.getElementById('modalBody').innerHTML = `<p style="text-align:center;padding:30px;">ğŸ“­ æ­¤åœ°å€æš«ç„¡äº¤æ˜“ç´€éŒ„<br><small style="color:#999;">åœ°å€: ${address}<br>å»ºæ¡ˆ: ${finalProjectName || 'æœªçŸ¥'}</small></p>`;
                }
            } catch (error) {
                console.error('è¼‰å…¥è©³æƒ…å¤±æ•—:', error);
                document.getElementById('modalBody').innerHTML = '<p style="text-align:center;padding:30px;">âŒ ç„¡æ³•è¼‰å…¥è©³æƒ…</p>';
            }
        }

        function renderProjectDetail(project, customTitle) {
            if (!project?.transactions || project.transactions.length === 0) {
                document.getElementById('modalBody').innerHTML = '<p>ğŸ“­ æš«ç„¡äº¤æ˜“ç´€éŒ„</p>';
                return;
            }

            const transactions = project.transactions;
            const salesControl = project.sales_control || {};
            
            // å–å¾—ç¬¬ä¸€ç­†äº¤æ˜“çš„åœ°å€ï¼ˆæ”¯æ´æ–°èˆŠæ ¼å¼ï¼‰
            const firstAddr = transactions[0]?.address || transactions[0]?.['åœŸåœ°ä½ç½®å»ºç‰©é–€ç‰Œ'] || 'å»ºæ¡ˆè©³æƒ…';
            document.getElementById('modalTitle').textContent = customTitle || firstAddr;

            // è¨ˆç®—å¹³å‡å€¼ï¼ˆæ”¯æ´æ–°èˆŠæ ¼å¼ï¼‰
            const avgPrice = transactions.reduce((s, t) => s + (parseFloat(t.price || t['ç¸½åƒ¹å…ƒ']) || 0), 0) / transactions.length;
            const avgUnitPrice = transactions.reduce((s, t) => s + (parseFloat(t.unit_price_sqm || t['å–®åƒ¹å…ƒå¹³æ–¹å…¬å°º']) || 0), 0) / transactions.length;
            const avgArea = transactions.reduce((s, t) => s + (parseFloat(t.area_sqm || t['å»ºç‰©ç§»è½‰ç¸½é¢ç©å¹³æ–¹å…¬å°º']) || 0), 0) / transactions.length;
            const avgPing = avgArea / PING_TO_SQM;
            const avgUPPing = avgUnitPrice * PING_TO_SQM;

            let html = `
                <div class="project-detail-header">
                    <div class="detail-stat-card"><div class="detail-stat-label">ç¸½äº¤æ˜“æ•¸</div><div class="detail-stat-value">${salesControl.total_transactions || salesControl.total_units || transactions.length}</div></div>
                    <div class="detail-stat-card"><div class="detail-stat-label">å¹³å‡ç¸½åƒ¹</div><div class="detail-stat-value">${formatPriceShort(avgPrice)}</div></div>
                    <div class="detail-stat-card"><div class="detail-stat-label">å¹³å‡å–®åƒ¹</div><div class="detail-stat-value">${convertUnitPrice(avgUPPing)}<br><span style="font-size:12px;">${getUnitPriceText()}</span></div></div>
                    <div class="detail-stat-card"><div class="detail-stat-label">å¹³å‡é¢ç©</div><div class="detail-stat-value">${avgPing.toFixed(2)}<br><span style="font-size:12px;">åª</span></div></div>
                </div>
                <div><div class="section-title">ğŸ“‹ äº¤æ˜“ç´€éŒ„</div><div class="sales-grid">`;

            transactions.forEach(trans => {
                const price = parseFloat(trans.price || trans['ç¸½åƒ¹å…ƒ']) || 0;
                const floor = trans.floor || trans['ç§»è½‰å±¤æ¬¡'] || '?';
                const date = trans.date || trans['äº¤æ˜“å¹´æœˆæ—¥'] || '';
                html += `<div class="unit-cell sold" title="${date}"><div class="unit-number">${floor}</div><div class="unit-price">${formatPriceShort(price)}</div></div>`;
            });

            html += `</div></div><div style="margin-top:20px;"><div class="section-title">ğŸ“Š è©³ç´°ç´€éŒ„</div>
                <table class="transactions-table"><thead><tr><th>æ—¥æœŸ</th><th>æ¨“å±¤</th><th>æˆ¿/å»³/è¡›</th><th>é¢ç©</th><th>ç¸½åƒ¹</th><th>å–®åƒ¹</th></tr></thead><tbody>`;

            transactions.slice(0, 20).forEach(trans => {
                const area = parseFloat(trans.area_sqm || trans['å»ºç‰©ç§»è½‰ç¸½é¢ç©å¹³æ–¹å…¬å°º']) || 0;
                const unitPrice = parseFloat(trans.unit_price_sqm || trans['å–®åƒ¹å…ƒå¹³æ–¹å…¬å°º']) || 0;
                const ping = area / PING_TO_SQM;
                const upPing = unitPrice * PING_TO_SQM;
                const floor = trans.floor || trans['ç§»è½‰å±¤æ¬¡'] || '-';
                const totalFloor = trans.total_floor || trans['ç¸½æ¨“å±¤æ•¸'] || '-';
                const price = trans.price || trans['ç¸½åƒ¹å…ƒ'];
                const date = trans.date || trans['äº¤æ˜“å¹´æœˆæ—¥'] || '-';
                const rooms = trans.rooms || trans['å»ºç‰©ç¾æ³æ ¼å±€-æˆ¿'] || '0';
                const halls = trans.halls || trans['å»ºç‰©ç¾æ³æ ¼å±€-å»³'] || '0';
                const baths = trans.baths || trans['å»ºç‰©ç¾æ³æ ¼å±€-è¡›'] || '0';
                
                html += `<tr>
                    <td>${date}</td>
                    <td>${floor}/${totalFloor}</td>
                    <td>${rooms}æˆ¿${halls}å»³${baths}è¡›</td>
                    <td>${ping.toFixed(1)} åª</td>
                    <td style="color:#e74c3c;font-weight:600;">${formatPrice(price)}</td>
                    <td>${convertUnitPrice(upPing)} ${getUnitPriceText()}</td>
                </tr>`;
            });

            html += '</tbody></table></div>';
            document.getElementById('modalBody').innerHTML = html;
        }

        function closeModal() { 
            document.getElementById('salesModal').classList.remove('active'); 
            selectedProjectId = null;
            displayProjects(projects);
        }

        // ===================== æœå°‹ & ç¯©é¸ =====================
        async function performSearch() {
            const keyword = document.getElementById('mainSearch').value.trim();
            if (!keyword) { loadAllProjects(); return; }
            showLoading();
            try {
                const response = await fetch(`${API_BASE}/api/projects?keyword=${encodeURIComponent(keyword)}&limit=200`);
                const result = await response.json();
                if (result.success) {
                    projects = result.projects || [];
                    displayProjects(projects);
                    addMarkersToMap(projects);
                    if (window.innerWidth <= 1024) {
                        document.getElementById('leftPanel').classList.remove('open');
                    }
                }
            } catch (error) {
                console.error('æœå°‹å¤±æ•—:', error);
                alert('æœå°‹å¤±æ•—ï¼š' + error.message);
            } finally { hideLoading(); }
        }

        async function applyFilters() {
            showLoading();
            try {
                let url = `${API_BASE}/api/projects?limit=200`;
                const keyword = document.getElementById('mainSearch').value.trim();
                if (keyword) url += `&keyword=${encodeURIComponent(keyword)}`;
                
                url += `&sort_by=${document.getElementById('sortBy').value}`;
                url += `&sort_order=${document.getElementById('sortOrder').value}`;

                const minPrice = document.getElementById('minPrice').value;
                const maxPrice = document.getElementById('maxPrice').value;
                if (minPrice) url += `&min_price=${parseFloat(minPrice) * 10000}`;
                if (maxPrice) url += `&max_price=${parseFloat(maxPrice) * 10000}`;

                const minUP = document.getElementById('minUnitPrice').value;
                const maxUP = document.getElementById('maxUnitPrice').value;
                if (minUP) url += `&min_unit_price=${parseFloat(minUP)}`;
                if (maxUP) url += `&max_unit_price=${parseFloat(maxUP)}`;

                const minPing = document.getElementById('minPing').value;
                const maxPing = document.getElementById('maxPing').value;
                if (minPing) url += `&min_ping=${parseFloat(minPing)}`;
                if (maxPing) url += `&max_ping=${parseFloat(maxPing)}`;

                const minYear = document.getElementById('minYear').value;
                const maxYear = document.getElementById('maxYear').value;
                if (minYear) url += `&min_year=${parseInt(minYear) - 1911}`;
                if (maxYear) url += `&max_year=${parseInt(maxYear) - 1911}`;

                const minR = document.getElementById('minRatio').value;
                const maxR = document.getElementById('maxRatio').value;
                if (minR) url += `&min_ratio=${parseFloat(minR)}`;
                if (maxR) url += `&max_ratio=${parseFloat(maxR)}`;

                const bt = document.getElementById('buildingType').value;
                if (bt) url += `&building_type=${encodeURIComponent(bt)}`;
                const rc = document.getElementById('roomCount').value;
                if (rc) url += `&room_count=${rc}`;

                const response = await fetch(url);
                const result = await response.json();
                if (result.success) {
                    projects = result.projects || [];
                    displayProjects(projects);
                    addMarkersToMap(projects);
                }
            } catch (error) { 
                console.error('ç¯©é¸å¤±æ•—:', error);
                alert('ç¯©é¸å¤±æ•—ï¼š' + error.message); 
            } finally { hideLoading(); }
        }

        function resetFilters() {
            document.getElementById('sortBy').value = 'transaction_count';
            document.getElementById('sortOrder').value = 'desc';
            document.getElementById('minPrice').value = '';
            document.getElementById('maxPrice').value = '';
            document.getElementById('minUnitPrice').value = '';
            document.getElementById('maxUnitPrice').value = '';
            document.getElementById('minPing').value = '';
            document.getElementById('maxPing').value = '';
            document.getElementById('minYear').value = '2020';
            document.getElementById('maxYear').value = '2026';
            document.getElementById('minRatio').value = '';
            document.getElementById('maxRatio').value = '';
            document.getElementById('buildingType').value = '';
            document.getElementById('roomCount').value = '';
            applyFilters();
        }

        // ===================== å·¥å…·å‡½æ•¸ =====================
        function getPriceColor(price) {
            if (price < 10000000) return '#4caf50';
            if (price < 20000000) return '#2196f3';
            if (price < 50000000) return '#ff9800';
            return '#f44336';
        }
        function formatPrice(price) {
            const num = parseFloat(price) || 0;
            if (num >= 100000000) return (num / 100000000).toFixed(2) + ' å„„å…ƒ';
            if (num >= 10000) return (num / 10000).toFixed(0) + ' è¬å…ƒ';
            return num.toFixed(0) + ' å…ƒ';
        }
        function formatPriceShort(price) {
            const num = parseFloat(price) || 0;
            if (num >= 100000000) return (num / 100000000).toFixed(1) + 'å„„';
            if (num >= 10000) return (num / 10000).toFixed(0) + 'è¬';
            return num.toFixed(0);
        }
        function resetMapView() { map.setView([25.0330, 121.5654], 12); }
        function showLoading() { document.getElementById('loadingOverlay').classList.remove('hidden'); }
        function hideLoading() { document.getElementById('loadingOverlay').classList.add('hidden'); }

        document.getElementById('salesModal').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });

        document.addEventListener('DOMContentLoaded', initMap);
    </script>
</body>
</html>
