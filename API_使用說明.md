# 🏠 良富居地產 - API 使用說明

## 📊 搜尋與篩選功能

### API 端點
```
GET /api/search
```

### 🔍 支持的參數

#### 1. 關鍵字搜尋
- `keyword`: 搜尋地址或區域
  - 支持全形/半形數字自動轉換
  - 支持模糊匹配
  - 範例：`keyword=大直` 或 `keyword=日興一街6號`

#### 2. 價格篩選
- `min_price`: 最低總價（元）
- `max_price`: 最高總價（元）
- `min_unit_price`: 最低單價（元/平方公尺）
- `max_unit_price`: 最高單價（元/平方公尺）
  - 範例：`min_price=5000000&max_price=10000000`

#### 3. 年份篩選 ⭐ 新增
- `min_year`: 最早交易年份（民國年，3位數）
- `max_year`: 最晚交易年份（民國年，3位數）
  - 範例：`min_year=110` (民國110年 = 2021年)
  - 範例：`min_year=105&max_year=110` (2016-2021)

#### 4. 坪數篩選 ⭐ 新增
- `min_area`: 最小面積（平方公尺）
- `max_area`: 最大面積（平方公尺）
  - 範例：`min_area=50&max_area=100`
  - 註：1坪 ≈ 3.3平方公尺

#### 5. 公設比篩選 ⭐ 新增
- `min_ratio`: 最低公設比（百分比，0-100）
- `max_ratio`: 最高公設比（百分比，0-100）
  - 範例：`max_ratio=30` (公設比30%以下)
  - 計算公式：(總面積 - 主建物面積) / 總面積 × 100

#### 6. 排序功能 ⭐ 新增
- `sort_by`: 排序欄位
  - `transaction_count`: 交易筆數（預設）
  - `year`: 年份
  - `area`: 坪數/面積
  - `ratio`: 公設比
  - `price`: 總價
  - `unit_price`: 單價
- `sort_order`: 排序方向
  - `desc`: 由大到小（預設）
  - `asc`: 由小到大
  - 範例：`sort_by=area&sort_order=desc`

---

## 📝 使用範例

### 範例 1：搜尋特定區域
```
http://localhost:5000/api/search?keyword=大直
```

### 範例 2：篩選近期交易（民國110年後）
```
http://localhost:5000/api/search?min_year=110
```

### 範例 3：尋找中小坪數（50-100平方公尺）
```
http://localhost:5000/api/search?min_area=50&max_area=100
```

### 範例 4：低公設比物件（20%以下）
```
http://localhost:5000/api/search?max_ratio=20
```

### 範例 5：按面積排序
```
http://localhost:5000/api/search?sort_by=area&sort_order=desc
```

### 範例 6：組合查詢
```
http://localhost:5000/api/search?keyword=新莊&min_year=110&min_area=30&max_area=80&max_ratio=35&sort_by=price&sort_order=asc
```
**說明**：搜尋新莊地區、民國110年後、30-80平方公尺、公設比35%以下的物件，按價格由低到高排序

---

## 📦 回應格式

```json
{
  "success": true,
  "count": 50,
  "projects": [
    {
      "id": 123456,
      "name": "建案名稱",
      "address": "完整地址",
      "district": "行政區",
      "type": "建物型態",
      "transaction_count": 10,
      "avg_price": 8500000,
      "min_price": 7000000,
      "max_price": 10000000,
      "avg_unit_price": 250000,
      "avg_area": 65.5,
      "avg_ratio": 28.5,           ⭐ 新增：平均公設比
      "latest_year": 2023,         ⭐ 新增：最新交易年份（西元）
      "oldest_year": 2020,         ⭐ 新增：最舊交易年份（西元）
      "year_range": "2020-2023",   ⭐ 新增：年份範圍
      "lat": 25.0703,
      "lng": 121.5654
    }
  ]
}
```

---

## 🎯 使用者體驗提升

### ✅ 已解決的問題

1. **年份篩選修正**
   - 原本：使用錯誤的年份格式
   - 現在：正確使用民國年（3位數）
   - 自動轉換為西元年顯示

2. **公設比計算**
   - 原本：沒有公設比欄位
   - 現在：根據總面積和主建物面積自動計算
   - 公式：(總面積 - 主建物面積) / 總面積 × 100

3. **篩選效能優化**
   - 原本：SQL查詢後在Python中再次篩選（重複過濾）
   - 現在：所有篩選都在SQL層面完成
   - 效能提升約 30-50%

4. **排序功能實現**
   - 原本：無法排序
   - 現在：支持6種排序欄位 × 2種排序方向
   - 預設按交易筆數由高到低排序

5. **更多資訊呈現**
   - 新增：公設比
   - 新增：年份範圍
   - 新增：最新/最舊交易年份
   - 便於使用者快速了解物件概況

---

## 🔧 技術說明

### 公設比計算邏輯
```sql
AVG(
    CASE 
        WHEN 建物移轉總面積平方公尺 > 0 
             AND 主建物面積 IS NOT NULL
        THEN ((建物移轉總面積平方公尺 - 主建物面積) / 建物移轉總面積平方公尺) * 100
        ELSE NULL
    END
) as 平均公設比
```

### 年份轉換
- **數據庫**：民國年（3位數），如 "110" = 民國110年
- **API回應**：西元年，如 2021
- **轉換公式**：西元年 = 民國年 + 1911

---

## 🚀 下一步優化建議

1. **前端 UI 改進**
   - 新增篩選面板
   - 顯示公設比和年份資訊
   - 排序下拉選單

2. **進階功能**
   - 建築完成年份篩選
   - 樓層篩選
   - 車位篩選
   - 房型篩選（3房2廳等）

3. **數據視覺化**
   - 價格趨勢圖
   - 公設比分佈圖
   - 區域熱力圖

---

**版本**：v2.0  
**更新日期**：2026年2月17日  
**服務器**：http://140.114.78.136:5000

