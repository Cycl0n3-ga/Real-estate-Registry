<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‰¯å¯Œå±…åœ°ç”¢ - å°ˆæ¥­æˆ¿åœ°ç”¢åœ°åœ–ç³»çµ±</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Microsoft JhengHei', 'Segoe UI', Arial, sans-serif;
            overflow: hidden;
        }
        
        /* é ‚éƒ¨å°èˆª */
        .top-nav {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 15px 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            z-index: 2000;
            position: relative;
        }
        
        .logo {
            font-size: 28px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .search-bar {
            flex: 1;
            max-width: 500px;
            margin: 0 30px;
            position: relative;
        }
        
        .search-input {
            width: 100%;
            padding: 12px 45px 12px 20px;
            border: none;
            border-radius: 25px;
            font-size: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        .search-btn {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            border: none;
            padding: 8px 20px;
            border-radius: 20px;
            color: white;
            cursor: pointer;
            font-weight: 600;
        }
        
        .nav-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .unit-toggle {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            padding: 6px 4px;
            border-radius: 20px;
            display: flex;
            gap: 4px;
        }
        
        .unit-btn {
            background: transparent;
            border: none;
            padding: 6px 16px;
            border-radius: 16px;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 13px;
        }
        
        .unit-btn.active {
            background: white;
            color: #1e3c72;
            font-weight: 600;
        }
        
        .nav-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            padding: 8px 20px;
            border-radius: 20px;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .nav-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        /* ä¸»å…§å®¹å€ */
        .main-container {
            display: flex;
            height: calc(100vh - 70px);
        }
        
        /* å·¦å´é¢æ¿ */
        .left-panel {
            width: 400px;
            background: white;
            overflow-y: auto;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        
        .filter-section {
            padding: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .filter-title {
            font-weight: 600;
            margin-bottom: 15px;
            font-size: 16px;
            color: #333;
        }
        
        .filter-group {
            margin-bottom: 15px;
        }
        
        .filter-label {
            font-size: 13px;
            color: #666;
            margin-bottom: 8px;
            display: block;
        }
        
        .filter-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .filter-input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .apply-filter-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
        }
        
        .apply-filter-btn:hover {
            opacity: 0.9;
        }
        
        .projects-list {
            padding: 15px;
        }
        
        .project-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .project-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }
        
        .project-card.active {
            border-color: #667eea;
            background: linear-gradient(135deg, rgba(102,126,234,0.05) 0%, rgba(118,75,162,0.05) 100%);
        }
        
        .project-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }
        
        .project-name {
            font-weight: 600;
            font-size: 16px;
            color: #333;
            margin-bottom: 5px;
        }
        
        .project-badge {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .project-address {
            font-size: 13px;
            color: #666;
            margin-bottom: 10px;
        }
        
        .project-price {
            font-size: 22px;
            color: #e74c3c;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .project-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 10px;
        }
        
        .stat-item {
            font-size: 13px;
            color: #666;
        }
        
        .stat-label {
            color: #999;
            margin-right: 5px;
        }
        
        /* åœ°åœ–å€åŸŸ */
        .map-container {
            flex: 1;
            position: relative;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        /* åœ°åœ–æ§åˆ¶æŒ‰éˆ• */
        .map-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .map-control-btn {
            background: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            cursor: pointer;
            font-size: 18px;
            transition: all 0.3s;
        }
        
        .map-control-btn:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        /* éŠ·æ§é¢æ¿æ¨¡æ…‹æ¡† */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 3000;
            justify-content: center;
            align-items: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 20px;
            width: 90%;
            max-width: 1200px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px 30px;
            border-radius: 20px 20px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            font-size: 24px;
            font-weight: bold;
        }
        
        .close-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            font-size: 28px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .close-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: rotate(90deg);
        }
        
        .modal-body {
            padding: 30px;
        }
        
        /* å»ºæ¡ˆè©³æƒ… */
        .project-detail-header {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .detail-stat-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }
        
        .detail-stat-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }
        
        .detail-stat-value {
            font-size: 28px;
            font-weight: bold;
            color: #333;
        }
        
        /* éŠ·æ§è¡¨ */
        .sales-control-section {
            margin-top: 30px;
        }
        
        .section-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333;
        }
        
        .sales-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 20px;
        }
        
        .unit-cell {
            aspect-ratio: 1;
            border: 2px solid #ddd;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
            padding: 10px;
        }
        
        .unit-cell.sold {
            background: #ffebee;
            border-color: #e74c3c;
        }
        
        .unit-cell:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .unit-number {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 5px;
        }
        
        .unit-price {
            font-size: 11px;
            color: #666;
        }
        
        /* äº¤æ˜“è¨˜éŒ„ */
        .transactions-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .transactions-table th {
            background: #f5f5f5;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #ddd;
        }
        
        .transactions-table td {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }
        
        .transactions-table tr:hover {
            background: #f9f9f9;
        }
        
        /* è¼‰å…¥å‹•ç•« */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .hidden {
            display: none !important;
        }
        
        /* åƒ¹æ ¼åœ–ä¾‹ */
        .price-legend {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
            font-size: 13px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 8px;
        }
    </style>
</head>
<body>
    <!-- é ‚éƒ¨å°èˆª -->
    <div class="top-nav">
        <div class="logo">
            ğŸ  è‰¯å¯Œå±…åœ°ç”¢
        </div>
        <div class="search-bar">
            <input type="text" 
                   id="mainSearch" 
                   class="search-input" 
                   placeholder="æœå°‹åœ°å€ã€å»ºæ¡ˆåç¨±ã€åœ°å€..."
                   onkeypress="if(event.key==='Enter') performSearch()">
            <button class="search-btn" onclick="performSearch()">æœå°‹</button>
        </div>
        <div class="nav-actions">
            <div class="unit-toggle">
                <button class="unit-btn active" id="unitBtnSqm" onclick="setUnit('sqm')">ã¡</button>
                <button class="unit-btn" id="unitBtnPing" onclick="setUnit('ping')">åª</button>
            </div>
            <button class="nav-btn" onclick="loadAllProjects()">ğŸ”„ é‡æ–°è¼‰å…¥</button>
        </div>
    </div>

    <!-- ä¸»å…§å®¹å€ -->
    <div class="main-container">
        <!-- å·¦å´å»ºæ¡ˆåˆ—è¡¨ -->
        <div class="left-panel">
            <!-- ç¯©é¸å€ -->
            <div class="filter-section">
                <div class="filter-title">ğŸ¯ é€²éšç¯©é¸</div>
                
                <div class="filter-group">
                    <div class="filter-label">ç¸½åƒ¹ç¯„åœï¼ˆè¬å…ƒï¼‰</div>
                    <div class="filter-row">
                        <input type="number" id="minPrice" class="filter-input" placeholder="æœ€ä½">
                        <input type="number" id="maxPrice" class="filter-input" placeholder="æœ€é«˜">
                    </div>
                </div>
                
                <div class="filter-group">
                    <div class="filter-label" id="unitPriceLabel">å–®åƒ¹ç¯„åœï¼ˆå…ƒ/ã¡ï¼‰</div>
                    <div class="filter-row">
                        <input type="number" id="minUnitPrice" class="filter-input" placeholder="æœ€ä½">
                        <input type="number" id="maxUnitPrice" class="filter-input" placeholder="æœ€é«˜">
                    </div>
                </div>
                
                <button class="apply-filter-btn" onclick="applyFilters()">å¥—ç”¨ç¯©é¸</button>
            </div>

            <!-- å»ºæ¡ˆåˆ—è¡¨ -->
            <div class="projects-list" id="projectsList">
                <div style="text-align: center; padding: 40px 20px; color: #999;">
                    <div style="font-size: 48px; margin-bottom: 15px;">ğŸ¢</div>
                    <p>è¼‰å…¥å»ºæ¡ˆä¸­...</p>
                </div>
            </div>
        </div>

        <!-- å³å´åœ°åœ– -->
        <div class="map-container">
            <div id="loadingOverlay" class="loading-overlay">
                <div class="loading-spinner"></div>
            </div>
            
            <div id="map"></div>
            
            <!-- åœ°åœ–æ§åˆ¶ -->
            <div class="map-controls">
                <button class="map-control-btn" onclick="map.setZoom(map.getZoom() + 1)" title="æ”¾å¤§">+</button>
                <button class="map-control-btn" onclick="map.setZoom(map.getZoom() - 1)" title="ç¸®å°">-</button>
                <button class="map-control-btn" onclick="resetMapView()" title="é‡ç½®">ğŸ¯</button>
            </div>
            
            <!-- åƒ¹æ ¼åœ–ä¾‹ -->
            <div class="price-legend">
                <div style="font-weight: 600; margin-bottom: 10px;">ğŸ’° åƒ¹æ ¼ç¯„åœ</div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #4caf50;"></div>
                    <span>&lt; 1000è¬</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #2196f3;"></div>
                    <span>1000è¬ - 2000è¬</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ff9800;"></div>
                    <span>2000è¬ - 5000è¬</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #f44336;"></div>
                    <span>&gt; 5000è¬</span>
                </div>
            </div>
        </div>
    </div>

    <!-- éŠ·æ§é¢æ¿æ¨¡æ…‹æ¡† -->
    <div id="salesModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">å»ºæ¡ˆéŠ·æ§é¢æ¿</div>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- å‹•æ…‹è¼‰å…¥å…§å®¹ -->
            </div>
        </div>
    </div>

    <script>
        // å‹•æ…‹è¨­å®š API åŸºç¤ URLï¼Œæ”¯æ´ä»»ä½•åœ°å€è¨ªå•
        const API_BASE = `${window.location.protocol}//${window.location.host}`;
        const SQM_TO_PING = 0.3025; // 1å¹³æ–¹å…¬å°º = 0.3025åª
        const PING_TO_SQM = 3.3058; // 1åª = 3.3058å¹³æ–¹å…¬å°º
        
        let map, infoWindow;
        let markers = [];
        let projects = [];
        let selectedProjectId = null;
        let currentUnit = 'sqm'; // 'sqm' æˆ– 'ping'

        // åˆå§‹åŒ–åœ°åœ–
        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: 25.0330, lng: 121.5654 },
                zoom: 12,
                styles: [
                    {
                        featureType: "poi.business",
                        stylers: [{ visibility: "off" }]
                    }
                ],
                mapTypeControl: false,
                streetViewControl: false
            });
            
            infoWindow = new google.maps.InfoWindow();
            
            loadAllProjects();
            hideLoading();
        }

        // è¨­å®šå–®ä½
        function setUnit(unit) {
            currentUnit = unit;
            document.getElementById('unitBtnSqm').classList.toggle('active', unit === 'sqm');
            document.getElementById('unitBtnPing').classList.toggle('active', unit === 'ping');
            
            // æ›´æ–°æ¨™ç±¤
            const label = document.getElementById('unitPriceLabel');
            label.textContent = unit === 'sqm' ? 'å–®åƒ¹ç¯„åœï¼ˆå…ƒ/ã¡ï¼‰' : 'å–®åƒ¹ç¯„åœï¼ˆè¬å…ƒ/åªï¼‰';
            
            // é‡æ–°é¡¯ç¤ºåˆ—è¡¨
            if (projects.length > 0) {
                displayProjects(projects);
            }
        }

        // è½‰æ›é¢ç©
        function convertArea(sqm) {
            return currentUnit === 'ping' ? (sqm * SQM_TO_PING).toFixed(2) : sqm.toFixed(2);
        }

        // è½‰æ›å–®åƒ¹
        function convertUnitPrice(pricePerSqm) {
            if (currentUnit === 'ping') {
                // å…ƒ/åª = å…ƒ/ã¡ Ã— 3.3058 / 10000 è¬
                return ((pricePerSqm * PING_TO_SQM) / 10000).toFixed(2);
            }
            return pricePerSqm.toFixed(2);
        }

        // ç²å–å–®ä½æ–‡å­—
        function getUnitText() {
            return currentUnit === 'ping' ? 'åª' : 'ã¡';
        }

        // ç²å–å–®åƒ¹å–®ä½æ–‡å­—
        function getUnitPriceText() {
            return currentUnit === 'ping' ? 'è¬/åª' : 'å…ƒ/ã¡';
        }

        // è¼‰å…¥æ‰€æœ‰å»ºæ¡ˆ
        async function loadAllProjects() {
            showLoading();
            try {
                const response = await fetch(`${API_BASE}/api/projects`);
                const result = await response.json();
                
                if (result.success) {
                    projects = result.projects;
                    displayProjects(projects);
                    addMarkersToMap(projects);
                } else {
                    console.error('è¼‰å…¥å¤±æ•—:', result.error);
                    alert('è¼‰å…¥å»ºæ¡ˆå¤±æ•—ï¼š' + result.error);
                }
            } catch (error) {
                console.error('è¼‰å…¥å»ºæ¡ˆå¤±æ•—:', error);
                alert('è¼‰å…¥å»ºæ¡ˆå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
            } finally {
                hideLoading();
            }
        }

        // é¡¯ç¤ºå»ºæ¡ˆåˆ—è¡¨
        function displayProjects(projectList) {
            const container = document.getElementById('projectsList');
            
            if (projectList.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: #999;">
                        <div style="font-size: 48px; margin-bottom: 15px;">ğŸ˜”</div>
                        <p>æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„å»ºæ¡ˆ</p>
                    </div>
                `;
                return;
            }
            
            const html = projectList.map(project => {
                const unitPrice = convertUnitPrice(project.avg_unit_price);
                const avgArea = convertArea(project.avg_area);
                
                return `
                    <div class="project-card ${selectedProjectId === project.id ? 'active' : ''}" 
                         onclick="selectProject(${project.id}, '${project.address.replace(/'/g, "\\'")}')">
                        <div class="project-header">
                            <div>
                                <div class="project-name">${project.name}</div>
                                <div class="project-address">ğŸ“ ${project.address}</div>
                            </div>
                            <div class="project-badge">${project.transaction_count} ç­†</div>
                        </div>
                        <div class="project-price">${formatPrice(project.avg_price)}</div>
                        <div class="project-stats">
                            <div class="stat-item">
                                <span class="stat-label">å–®åƒ¹:</span>
                                ${unitPrice} ${getUnitPriceText()}
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">é¢ç©:</span>
                                ${avgArea} ${getUnitText()}
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">æœ€ä½:</span>
                                ${formatPriceShort(project.min_price)}
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">æœ€é«˜:</span>
                                ${formatPriceShort(project.max_price)}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = html;
        }

        // åœ¨åœ°åœ–ä¸Šæ·»åŠ æ¨™è¨˜
        async function addMarkersToMap(projectList) {
            clearMarkers();
            const geocoder = new google.maps.Geocoder();
            const bounds = new google.maps.LatLngBounds();
            
            for (let i = 0; i < Math.min(projectList.length, 100); i++) {
                const project = projectList[i];
                
                try {
                    const results = await geocodeAddress(geocoder, project.address);
                    if (results) {
                        const position = results.geometry.location;
                        const marker = createProjectMarker(position, project);
                        markers.push(marker);
                        bounds.extend(position);
                    }
                } catch (error) {
                    console.error('åœ°ç†ç·¨ç¢¼å¤±æ•—:', error);
                }
                
                if (i % 10 === 9) {
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
            }
            
            if (markers.length > 0) {
                map.fitBounds(bounds);
            }
        }

        // å‰µå»ºå»ºæ¡ˆæ¨™è¨˜
        function createProjectMarker(position, project) {
            const priceColor = getPriceColor(project.avg_price);
            const priceShort = formatPriceShort(project.avg_price);
            
            const marker = new google.maps.Marker({
                position: position,
                map: map,
                title: project.name,
                label: {
                    text: priceShort,
                    color: 'white',
                    fontSize: '11px',
                    fontWeight: 'bold'
                },
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 18,
                    fillColor: priceColor,
                    fillOpacity: 0.9,
                    strokeColor: 'white',
                    strokeWeight: 3
                }
            });
            
            marker.addListener('click', () => {
                selectProject(project.id, project.address);
            });
            
            return marker;
        }

        // é¸æ“‡å»ºæ¡ˆ
        function selectProject(projectId, address) {
            selectedProjectId = projectId;
            displayProjects(projects);
            showProjectDetail(projectId, address);
        }

        // é¡¯ç¤ºå»ºæ¡ˆè©³æƒ…ï¼ˆéŠ·æ§é¢æ¿ï¼‰
        async function showProjectDetail(projectId, address) {
            document.getElementById('modalTitle').textContent = 'è¼‰å…¥ä¸­...';
            document.getElementById('salesModal').classList.add('active');
            
            try {
                const response = await fetch(`${API_BASE}/api/project/${projectId}?address=${encodeURIComponent(address)}`);
                const result = await response.json();
                
                if (result.success) {
                    const project = result.project;
                    renderProjectDetail(project);
                } else {
                    document.getElementById('modalBody').innerHTML = `<p style="text-align:center;padding:40px;">è¼‰å…¥å¤±æ•—ï¼š${result.error}</p>`;
                }
            } catch (error) {
                console.error('è¼‰å…¥å»ºæ¡ˆè©³æƒ…å¤±æ•—:', error);
                document.getElementById('modalBody').innerHTML = '<p style="text-align:center;padding:40px;">è¼‰å…¥å¤±æ•—</p>';
            }
        }

        // æ¸²æŸ“å»ºæ¡ˆè©³æƒ…
        function renderProjectDetail(project) {
            const transactions = project.transactions;
            const salesControl = project.sales_control;
            
            document.getElementById('modalTitle').textContent = transactions[0]['åœŸåœ°ä½ç½®å»ºç‰©é–€ç‰Œ'];
            
            const avgPrice = transactions.reduce((sum, t) => sum + (parseFloat(t['ç¸½åƒ¹å…ƒ']) || 0), 0) / transactions.length;
            const avgUnitPrice = transactions.reduce((sum, t) => sum + (parseFloat(t['å–®åƒ¹å…ƒå¹³æ–¹å…¬å°º']) || 0), 0) / transactions.length;
            const avgArea = transactions.reduce((sum, t) => sum + (parseFloat(t['å»ºç‰©ç§»è½‰ç¸½é¢ç©å¹³æ–¹å…¬å°º']) || 0), 0) / transactions.length;
            
            let html = `
                <div class="project-detail-header">
                    <div class="detail-stat-card">
                        <div class="detail-stat-label">ç¸½äº¤æ˜“æ•¸</div>
                        <div class="detail-stat-value">${salesControl.total_units}</div>
                    </div>
                    <div class="detail-stat-card">
                        <div class="detail-stat-label">å¹³å‡ç¸½åƒ¹</div>
                        <div class="detail-stat-value">${formatPriceShort(avgPrice)}</div>
                    </div>
                    <div class="detail-stat-card">
                        <div class="detail-stat-label">å¹³å‡å–®åƒ¹</div>
                        <div class="detail-stat-value">${convertUnitPrice(avgUnitPrice)}<br><span style="font-size:14px;">${getUnitPriceText()}</span></div>
                    </div>
                    <div class="detail-stat-card">
                        <div class="detail-stat-label">å¹³å‡é¢ç©</div>
                        <div class="detail-stat-value">${convertArea(avgArea)}<br><span style="font-size:14px;">${getUnitText()}</span></div>
                    </div>
                </div>
                
                <div class="sales-control-section">
                    <div class="section-title">ğŸ“‹ äº¤æ˜“è¨˜éŒ„éŠ·æ§è¡¨</div>
                    <div class="sales-grid">
            `;
            
            transactions.forEach((trans, index) => {
                const price = parseFloat(trans['ç¸½åƒ¹å…ƒ']) || 0;
                html += `
                    <div class="unit-cell sold" title="${trans['äº¤æ˜“å¹´æœˆæ—¥']}">
                        <div class="unit-number">${trans['ç§»è½‰å±¤æ¬¡']}æ¨“</div>
                        <div class="unit-price">${formatPriceShort(price)}</div>
                    </div>
                `;
            });
            
            html += `
                    </div>
                </div>
                
                <div style="margin-top: 30px;">
                    <div class="section-title">ğŸ“Š è©³ç´°äº¤æ˜“è¨˜éŒ„</div>
                    <table class="transactions-table">
                        <thead>
                            <tr>
                                <th>äº¤æ˜“æ—¥æœŸ</th>
                                <th>æ¨“å±¤</th>
                                <th>æ ¼å±€</th>
                                <th>é¢ç©</th>
                                <th>ç¸½åƒ¹</th>
                                <th>å–®åƒ¹</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            transactions.forEach(trans => {
                const area = parseFloat(trans['å»ºç‰©ç§»è½‰ç¸½é¢ç©å¹³æ–¹å…¬å°º']) || 0;
                const unitPrice = parseFloat(trans['å–®åƒ¹å…ƒå¹³æ–¹å…¬å°º']) || 0;
                
                html += `
                    <tr>
                        <td>${trans['äº¤æ˜“å¹´æœˆæ—¥'] || '-'}</td>
                        <td>${trans['ç§»è½‰å±¤æ¬¡'] || '-'}/${trans['ç¸½æ¨“å±¤æ•¸'] || '-'}</td>
                        <td>${trans['æˆ¿'] || '-'}æˆ¿${trans['å»³'] || '-'}å»³${trans['è¡›'] || '-'}è¡›</td>
                        <td>${convertArea(area)} ${getUnitText()}</td>
                        <td style="color: #e74c3c; font-weight: 600;">${formatPrice(trans['ç¸½åƒ¹å…ƒ'])}</td>
                        <td>${convertUnitPrice(unitPrice)} ${getUnitPriceText()}</td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            document.getElementById('modalBody').innerHTML = html;
        }

        // é—œé–‰æ¨¡æ…‹æ¡†
        function closeModal() {
            document.getElementById('salesModal').classList.remove('active');
        }

        // æœå°‹
        async function performSearch() {
            const keyword = document.getElementById('mainSearch').value.trim();
            if (!keyword) {
                loadAllProjects();
                return;
            }
            
            showLoading();
            try {
                const response = await fetch(`${API_BASE}/api/search?keyword=${encodeURIComponent(keyword)}`);
                const result = await response.json();
                
                if (result.success) {
                    projects = result.projects;
                    displayProjects(projects);
                    addMarkersToMap(projects);
                } else {
                    console.error('æœå°‹å¤±æ•—:', result.error);
                    alert('æœå°‹å¤±æ•—ï¼š' + result.error);
                }
            } catch (error) {
                console.error('æœå°‹å¤±æ•—:', error);
                alert('æœå°‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
            } finally {
                hideLoading();
            }
        }

        // å¥—ç”¨ç¯©é¸
        async function applyFilters() {
            const minPrice = document.getElementById('minPrice').value;
            const maxPrice = document.getElementById('maxPrice').value;
            let minUnitPrice = document.getElementById('minUnitPrice').value;
            let maxUnitPrice = document.getElementById('maxUnitPrice').value;
            
            // å¦‚æœæ˜¯åªæ•¸ï¼Œè½‰æ›å›å¹³æ–¹å…¬å°ºå–®åƒ¹
            if (currentUnit === 'ping') {
                if (minUnitPrice) minUnitPrice = parseFloat(minUnitPrice) * 10000 / PING_TO_SQM;
                if (maxUnitPrice) maxUnitPrice = parseFloat(maxUnitPrice) * 10000 / PING_TO_SQM;
            }
            
            showLoading();
            try {
                let url = `${API_BASE}/api/search?`;
                if (minPrice) url += `min_price=${parseFloat(minPrice) * 10000}&`;
                if (maxPrice) url += `max_price=${parseFloat(maxPrice) * 10000}&`;
                if (minUnitPrice) url += `min_unit_price=${minUnitPrice}&`;
                if (maxUnitPrice) url += `max_unit_price=${maxUnitPrice}&`;
                
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.success) {
                    projects = result.projects;
                    displayProjects(projects);
                    addMarkersToMap(projects);
                } else {
                    console.error('ç¯©é¸å¤±æ•—:', result.error);
                    alert('ç¯©é¸å¤±æ•—ï¼š' + result.error);
                }
            } catch (error) {
                console.error('ç¯©é¸å¤±æ•—:', error);
                alert('ç¯©é¸å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
            } finally {
                hideLoading();
            }
        }

        // å·¥å…·å‡½æ•¸
        function geocodeAddress(geocoder, address) {
            return new Promise((resolve) => {
                geocoder.geocode({ address: address + ', å°ç£' }, (results, status) => {
                    resolve(status === 'OK' && results[0] ? results[0] : null);
                });
            });
        }

        function clearMarkers() {
            markers.forEach(marker => marker.setMap(null));
            markers = [];
        }

        function getPriceColor(price) {
            if (price < 10000000) return '#4caf50';
            if (price < 20000000) return '#2196f3';
            if (price < 50000000) return '#ff9800';
            return '#f44336';
        }

        function formatPrice(price) {
            const num = parseFloat(price) || 0;
            if (num >= 100000000) return (num / 100000000).toFixed(2) + ' å„„å…ƒ';
            if (num >= 10000) return (num / 10000).toFixed(0) + ' è¬å…ƒ';
            return num.toFixed(0) + ' å…ƒ';
        }

        function formatPriceShort(price) {
            const num = parseFloat(price) || 0;
            if (num >= 100000000) return (num / 100000000).toFixed(1) + 'å„„';
            if (num >= 10000) return (num / 10000).toFixed(0) + 'è¬';
            return num.toFixed(0);
        }

        function resetMapView() {
            map.setCenter({ lat: 25.0330, lng: 121.5654 });
            map.setZoom(12);
        }

        function showLoading() {
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        // é»æ“Šæ¨¡æ…‹æ¡†å¤–éƒ¨é—œé–‰
        document.getElementById('salesModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });
    </script>

    <!-- Google Maps API -->
    <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY&callback=initMap&language=zh-TW" async defer></script>
</body>
</html>
