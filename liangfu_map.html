<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‰¯å¯Œå±…åœ°ç”¢ - å°ˆæ¥­æˆ¿åœ°ç”¢åœ°åœ–ç³»çµ±</title>
    <!-- Leaflet.js CDNï¼ˆå®Œå…¨å…è²»ï¼‰ -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Leaflet MarkerCluster -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Microsoft JhengHei', 'Segoe UI', Arial, sans-serif; overflow: hidden; }

        .top-nav {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white; padding: 15px 30px; display: flex; align-items: center;
            justify-content: space-between; box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            z-index: 2000; position: relative;
        }
        .logo { font-size: 28px; font-weight: bold; display: flex; align-items: center; gap: 10px; }
        .search-bar { flex: 1; max-width: 500px; margin: 0 30px; position: relative; }
        .search-input {
            width: 100%; padding: 12px 45px 12px 20px; border: none; border-radius: 25px;
            font-size: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        .search-btn {
            position: absolute; right: 5px; top: 50%; transform: translateY(-50%);
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            border: none; padding: 8px 20px; border-radius: 20px; color: white;
            cursor: pointer; font-weight: 600;
        }
        .nav-actions { display: flex; gap: 15px; align-items: center; }
        .unit-toggle {
            background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3);
            padding: 6px 4px; border-radius: 20px; display: flex; gap: 4px;
        }
        .unit-btn {
            background: transparent; border: none; padding: 6px 16px; border-radius: 16px;
            color: white; cursor: pointer; transition: all 0.3s; font-size: 13px;
        }
        .unit-btn.active { background: white; color: #1e3c72; font-weight: 600; }
        .nav-btn {
            background: rgba(255,255,255,0.2); border: none; padding: 8px 20px;
            border-radius: 20px; color: white; cursor: pointer; transition: all 0.3s;
        }
        .nav-btn:hover { background: rgba(255,255,255,0.3); }

        .main-container { display: flex; height: calc(100vh - 70px); }

        .left-panel {
            width: 400px; background: white; overflow-y: auto;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1); z-index: 1000;
        }
        .filter-section { padding: 20px; border-bottom: 1px solid #eee; }
        .filter-title { font-weight: 600; margin-bottom: 15px; font-size: 16px; color: #333; }
        .filter-group { margin-bottom: 15px; }
        .filter-label { font-size: 13px; color: #666; margin-bottom: 8px; display: block; }
        .filter-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .filter-input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; }
        .apply-filter-btn {
            width: 100%; padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; margin-top: 10px;
        }
        .apply-filter-btn:hover { opacity: 0.9; }
        .projects-list { padding: 15px; }
        .project-card {
            background: white; border: 1px solid #e0e0e0; border-radius: 12px;
            padding: 15px; margin-bottom: 12px; cursor: pointer; transition: all 0.3s;
        }
        .project-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.15); transform: translateY(-2px); }
        .project-card.active {
            border-color: #667eea;
            background: linear-gradient(135deg, rgba(102,126,234,0.05) 0%, rgba(118,75,162,0.05) 100%);
        }
        .project-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .project-name { font-weight: 600; font-size: 16px; color: #333; margin-bottom: 5px; }
        .project-badge {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;
        }
        .project-address { font-size: 13px; color: #666; margin-bottom: 10px; }
        .project-price { font-size: 22px; color: #e74c3c; font-weight: bold; margin: 10px 0; }
        .project-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px; }
        .stat-item { font-size: 13px; color: #666; }
        .stat-label { color: #999; margin-right: 5px; }

        .map-container { flex: 1; position: relative; }
        #map { width: 100%; height: 100%; }

        .map-controls {
            position: absolute; top: 20px; right: 20px; z-index: 1000;
            display: flex; flex-direction: column; gap: 10px;
        }
        .map-control-btn {
            background: white; border: none; padding: 12px; border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2); cursor: pointer; font-size: 18px;
        }
        .map-control-btn:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.3); }

        /* æ¨¡æ…‹æ¡† */
        .modal {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7); z-index: 3000; justify-content: center; align-items: center;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: white; border-radius: 20px; width: 90%; max-width: 1200px;
            max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; padding: 25px 30px; border-radius: 20px 20px 0 0;
            display: flex; justify-content: space-between; align-items: center;
        }
        .modal-title { font-size: 24px; font-weight: bold; }
        .close-btn {
            background: rgba(255,255,255,0.2); border: none; color: white; font-size: 28px;
            width: 40px; height: 40px; border-radius: 50%; cursor: pointer;
        }
        .close-btn:hover { background: rgba(255,255,255,0.3); transform: rotate(90deg); }
        .modal-body { padding: 30px; }
        .project-detail-header { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
        .detail-stat-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 20px; border-radius: 12px; text-align: center;
        }
        .detail-stat-label { font-size: 14px; color: #666; margin-bottom: 8px; }
        .detail-stat-value { font-size: 28px; font-weight: bold; color: #333; }
        .section-title { font-size: 20px; font-weight: 600; margin-bottom: 20px; color: #333; }
        .sales-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px; margin-top: 20px;
        }
        .unit-cell {
            aspect-ratio: 1; border: 2px solid #ddd; border-radius: 8px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            cursor: pointer; transition: all 0.3s; padding: 10px;
        }
        .unit-cell.sold { background: #ffebee; border-color: #e74c3c; }
        .unit-cell:hover { transform: scale(1.05); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .unit-number { font-weight: 600; font-size: 14px; margin-bottom: 5px; }
        .unit-price { font-size: 11px; color: #666; }
        .transactions-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .transactions-table th { background: #f5f5f5; padding: 12px; text-align: left; font-weight: 600; border-bottom: 2px solid #ddd; }
        .transactions-table td { padding: 12px; border-bottom: 1px solid #eee; }
        .transactions-table tr:hover { background: #f9f9f9; }

        .loading-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.9); display: flex; justify-content: center;
            align-items: center; z-index: 2000;
        }
        .loading-spinner {
            width: 50px; height: 50px; border: 5px solid #f3f3f3;
            border-top: 5px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .hidden { display: none !important; }

        .price-legend {
            position: absolute; bottom: 20px; left: 20px; background: white;
            padding: 15px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 1000;
        }
        .legend-item { display: flex; align-items: center; margin: 5px 0; font-size: 13px; }
        .legend-color { width: 20px; height: 20px; border-radius: 50%; margin-right: 8px; }

        /* è‡ªè¨‚ Leaflet åœ“å½¢æ¨™è¨˜ */
        .price-marker {
            background: transparent; border: none;
        }
        .price-marker-inner {
            width: 36px; height: 36px; border-radius: 50%; border: 3px solid white;
            display: flex; justify-content: center; align-items: center;
            color: white; font-size: 10px; font-weight: bold; box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            white-space: nowrap;
        }
    </style>
</head>
<body>
    <div class="top-nav">
        <div class="logo">ğŸ  è‰¯å¯Œå±…åœ°ç”¢</div>
        <div class="search-bar">
            <input type="text" id="mainSearch" class="search-input"
                   placeholder="æœå°‹åœ°å€ã€å»ºæ¡ˆåç¨±ã€åœ°å€..."
                   onkeypress="if(event.key==='Enter') performSearch()">
            <button class="search-btn" onclick="performSearch()">æœå°‹</button>
        </div>
        <div class="nav-actions">
            <div class="unit-toggle">
                <button class="unit-btn" id="unitBtnSqm" onclick="setUnit('sqm')">ã¡</button>
                <button class="unit-btn active" id="unitBtnPing" onclick="setUnit('ping')">åª</button>
            </div>
            <button class="nav-btn" onclick="loadAllProjects()">ğŸ”„ é‡æ–°è¼‰å…¥</button>
        </div>
    </div>

    <div class="main-container">
        <div class="left-panel">
            <div class="filter-section">
                <div class="filter-title">ğŸ¯ é€²éšç¯©é¸</div>
                <div class="filter-group">
                    <div class="filter-label">ğŸ”„ æ’åºæ–¹å¼</div>
                    <select id="sortBy" class="filter-input" style="width:100%;margin-bottom:8px;">
                        <option value="transaction_count">äº¤æ˜“ç­†æ•¸ï¼ˆé è¨­ï¼‰</option>
                        <option value="date">æˆäº¤æ—¥æœŸ</option>
                        <option value="price">æˆäº¤é‡‘é¡</option>
                        <option value="unit_price">å–®åƒ¹</option>
                        <option value="area">åªæ•¸</option>
                        <option value="ratio">å…¬è¨­æ¯”</option>
                    </select>
                    <select id="sortOrder" class="filter-input" style="width:100%;">
                        <option value="desc">ç”±é«˜åˆ°ä½</option>
                        <option value="asc">ç”±ä½åˆ°é«˜</option>
                    </select>
                </div>
                <div class="filter-group">
                    <div class="filter-label">ç¸½åƒ¹ç¯„åœï¼ˆè¬å…ƒï¼‰</div>
                    <div class="filter-row">
                        <input type="number" id="minPrice" class="filter-input" placeholder="æœ€ä½">
                        <input type="number" id="maxPrice" class="filter-input" placeholder="æœ€é«˜">
                    </div>
                </div>
                <div class="filter-group">
                    <div class="filter-label" id="unitPriceLabel">å–®åƒ¹ç¯„åœï¼ˆå…ƒ/åªï¼‰</div>
                    <div class="filter-row">
                        <input type="number" id="minUnitPrice" class="filter-input" placeholder="æœ€ä½">
                        <input type="number" id="maxUnitPrice" class="filter-input" placeholder="æœ€é«˜">
                    </div>
                </div>
                <div class="filter-group">
                    <div class="filter-label">åªæ•¸ç¯„åœï¼ˆåªï¼‰</div>
                    <div class="filter-row">
                        <input type="number" id="minPing" class="filter-input" placeholder="æœ€ä½">
                        <input type="number" id="maxPing" class="filter-input" placeholder="æœ€é«˜">
                    </div>
                </div>
                <div class="filter-group">
                    <div class="filter-label">æˆäº¤å¹´ä»½ï¼ˆè¥¿å…ƒï¼‰</div>
                    <div class="filter-row">
                        <input type="number" id="minYear" class="filter-input" placeholder="æœ€æ—©" value="2020">
                        <input type="number" id="maxYear" class="filter-input" placeholder="æœ€æ™š" value="2026">
                    </div>
                </div>
                <div class="filter-group">
                    <div class="filter-label">å…¬è¨­æ¯”ç¯„åœï¼ˆ%ï¼‰</div>
                    <div class="filter-row">
                        <input type="number" id="minRatio" class="filter-input" placeholder="æœ€ä½">
                        <input type="number" id="maxRatio" class="filter-input" placeholder="æœ€é«˜">
                    </div>
                </div>
                <div class="filter-group">
                    <div class="filter-label">å»ºç‰©å‹æ…‹</div>
                    <select id="buildingType" class="filter-input" style="width:100%;">
                        <option value="">å…¨éƒ¨</option>
                        <option value="ä½å®…å¤§æ¨“">ä½å®…å¤§æ¨“</option>
                        <option value="è¯å»ˆ">è¯å»ˆ</option>
                        <option value="å…¬å¯“">å…¬å¯“</option>
                        <option value="é€å¤©å">é€å¤©å</option>
                        <option value="å¥—æˆ¿">å¥—æˆ¿</option>
                    </select>
                </div>
                <div class="filter-group">
                    <div class="filter-label">æˆ¿æ•¸</div>
                    <select id="roomCount" class="filter-input" style="width:100%;">
                        <option value="">å…¨éƒ¨</option>
                        <option value="1">1æˆ¿</option>
                        <option value="2">2æˆ¿</option>
                        <option value="3">3æˆ¿</option>
                        <option value="4">4æˆ¿</option>
                        <option value="5">5æˆ¿ä»¥ä¸Š</option>
                    </select>
                </div>
                <button class="apply-filter-btn" onclick="applyFilters()">å¥—ç”¨ç¯©é¸</button>
                <button class="apply-filter-btn" onclick="resetFilters()" style="background:#95a5a6;margin-top:8px;">æ¸…é™¤ç¯©é¸</button>
            </div>
            <div class="projects-list" id="projectsList">
                <div style="text-align:center;padding:40px 20px;color:#999;">
                    <div style="font-size:48px;margin-bottom:15px;">ğŸ¢</div>
                    <p>è¼‰å…¥å»ºæ¡ˆä¸­...</p>
                </div>
            </div>
        </div>

        <div class="map-container">
            <div id="loadingOverlay" class="loading-overlay">
                <div class="loading-spinner"></div>
            </div>
            <div id="map"></div>
            <div class="map-controls">
                <button class="map-control-btn" onclick="map.zoomIn()" title="æ”¾å¤§">+</button>
                <button class="map-control-btn" onclick="map.zoomOut()" title="ç¸®å°">-</button>
                <button class="map-control-btn" onclick="resetMapView()" title="é‡ç½®">ğŸ¯</button>
            </div>
            <div class="price-legend">
                <div style="font-weight:600;margin-bottom:10px;">ğŸ’° åƒ¹æ ¼ç¯„åœ</div>
                <div class="legend-item"><div class="legend-color" style="background:#4caf50;"></div><span>&lt; 1000è¬</span></div>
                <div class="legend-item"><div class="legend-color" style="background:#2196f3;"></div><span>1000è¬ - 2000è¬</span></div>
                <div class="legend-item"><div class="legend-color" style="background:#ff9800;"></div><span>2000è¬ - 5000è¬</span></div>
                <div class="legend-item"><div class="legend-color" style="background:#f44336;"></div><span>&gt; 5000è¬</span></div>
            </div>
        </div>
    </div>

    <!-- éŠ·æ§é¢æ¿æ¨¡æ…‹æ¡† -->
    <div id="salesModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">å»ºæ¡ˆéŠ·æ§é¢æ¿</div>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
        </div>
    </div>

    <script>
        const API_BASE = `${window.location.protocol}//${window.location.host}`;
        const SQM_TO_PING = 0.3025;
        const PING_TO_SQM = 3.3058;

        let map, markerClusterGroup;
        let markers = [];
        let projects = [];
        let selectedProjectId = null;
        let currentUnit = 'ping';

        // ===================== åˆå§‹åŒ– Leaflet åœ°åœ– =====================
        function initMap() {
            map = L.map('map', {
                center: [25.0330, 121.5654],
                zoom: 12,
                zoomControl: false  // æˆ‘å€‘ç”¨è‡ªå·±çš„æŒ‰éˆ•
            });

            // OpenStreetMap å…è²»åœ–å±¤
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
                maxZoom: 19
            }).addTo(map);

            // MarkerCluster è®“å¤§é‡æ¨™è¨˜è‡ªå‹•èšåˆ
            markerClusterGroup = L.markerClusterGroup({
                maxClusterRadius: 50,
                spiderfyOnMaxZoom: true,
                showCoverageOnHover: false,
                iconCreateFunction: function(cluster) {
                    const count = cluster.getChildCount();
                    let size = 'small';
                    if (count > 50) size = 'large';
                    else if (count > 10) size = 'medium';
                    return L.divIcon({
                        html: '<div style="background:linear-gradient(135deg,#667eea,#764ba2);color:white;border-radius:50%;width:40px;height:40px;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:14px;border:3px solid white;box-shadow:0 2px 6px rgba(0,0,0,0.3);">' + count + '</div>',
                        className: 'price-marker',
                        iconSize: [40, 40]
                    });
                }
            });
            map.addLayer(markerClusterGroup);

            loadAllProjects();
            hideLoading();
        }

        // ===================== å–®ä½åˆ‡æ› =====================
        function setUnit(unit) {
            currentUnit = unit;
            document.getElementById('unitBtnSqm').classList.toggle('active', unit === 'sqm');
            document.getElementById('unitBtnPing').classList.toggle('active', unit === 'ping');
            document.getElementById('unitPriceLabel').textContent = unit === 'sqm' ? 'å–®åƒ¹ç¯„åœï¼ˆå…ƒ/ã¡ï¼‰' : 'å–®åƒ¹ç¯„åœï¼ˆå…ƒ/åªï¼‰';
            if (projects.length > 0) displayProjects(projects);
        }

        function convertArea(sqm) {
            return currentUnit === 'ping' ? (sqm * SQM_TO_PING).toFixed(2) : sqm.toFixed(2);
        }
        function convertUnitPrice(pricePerPing) {
            // å¾Œç«¯å·²ç¶“å‚³å›å…ƒ/åª
            if (currentUnit === 'sqm') return (pricePerPing / PING_TO_SQM).toFixed(2);
            return pricePerPing.toFixed(2);
        }
        function getUnitText() { return currentUnit === 'ping' ? 'åª' : 'ã¡'; }
        function getUnitPriceText() { return currentUnit === 'ping' ? 'å…ƒ/åª' : 'å…ƒ/ã¡'; }

        // ===================== è¼‰å…¥è³‡æ–™ =====================
        async function loadAllProjects() {
            showLoading();
            try {
                const response = await fetch(`${API_BASE}/api/projects`);
                const result = await response.json();
                if (result.success) {
                    projects = result.projects;
                    displayProjects(projects);
                    addMarkersToMap(projects);
                } else {
                    alert('è¼‰å…¥å»ºæ¡ˆå¤±æ•—ï¼š' + result.error);
                }
            } catch (error) {
                console.error('è¼‰å…¥å»ºæ¡ˆå¤±æ•—:', error);
                alert('è¼‰å…¥å»ºæ¡ˆå¤±æ•—ï¼š' + error.message);
            } finally {
                hideLoading();
            }
        }

        // ===================== é¡¯ç¤ºå»ºæ¡ˆåˆ—è¡¨ =====================
        function displayProjects(projectList) {
            const container = document.getElementById('projectsList');
            if (projectList.length === 0) {
                container.innerHTML = '<div style="text-align:center;padding:40px 20px;color:#999;"><div style="font-size:48px;margin-bottom:15px;">ğŸ˜”</div><p>æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„å»ºæ¡ˆ</p></div>';
                return;
            }
            container.innerHTML = projectList.map(project => {
                const unitPrice = project.avg_unit_price ? convertUnitPrice(project.avg_unit_price) : '0';
                const avgPing = project.avg_ping ? project.avg_ping.toFixed(2) : '0.00';
                const ratio = project.avg_ratio ? project.avg_ratio.toFixed(1) : '-';
                const latestDate = project.latest_date || '-';
                return `
                    <div class="project-card ${selectedProjectId === project.id ? 'active' : ''}"
                         onclick="selectProject('${project.id}', '${project.address.replace(/'/g, "\\'")}')">
                        <div class="project-header">
                            <div>
                                <div class="project-name">${project.name}</div>
                                <div class="project-address">ğŸ“ ${project.address}</div>
                            </div>
                            <div class="project-badge">${project.transaction_count} ç­†</div>
                        </div>
                        <div class="project-price">${formatPrice(project.avg_price)}</div>
                        <div class="project-stats">
                            <div class="stat-item"><span class="stat-label">å–®åƒ¹:</span>${unitPrice} ${getUnitPriceText()}</div>
                            <div class="stat-item"><span class="stat-label">åªæ•¸:</span>${avgPing} åª</div>
                            <div class="stat-item"><span class="stat-label">å…¬è¨­æ¯”:</span>${ratio}%</div>
                            <div class="stat-item"><span class="stat-label">æœ€æ–°:</span>${latestDate}</div>
                        </div>
                    </div>`;
            }).join('');
        }

        // ===================== åœ°åœ–æ¨™è¨˜ =====================
        function addMarkersToMap(projectList) {
            markerClusterGroup.clearLayers();
            markers = [];
            const bounds = L.latLngBounds();

            projectList.forEach(project => {
                if (!project.lat || !project.lng) return;

                const color = getPriceColor(project.avg_price);
                const priceShort = formatPriceShort(project.avg_price);

                const icon = L.divIcon({
                    html: `<div class="price-marker-inner" style="background:${color};">${priceShort}</div>`,
                    className: 'price-marker',
                    iconSize: [40, 40],
                    iconAnchor: [20, 20]
                });

                const marker = L.marker([project.lat, project.lng], { icon: icon });
                marker.bindPopup(`
                    <div style="min-width:200px;">
                        <b>${project.name}</b><br>
                        ğŸ“ ${project.address}<br>
                        ğŸ’° ${formatPrice(project.avg_price)}<br>
                        ğŸ“ ${project.avg_ping ? project.avg_ping.toFixed(2) : '-'} åª<br>
                        ğŸ“Š ${project.transaction_count} ç­†äº¤æ˜“
                    </div>
                `);
                marker.on('click', () => selectProject(project.id, project.address));

                markerClusterGroup.addLayer(marker);
                markers.push(marker);
                bounds.extend([project.lat, project.lng]);
            });

            if (markers.length > 0) {
                map.fitBounds(bounds, { padding: [50, 50] });
            }
        }

        // ===================== å»ºæ¡ˆæ“ä½œ =====================
        function selectProject(projectId, address) {
            selectedProjectId = projectId;
            displayProjects(projects);
            showProjectDetail(projectId, address);
        }

        async function showProjectDetail(projectId, address) {
            document.getElementById('modalTitle').textContent = 'è¼‰å…¥ä¸­...';
            document.getElementById('salesModal').classList.add('active');
            try {
                const response = await fetch(`${API_BASE}/api/project/${projectId}?address=${encodeURIComponent(address)}`);
                const result = await response.json();
                if (result.success) {
                    renderProjectDetail(result.project);
                } else {
                    document.getElementById('modalBody').innerHTML = `<p style="text-align:center;padding:40px;">è¼‰å…¥å¤±æ•—ï¼š${result.error}</p>`;
                }
            } catch (error) {
                document.getElementById('modalBody').innerHTML = '<p style="text-align:center;padding:40px;">è¼‰å…¥å¤±æ•—</p>';
            }
        }

        function renderProjectDetail(project) {
            const transactions = project.transactions;
            const salesControl = project.sales_control;
            document.getElementById('modalTitle').textContent = transactions[0]['åœŸåœ°ä½ç½®å»ºç‰©é–€ç‰Œ'];

            const avgPrice = transactions.reduce((s, t) => s + (parseFloat(t['ç¸½åƒ¹å…ƒ']) || 0), 0) / transactions.length;
            const avgUnitPrice = transactions.reduce((s, t) => s + (parseFloat(t['å–®åƒ¹å…ƒå¹³æ–¹å…¬å°º']) || 0), 0) / transactions.length;
            const avgArea = transactions.reduce((s, t) => s + (parseFloat(t['å»ºç‰©ç§»è½‰ç¸½é¢ç©å¹³æ–¹å…¬å°º']) || 0), 0) / transactions.length;
            const avgPing = avgArea / PING_TO_SQM;
            const avgUPPing = avgUnitPrice * PING_TO_SQM;

            let html = `
                <div class="project-detail-header">
                    <div class="detail-stat-card"><div class="detail-stat-label">ç¸½äº¤æ˜“æ•¸</div><div class="detail-stat-value">${salesControl.total_units}</div></div>
                    <div class="detail-stat-card"><div class="detail-stat-label">å¹³å‡ç¸½åƒ¹</div><div class="detail-stat-value">${formatPriceShort(avgPrice)}</div></div>
                    <div class="detail-stat-card"><div class="detail-stat-label">å¹³å‡å–®åƒ¹</div><div class="detail-stat-value">${convertUnitPrice(avgUPPing)}<br><span style="font-size:14px;">${getUnitPriceText()}</span></div></div>
                    <div class="detail-stat-card"><div class="detail-stat-label">å¹³å‡é¢ç©</div><div class="detail-stat-value">${avgPing.toFixed(2)}<br><span style="font-size:14px;">åª</span></div></div>
                </div>
                <div><div class="section-title">ğŸ“‹ äº¤æ˜“è¨˜éŒ„éŠ·æ§è¡¨</div><div class="sales-grid">`;

            transactions.forEach(trans => {
                const price = parseFloat(trans['ç¸½åƒ¹å…ƒ']) || 0;
                html += `<div class="unit-cell sold" title="${trans['äº¤æ˜“å¹´æœˆæ—¥']}"><div class="unit-number">${trans['ç§»è½‰å±¤æ¬¡']}æ¨“</div><div class="unit-price">${formatPriceShort(price)}</div></div>`;
            });

            html += `</div></div><div style="margin-top:30px;"><div class="section-title">ğŸ“Š è©³ç´°äº¤æ˜“è¨˜éŒ„</div>
                <table class="transactions-table"><thead><tr><th>äº¤æ˜“æ—¥æœŸ</th><th>æ¨“å±¤</th><th>æ ¼å±€</th><th>é¢ç©</th><th>ç¸½åƒ¹</th><th>å–®åƒ¹</th></tr></thead><tbody>`;

            transactions.forEach(trans => {
                const area = parseFloat(trans['å»ºç‰©ç§»è½‰ç¸½é¢ç©å¹³æ–¹å…¬å°º']) || 0;
                const unitPrice = parseFloat(trans['å–®åƒ¹å…ƒå¹³æ–¹å…¬å°º']) || 0;
                const ping = area / PING_TO_SQM;
                const upPing = unitPrice * PING_TO_SQM;
                html += `<tr>
                    <td>${trans['äº¤æ˜“å¹´æœˆæ—¥'] || '-'}</td>
                    <td>${trans['ç§»è½‰å±¤æ¬¡'] || '-'}/${trans['ç¸½æ¨“å±¤æ•¸'] || '-'}</td>
                    <td>${trans['å»ºç‰©ç¾æ³æ ¼å±€-æˆ¿'] || '-'}æˆ¿${trans['å»ºç‰©ç¾æ³æ ¼å±€-å»³'] || '-'}å»³${trans['å»ºç‰©ç¾æ³æ ¼å±€-è¡›'] || '-'}è¡›</td>
                    <td>${ping.toFixed(2)} åª</td>
                    <td style="color:#e74c3c;font-weight:600;">${formatPrice(trans['ç¸½åƒ¹å…ƒ'])}</td>
                    <td>${convertUnitPrice(upPing)} ${getUnitPriceText()}</td>
                </tr>`;
            });

            html += '</tbody></table></div>';
            document.getElementById('modalBody').innerHTML = html;
        }

        function closeModal() { document.getElementById('salesModal').classList.remove('active'); }

        // ===================== æœå°‹ & ç¯©é¸ =====================
        async function performSearch() {
            const keyword = document.getElementById('mainSearch').value.trim();
            if (!keyword) { loadAllProjects(); return; }
            showLoading();
            try {
                const response = await fetch(`${API_BASE}/api/search?keyword=${encodeURIComponent(keyword)}`);
                const result = await response.json();
                if (result.success) {
                    projects = result.projects;
                    displayProjects(projects);
                    addMarkersToMap(projects);
                }
            } catch (error) {
                alert('æœå°‹å¤±æ•—ï¼š' + error.message);
            } finally { hideLoading(); }
        }

        async function applyFilters() {
            showLoading();
            try {
                let url = `${API_BASE}/api/search?`;
                const keyword = document.getElementById('mainSearch').value.trim();
                if (keyword) url += `keyword=${encodeURIComponent(keyword)}&`;
                url += `sort_by=${document.getElementById('sortBy').value}&sort_order=${document.getElementById('sortOrder').value}&`;

                const minPrice = document.getElementById('minPrice').value;
                const maxPrice = document.getElementById('maxPrice').value;
                if (minPrice) url += `min_price=${parseFloat(minPrice) * 10000}&`;
                if (maxPrice) url += `max_price=${parseFloat(maxPrice) * 10000}&`;

                const minUP = document.getElementById('minUnitPrice').value;
                const maxUP = document.getElementById('maxUnitPrice').value;
                if (minUP) url += `min_unit_price=${parseFloat(minUP)}&`;
                if (maxUP) url += `max_unit_price=${parseFloat(maxUP)}&`;

                const minPing = document.getElementById('minPing').value;
                const maxPing = document.getElementById('maxPing').value;
                if (minPing) url += `min_ping=${parseFloat(minPing)}&`;
                if (maxPing) url += `max_ping=${parseFloat(maxPing)}&`;

                const minYear = document.getElementById('minYear').value;
                const maxYear = document.getElementById('maxYear').value;
                if (minYear) url += `min_year=${parseInt(minYear) - 1911}&`;
                if (maxYear) url += `max_year=${parseInt(maxYear) - 1911}&`;

                const minR = document.getElementById('minRatio').value;
                const maxR = document.getElementById('maxRatio').value;
                if (minR) url += `min_ratio=${parseFloat(minR)}&`;
                if (maxR) url += `max_ratio=${parseFloat(maxR)}&`;

                const bt = document.getElementById('buildingType').value;
                if (bt) url += `building_type=${encodeURIComponent(bt)}&`;
                const rc = document.getElementById('roomCount').value;
                if (rc) url += `room_count=${rc}&`;

                const response = await fetch(url);
                const result = await response.json();
                if (result.success) {
                    projects = result.projects;
                    displayProjects(projects);
                    addMarkersToMap(projects);
                }
            } catch (error) { alert('ç¯©é¸å¤±æ•—ï¼š' + error.message); }
            finally { hideLoading(); }
        }

        function resetFilters() {
            document.getElementById('mainSearch').value = '';
            document.getElementById('sortBy').value = 'transaction_count';
            document.getElementById('sortOrder').value = 'desc';
            document.getElementById('minPrice').value = '';
            document.getElementById('maxPrice').value = '';
            document.getElementById('minUnitPrice').value = '';
            document.getElementById('maxUnitPrice').value = '';
            document.getElementById('minPing').value = '';
            document.getElementById('maxPing').value = '';
            document.getElementById('minYear').value = '2020';
            document.getElementById('maxYear').value = '2026';
            document.getElementById('minRatio').value = '';
            document.getElementById('maxRatio').value = '';
            document.getElementById('buildingType').value = '';
            document.getElementById('roomCount').value = '';
            loadAllProjects();
        }

        // ===================== å·¥å…·å‡½æ•¸ =====================
        function getPriceColor(price) {
            if (price < 10000000) return '#4caf50';
            if (price < 20000000) return '#2196f3';
            if (price < 50000000) return '#ff9800';
            return '#f44336';
        }
        function formatPrice(price) {
            const num = parseFloat(price) || 0;
            if (num >= 100000000) return (num / 100000000).toFixed(2) + ' å„„å…ƒ';
            if (num >= 10000) return (num / 10000).toFixed(0) + ' è¬å…ƒ';
            return num.toFixed(0) + ' å…ƒ';
        }
        function formatPriceShort(price) {
            const num = parseFloat(price) || 0;
            if (num >= 100000000) return (num / 100000000).toFixed(1) + 'å„„';
            if (num >= 10000) return (num / 10000).toFixed(0) + 'è¬';
            return num.toFixed(0);
        }
        function resetMapView() { map.setView([25.0330, 121.5654], 12); }
        function showLoading() { document.getElementById('loadingOverlay').classList.remove('hidden'); }
        function hideLoading() { document.getElementById('loadingOverlay').classList.add('hidden'); }

        document.getElementById('salesModal').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });

        // ===================== å•Ÿå‹• =====================
        document.addEventListener('DOMContentLoaded', initMap);
    </script>
</body>
</html>
